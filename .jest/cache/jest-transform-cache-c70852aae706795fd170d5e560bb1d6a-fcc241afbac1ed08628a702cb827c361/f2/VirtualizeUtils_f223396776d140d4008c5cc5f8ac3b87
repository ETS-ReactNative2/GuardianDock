306268797be4e20453279d5f007b9aa7
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.computeWindowedRenderLimits = computeWindowedRenderLimits;
exports.elementsThatOverlapOffsets = elementsThatOverlapOffsets;
exports.keyExtractor = keyExtractor;
exports.newRangeCount = newRangeCount;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _invariant = _interopRequireDefault(require("invariant"));

function elementsThatOverlapOffsets(offsets, itemCount, getFrameMetrics) {
  var out = [];
  var outLength = 0;

  for (var ii = 0; ii < itemCount; ii++) {
    var frame = getFrameMetrics(ii);
    var trailingOffset = frame.offset + frame.length;

    for (var kk = 0; kk < offsets.length; kk++) {
      if (out[kk] == null && trailingOffset >= offsets[kk]) {
        out[kk] = ii;
        outLength++;

        if (kk === offsets.length - 1) {
          (0, _invariant.default)(outLength === offsets.length, 'bad offsets input, should be in increasing order: %s', JSON.stringify(offsets));
          return out;
        }
      }
    }
  }

  return out;
}

function newRangeCount(prev, next) {
  return next.last - next.first + 1 - Math.max(0, 1 + Math.min(next.last, prev.last) - Math.max(next.first, prev.first));
}

function computeWindowedRenderLimits(data, getItemCount, maxToRenderPerBatch, windowSize, prev, getFrameMetricsApprox, scrollMetrics) {
  var itemCount = getItemCount(data);

  if (itemCount === 0) {
    return prev;
  }

  var offset = scrollMetrics.offset,
      velocity = scrollMetrics.velocity,
      visibleLength = scrollMetrics.visibleLength;
  var visibleBegin = Math.max(0, offset);
  var visibleEnd = visibleBegin + visibleLength;
  var overscanLength = (windowSize - 1) * visibleLength;
  var leadFactor = 0.5;
  var fillPreference = velocity > 1 ? 'after' : velocity < -1 ? 'before' : 'none';
  var overscanBegin = Math.max(0, visibleBegin - (1 - leadFactor) * overscanLength);
  var overscanEnd = Math.max(0, visibleEnd + leadFactor * overscanLength);
  var lastItemOffset = getFrameMetricsApprox(itemCount - 1).offset;

  if (lastItemOffset < overscanBegin) {
    return {
      first: Math.max(0, itemCount - 1 - maxToRenderPerBatch),
      last: itemCount - 1
    };
  }

  var _elementsThatOverlapO = elementsThatOverlapOffsets([overscanBegin, visibleBegin, visibleEnd, overscanEnd], itemCount, getFrameMetricsApprox),
      _elementsThatOverlapO2 = (0, _slicedToArray2.default)(_elementsThatOverlapO, 4),
      overscanFirst = _elementsThatOverlapO2[0],
      first = _elementsThatOverlapO2[1],
      last = _elementsThatOverlapO2[2],
      overscanLast = _elementsThatOverlapO2[3];

  overscanFirst = overscanFirst == null ? 0 : overscanFirst;
  first = first == null ? Math.max(0, overscanFirst) : first;
  overscanLast = overscanLast == null ? itemCount - 1 : overscanLast;
  last = last == null ? Math.min(overscanLast, first + maxToRenderPerBatch - 1) : last;
  var visible = {
    first: first,
    last: last
  };
  var newCellCount = newRangeCount(prev, visible);

  while (true) {
    if (first <= overscanFirst && last >= overscanLast) {
      break;
    }

    var maxNewCells = newCellCount >= maxToRenderPerBatch;
    var firstWillAddMore = first <= prev.first || first > prev.last;
    var firstShouldIncrement = first > overscanFirst && (!maxNewCells || !firstWillAddMore);
    var lastWillAddMore = last >= prev.last || last < prev.first;
    var lastShouldIncrement = last < overscanLast && (!maxNewCells || !lastWillAddMore);

    if (maxNewCells && !firstShouldIncrement && !lastShouldIncrement) {
      break;
    }

    if (firstShouldIncrement && !(fillPreference === 'after' && lastShouldIncrement && lastWillAddMore)) {
      if (firstWillAddMore) {
        newCellCount++;
      }

      first--;
    }

    if (lastShouldIncrement && !(fillPreference === 'before' && firstShouldIncrement && firstWillAddMore)) {
      if (lastWillAddMore) {
        newCellCount++;
      }

      last++;
    }
  }

  if (!(last >= first && first >= 0 && last < itemCount && first >= overscanFirst && last <= overscanLast && first <= visible.first && last >= visible.last)) {
    throw new Error('Bad window calculation ' + JSON.stringify({
      first: first,
      last: last,
      itemCount: itemCount,
      overscanFirst: overscanFirst,
      overscanLast: overscanLast,
      visible: visible
    }));
  }

  return {
    first: first,
    last: last
  };
}

function keyExtractor(item, index) {
  if (typeof item === 'object' && (item == null ? void 0 : item.key) != null) {
    return item.key;
  }

  if (typeof item === 'object' && (item == null ? void 0 : item.id) != null) {
    return item.id;
  }

  return String(index);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlZpcnR1YWxpemVVdGlscy5qcyJdLCJuYW1lcyI6WyJlbGVtZW50c1RoYXRPdmVybGFwT2Zmc2V0cyIsIm9mZnNldHMiLCJpdGVtQ291bnQiLCJnZXRGcmFtZU1ldHJpY3MiLCJvdXQiLCJvdXRMZW5ndGgiLCJpaSIsImZyYW1lIiwidHJhaWxpbmdPZmZzZXQiLCJvZmZzZXQiLCJsZW5ndGgiLCJrayIsIkpTT04iLCJzdHJpbmdpZnkiLCJuZXdSYW5nZUNvdW50IiwicHJldiIsIm5leHQiLCJsYXN0IiwiZmlyc3QiLCJNYXRoIiwibWF4IiwibWluIiwiY29tcHV0ZVdpbmRvd2VkUmVuZGVyTGltaXRzIiwiZGF0YSIsImdldEl0ZW1Db3VudCIsIm1heFRvUmVuZGVyUGVyQmF0Y2giLCJ3aW5kb3dTaXplIiwiZ2V0RnJhbWVNZXRyaWNzQXBwcm94Iiwic2Nyb2xsTWV0cmljcyIsInZlbG9jaXR5IiwidmlzaWJsZUxlbmd0aCIsInZpc2libGVCZWdpbiIsInZpc2libGVFbmQiLCJvdmVyc2Nhbkxlbmd0aCIsImxlYWRGYWN0b3IiLCJmaWxsUHJlZmVyZW5jZSIsIm92ZXJzY2FuQmVnaW4iLCJvdmVyc2NhbkVuZCIsImxhc3RJdGVtT2Zmc2V0Iiwib3ZlcnNjYW5GaXJzdCIsIm92ZXJzY2FuTGFzdCIsInZpc2libGUiLCJuZXdDZWxsQ291bnQiLCJtYXhOZXdDZWxscyIsImZpcnN0V2lsbEFkZE1vcmUiLCJmaXJzdFNob3VsZEluY3JlbWVudCIsImxhc3RXaWxsQWRkTW9yZSIsImxhc3RTaG91bGRJbmNyZW1lbnQiLCJFcnJvciIsImtleUV4dHJhY3RvciIsIml0ZW0iLCJpbmRleCIsImtleSIsImlkIiwiU3RyaW5nIl0sIm1hcHBpbmdzIjoiQUFVQTs7Ozs7Ozs7Ozs7Ozs7QUFFQTs7QUFPTyxTQUFTQSwwQkFBVCxDQUNMQyxPQURLLEVBRUxDLFNBRkssRUFHTEMsZUFISyxFQVVVO0FBQ2YsTUFBTUMsR0FBRyxHQUFHLEVBQVo7QUFDQSxNQUFJQyxTQUFTLEdB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IEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICogQGZvcm1hdFxuICovXG5cbid1c2Ugc3RyaWN0JztcblxuaW1wb3J0IGludmFyaWFudCBmcm9tICdpbnZhcmlhbnQnO1xuXG4vKipcbiAqIFVzZWQgdG8gZmluZCB0aGUgaW5kaWNlcyBvZiB0aGUgZnJhbWVzIHRoYXQgb3ZlcmxhcCB0aGUgZ2l2ZW4gb2Zmc2V0cy4gVXNlZnVsIGZvciBmaW5kaW5nIHRoZVxuICogaXRlbXMgdGhhdCBib3VuZCBkaWZmZXJlbnQgd2luZG93cyBvZiBjb250ZW50LCBzdWNoIGFzIHRoZSB2aXNpYmxlIGFyZWEgb3IgdGhlIGJ1ZmZlcmVkIG92ZXJzY2FuXG4gKiBhcmVhLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZWxlbWVudHNUaGF0T3ZlcmxhcE9mZnNldHMoXG4gIG9mZnNldHM6IEFycmF5PG51bWJlcj4sXG4gIGl0ZW1Db3VudDogbnVtYmVyLFxuICBnZXRGcmFtZU1ldHJpY3M6IChcbiAgICBpbmRleDogbnVtYmVyLFxuICApID0+IHtcbiAgICBsZW5ndGg6IG51bWJlcixcbiAgICBvZmZzZXQ6IG51bWJlcixcbiAgICAuLi5cbiAgfSxcbik6IEFycmF5PG51bWJlcj4ge1xuICBjb25zdCBvdXQgPSBbXTtcbiAgbGV0IG91dExlbmd0aCA9IDA7XG4gIGZvciAobGV0IGlpID0gMDsgaWkgPCBpdGVtQ291bnQ7IGlpKyspIHtcbiAgICBjb25zdCBmcmFtZSA9IGdldEZyYW1lTWV0cmljcyhpaSk7XG4gICAgY29uc3QgdHJhaWxpbmdPZmZzZXQgPSBmcmFtZS5vZmZzZXQgKyBmcmFtZS5sZW5ndGg7XG4gICAgZm9yIChsZXQga2sgPSAwOyBrayA8IG9mZnNldHMubGVuZ3RoOyBraysrKSB7XG4gICAgICBpZiAob3V0W2trXSA9PSBudWxsICYmIHRyYWlsaW5nT2Zmc2V0ID49IG9mZnNldHNba2tdKSB7XG4gICAgICAgIG91dFtra10gPSBpaTtcbiAgICAgICAgb3V0TGVuZ3RoKys7XG4gICAgICAgIGlmIChrayA9PT0gb2Zmc2V0cy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgaW52YXJpYW50KFxuICAgICAgICAgICAgb3V0TGVuZ3RoID09PSBvZmZzZXRzLmxlbmd0aCxcbiAgICAgICAgICAgICdiYWQgb2Zmc2V0cyBpbnB1dCwgc2hvdWxkIGJlIGluIGluY3JlYXNpbmcgb3JkZXI6ICVzJyxcbiAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KG9mZnNldHMpLFxuICAgICAgICAgICk7XG4gICAgICAgICAgcmV0dXJuIG91dDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gb3V0O1xufVxuXG4vKipcbiAqIENvbXB1dGVzIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gdGhlIGBuZXh0YCByYW5nZSB0aGF0IGFyZSBuZXcgY29tcGFyZWQgdG8gdGhlIGBwcmV2YCByYW5nZS5cbiAqIEhhbmR5IGZvciBjYWxjdWxhdGluZyBob3cgbWFueSBuZXcgaXRlbXMgd2lsbCBiZSByZW5kZXJlZCB3aGVuIHRoZSByZW5kZXIgd2luZG93IGNoYW5nZXMgc28gd2VcbiAqIGNhbiByZXN0cmljdCB0aGUgbnVtYmVyIG9mIG5ldyBpdGVtcyByZW5kZXIgYXQgb25jZSBzbyB0aGF0IGNvbnRlbnQgY2FuIGFwcGVhciBvbiB0aGUgc2NyZWVuXG4gKiBmYXN0ZXIuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBuZXdSYW5nZUNvdW50KFxuICBwcmV2OiB7XG4gICAgZmlyc3Q6IG51bWJlcixcbiAgICBsYXN0OiBudW1iZXIsXG4gICAgLi4uXG4gIH0sXG4gIG5leHQ6IHtcbiAgICBmaXJzdDogbnVtYmVyLFxuICAgIGxhc3Q6IG51bWJlcixcbiAgICAuLi5cbiAgfSxcbik6IG51bWJlciB7XG4gIHJldHVybiAoXG4gICAgbmV4dC5sYXN0IC1cbiAgICBuZXh0LmZpcnN0ICtcbiAgICAxIC1cbiAgICBNYXRoLm1heChcbiAgICAgIDAsXG4gICAgICAxICsgTWF0aC5taW4obmV4dC5sYXN0LCBwcmV2Lmxhc3QpIC0gTWF0aC5tYXgobmV4dC5maXJzdCwgcHJldi5maXJzdCksXG4gICAgKVxuICApO1xufVxuXG4vKipcbiAqIEN1c3RvbSBsb2dpYyBmb3IgZGV0ZXJtaW5pbmcgd2hpY2ggaXRlbXMgc2hvdWxkIGJlIHJlbmRlcmVkIGdpdmVuIHRoZSBjdXJyZW50IGZyYW1lIGFuZCBzY3JvbGxcbiAqIG1ldHJpY3MsIGFzIHdlbGwgYXMgdGhlIHByZXZpb3VzIHJlbmRlciBzdGF0ZS4gVGhlIGFsZ29yaXRobSBtYXkgZXZvbHZlIG92ZXIgdGltZSwgYnV0IGdlbmVyYWxseVxuICogcHJpb3JpdGl6ZXMgdGhlIHZpc2libGUgYXJlYSBmaXJzdCwgdGhlbiBleHBhbmRzIHRoYXQgd2l0aCBvdmVyc2NhbiByZWdpb25zIGFoZWFkIGFuZCBiZWhpbmQsXG4gKiBiaWFzZWQgaW4gdGhlIGRpcmVjdGlvbiBvZiBzY3JvbGwuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb21wdXRlV2luZG93ZWRSZW5kZXJMaW1pdHMoXG4gIGRhdGE6IGFueSxcbiAgZ2V0SXRlbUNvdW50OiAoZGF0YTogYW55KSA9PiBudW1iZXIsXG4gIG1heFRvUmVuZGVyUGVyQmF0Y2g6IG51bWJlcixcbiAgd2luZG93U2l6ZTogbnVtYmVyLFxuICBwcmV2OiB7XG4gICAgZmlyc3Q6IG51bWJlcixcbiAgICBsYXN0OiBudW1iZXIsXG4gICAgLi4uXG4gIH0sXG4gIGdldEZyYW1lTWV0cmljc0FwcHJveDogKFxuICAgIGluZGV4OiBudW1iZXIsXG4gICkgPT4ge1xuICAgIGxlbmd0aDogbnVtYmVyLFxuICAgIG9mZnNldDogbnVtYmVyLFxuICAgIC4uLlxuICB9LFxuICBzY3JvbGxNZXRyaWNzOiB7XG4gICAgZHQ6IG51bWJlcixcbiAgICBvZmZzZXQ6IG51bWJlcixcbiAgICB2ZWxvY2l0eTogbnVtYmVyLFxuICAgIHZpc2libGVMZW5ndGg6IG51bWJlcixcbiAgICAuLi5cbiAgfSxcbik6IHtcbiAgZmlyc3Q6IG51bWJlcixcbiAgbGFzdDogbnVtYmVyLFxuICAuLi5cbn0ge1xuICBjb25zdCBpdGVtQ291bnQgPSBnZXRJdGVtQ291bnQoZGF0YSk7XG4gIGlmIChpdGVtQ291bnQgPT09IDApIHtcbiAgICByZXR1cm4gcHJldjtcbiAgfVxuICBjb25zdCB7b2Zmc2V0LCB2ZWxvY2l0eSwgdmlzaWJsZUxlbmd0aH0gPSBzY3JvbGxNZXRyaWNzO1xuXG4gIC8vIFN0YXJ0IHdpdGggdmlzaWJsZSBhcmVhLCB0aGVuIGNvbXB1dGUgbWF4aW11bSBvdmVyc2NhbiByZWdpb24gYnkgZXhwYW5kaW5nIGZyb20gdGhlcmUsIGJpYXNlZFxuICAvLyBpbiB0aGUgZGlyZWN0aW9uIG9mIHNjcm9sbC4gVG90YWwgb3ZlcnNjYW4gYXJlYSBpcyBjYXBwZWQsIHdoaWNoIHNob3VsZCBjYXAgbWVtb3J5IGNvbnN1bXB0aW9uXG4gIC8vIHRvby5cbiAgY29uc3QgdmlzaWJsZUJlZ2luID0gTWF0aC5tYXgoMCwgb2Zmc2V0KTtcbiAgY29uc3QgdmlzaWJsZUVuZCA9IHZpc2libGVCZWdpbiArIHZpc2libGVMZW5ndGg7XG4gIGNvbnN0IG92ZXJzY2FuTGVuZ3RoID0gKHdpbmRvd1NpemUgLSAxKSAqIHZpc2libGVMZW5ndGg7XG5cbiAgLy8gQ29uc2lkZXJpbmcgdmVsb2NpdHkgc2VlbXMgdG8gaW50cm9kdWNlIG1vcmUgY2h1cm4gdGhhbiBpdCdzIHdvcnRoLlxuICBjb25zdCBsZWFkRmFjdG9yID0gMC41OyAvLyBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCB2ZWxvY2l0eSAvIDI1ICsgMC41KSk7XG5cbiAgY29uc3QgZmlsbFByZWZlcmVuY2UgPVxuICAgIHZlbG9jaXR5ID4gMSA/ICdhZnRlcicgOiB2ZWxvY2l0eSA8IC0xID8gJ2JlZm9yZScgOiAnbm9uZSc7XG5cbiAgY29uc3Qgb3ZlcnNjYW5CZWdpbiA9IE1hdGgubWF4KFxuICAgIDAsXG4gICAgdmlzaWJsZUJlZ2luIC0gKDEgLSBsZWFkRmFjdG9yKSAqIG92ZXJzY2FuTGVuZ3RoLFxuICApO1xuICBjb25zdCBvdmVyc2NhbkVuZCA9IE1hdGgubWF4KDAsIHZpc2libGVFbmQgKyBsZWFkRmFjdG9yICogb3ZlcnNjYW5MZW5ndGgpO1xuXG4gIGNvbnN0IGxhc3RJdGVtT2Zmc2V0ID0gZ2V0RnJhbWVNZXRyaWNzQXBwcm94KGl0ZW1Db3VudCAtIDEpLm9mZnNldDtcbiAgaWYgKGxhc3RJdGVtT2Zmc2V0IDwgb3ZlcnNjYW5CZWdpbikge1xuICAgIC8vIEVudGlyZSBsaXN0IGlzIGJlZm9yZSBvdXIgb3ZlcnNjYW4gd2luZG93XG4gICAgcmV0dXJuIHtcbiAgICAgIGZpcnN0OiBNYXRoLm1heCgwLCBpdGVtQ291bnQgLSAxIC0gbWF4VG9SZW5kZXJQZXJCYXRjaCksXG4gICAgICBsYXN0OiBpdGVtQ291bnQgLSAxLFxuICAgIH07XG4gIH1cblxuICAvLyBGaW5kIHRoZSBpbmRpY2VzIHRoYXQgY29ycmVzcG9uZCB0byB0aGUgaXRlbXMgYXQgdGhlIHJlbmRlciBib3VuZGFyaWVzIHdlJ3JlIHRhcmdldGluZy5cbiAgbGV0IFtvdmVyc2NhbkZpcnN0LCBmaXJzdCwgbGFzdCwgb3ZlcnNjYW5MYXN0XSA9IGVsZW1lbnRzVGhhdE92ZXJsYXBPZmZzZXRzKFxuICAgIFtvdmVyc2NhbkJlZ2luLCB2aXNpYmxlQmVnaW4sIHZpc2libGVFbmQsIG92ZXJzY2FuRW5kXSxcbiAgICBpdGVtQ291bnQsXG4gICAgZ2V0RnJhbWVNZXRyaWNzQXBwcm94LFxuICApO1xuICBvdmVyc2NhbkZpcnN0ID0gb3ZlcnNjYW5GaXJzdCA9PSBudWxsID8gMCA6IG92ZXJzY2FuRmlyc3Q7XG4gIGZpcnN0ID0gZmlyc3QgPT0gbnVsbCA/IE1hdGgubWF4KDAsIG92ZXJzY2FuRmlyc3QpIDogZmlyc3Q7XG4gIG92ZXJzY2FuTGFzdCA9IG92ZXJzY2FuTGFzdCA9PSBudWxsID8gaXRlbUNvdW50IC0gMSA6IG92ZXJzY2FuTGFzdDtcbiAgbGFzdCA9XG4gICAgbGFzdCA9PSBudWxsXG4gICAgICA/IE1hdGgubWluKG92ZXJzY2FuTGFzdCwgZmlyc3QgKyBtYXhUb1JlbmRlclBlckJhdGNoIC0gMSlcbiAgICAgIDogbGFzdDtcbiAgY29uc3QgdmlzaWJsZSA9IHtmaXJzdCwgbGFzdH07XG5cbiAgLy8gV2Ugd2FudCB0byBsaW1pdCB0aGUgbnVtYmVyIG9mIG5ldyBjZWxscyB3ZSdyZSByZW5kZXJpbmcgcGVyIGJhdGNoIHNvIHRoYXQgd2UgY2FuIGZpbGwgdGhlXG4gIC8vIGNvbnRlbnQgb24gdGhlIHNjcmVlbiBxdWlja2x5LiBJZiB3ZSByZW5kZXJlZCB0aGUgZW50aXJlIG92ZXJzY2FuIHdpbmRvdyBhdCBvbmNlLCB0aGUgdXNlclxuICAvLyBjb3VsZCBiZSBzdGFyaW5nIGF0IHdoaXRlIHNwYWNlIGZvciBhIGxvbmcgdGltZSB3YWl0aW5nIGZvciBhIGJ1bmNoIG9mIG9mZnNjcmVlbiBjb250ZW50IHRvXG4gIC8vIHJlbmRlci5cbiAgbGV0IG5ld0NlbGxDb3VudCA9IG5ld1JhbmdlQ291bnQocHJldiwgdmlzaWJsZSk7XG5cbiAgd2hpbGUgKHRydWUpIHtcbiAgICBpZiAoZmlyc3QgPD0gb3ZlcnNjYW5GaXJzdCAmJiBsYXN0ID49IG92ZXJzY2FuTGFzdCkge1xuICAgICAgLy8gSWYgd2UgZmlsbCB0aGUgZW50aXJlIG92ZXJzY2FuIHJhbmdlLCB3ZSdyZSBkb25lLlxuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNvbnN0IG1heE5ld0NlbGxzID0gbmV3Q2VsbENvdW50ID49IG1heFRvUmVuZGVyUGVyQmF0Y2g7XG4gICAgY29uc3QgZmlyc3RXaWxsQWRkTW9yZSA9IGZpcnN0IDw9IHByZXYuZmlyc3QgfHwgZmlyc3QgPiBwcmV2Lmxhc3Q7XG4gICAgY29uc3QgZmlyc3RTaG91bGRJbmNyZW1lbnQgPVxuICAgICAgZmlyc3QgPiBvdmVyc2NhbkZpcnN0ICYmICghbWF4TmV3Q2VsbHMgfHwgIWZpcnN0V2lsbEFkZE1vcmUpO1xuICAgIGNvbnN0IGxhc3RXaWxsQWRkTW9yZSA9IGxhc3QgPj0gcHJldi5sYXN0IHx8IGxhc3QgPCBwcmV2LmZpcnN0O1xuICAgIGNvbnN0IGxhc3RTaG91bGRJbmNyZW1lbnQgPVxuICAgICAgbGFzdCA8IG92ZXJzY2FuTGFzdCAmJiAoIW1heE5ld0NlbGxzIHx8ICFsYXN0V2lsbEFkZE1vcmUpO1xuICAgIGlmIChtYXhOZXdDZWxscyAmJiAhZmlyc3RTaG91bGRJbmNyZW1lbnQgJiYgIWxhc3RTaG91bGRJbmNyZW1lbnQpIHtcbiAgICAgIC8vIFdlIG9ubHkgd2FudCB0byBzdG9wIGlmIHdlJ3ZlIGhpdCBtYXhOZXdDZWxscyBBTkQgd2UgY2Fubm90IGluY3JlbWVudCBmaXJzdCBvciBsYXN0XG4gICAgICAvLyB3aXRob3V0IHJlbmRlcmluZyBuZXcgaXRlbXMuIFRoaXMgbGV0J3MgdXMgcHJlc2VydmUgYXMgbWFueSBhbHJlYWR5IHJlbmRlcmVkIGl0ZW1zIGFzXG4gICAgICAvLyBwb3NzaWJsZSwgcmVkdWNpbmcgcmVuZGVyIGNodXJuIGFuZCBrZWVwaW5nIHRoZSByZW5kZXJlZCBvdmVyc2NhbiByYW5nZSBhcyBsYXJnZSBhc1xuICAgICAgLy8gcG9zc2libGUuXG4gICAgICBicmVhaztcbiAgICB9XG4gICAgaWYgKFxuICAgICAgZmlyc3RTaG91bGRJbmNyZW1lbnQgJiZcbiAgICAgICEoZmlsbFByZWZlcmVuY2UgPT09ICdhZnRlcicgJiYgbGFzdFNob3VsZEluY3JlbWVudCAmJiBsYXN0V2lsbEFkZE1vcmUpXG4gICAgKSB7XG4gICAgICBpZiAoZmlyc3RXaWxsQWRkTW9yZSkge1xuICAgICAgICBuZXdDZWxsQ291bnQrKztcbiAgICAgIH1cbiAgICAgIGZpcnN0LS07XG4gICAgfVxuICAgIGlmIChcbiAgICAgIGxhc3RTaG91bGRJbmNyZW1lbnQgJiZcbiAgICAgICEoZmlsbFByZWZlcmVuY2UgPT09ICdiZWZvcmUnICYmIGZpcnN0U2hvdWxkSW5jcmVtZW50ICYmIGZpcnN0V2lsbEFkZE1vcmUpXG4gICAgKSB7XG4gICAgICBpZiAobGFzdFdpbGxBZGRNb3JlKSB7XG4gICAgICAgIG5ld0NlbGxDb3VudCsrO1xuICAgICAgfVxuICAgICAgbGFzdCsrO1xuICAgIH1cbiAgfVxuICBpZiAoXG4gICAgIShcbiAgICAgIGxhc3QgPj0gZmlyc3QgJiZcbiAgICAgIGZpcnN0ID49IDAgJiZcbiAgICAgIGxhc3QgPCBpdGVtQ291bnQgJiZcbiAgICAgIGZpcnN0ID49IG92ZXJzY2FuRmlyc3QgJiZcbiAgICAgIGxhc3QgPD0gb3ZlcnNjYW5MYXN0ICYmXG4gICAgICBmaXJzdCA8PSB2aXNpYmxlLmZpcnN0ICYmXG4gICAgICBsYXN0ID49IHZpc2libGUubGFzdFxuICAgIClcbiAgKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgJ0JhZCB3aW5kb3cgY2FsY3VsYXRpb24gJyArXG4gICAgICAgIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBmaXJzdCxcbiAgICAgICAgICBsYXN0LFxuICAgICAgICAgIGl0ZW1Db3VudCxcbiAgICAgICAgICBvdmVyc2NhbkZpcnN0LFxuICAgICAgICAgIG92ZXJzY2FuTGFzdCxcbiAgICAgICAgICB2aXNpYmxlLFxuICAgICAgICB9KSxcbiAgICApO1xuICB9XG4gIHJldHVybiB7Zmlyc3QsIGxhc3R9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24ga2V5RXh0cmFjdG9yKGl0ZW06IGFueSwgaW5kZXg6IG51bWJlcik6IHN0cmluZyB7XG4gIGlmICh0eXBlb2YgaXRlbSA9PT0gJ29iamVjdCcgJiYgaXRlbT8ua2V5ICE9IG51bGwpIHtcbiAgICByZXR1cm4gaXRlbS5rZXk7XG4gIH1cbiAgaWYgKHR5cGVvZiBpdGVtID09PSAnb2JqZWN0JyAmJiBpdGVtPy5pZCAhPSBudWxsKSB7XG4gICAgcmV0dXJuIGl0ZW0uaWQ7XG4gIH1cbiAgcmV0dXJuIFN0cmluZyhpbmRleCk7XG59XG4iXX0=