71c6909ad9c06e806444059962947f6e
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var AnimatedValue = require("./nodes/AnimatedValue");

var AnimatedValueXY = require("./nodes/AnimatedValueXY");

var NativeAnimatedHelper = require("./NativeAnimatedHelper");

var ReactNative = require("../Renderer/shims/ReactNative");

var invariant = require('invariant');

var _require = require("./NativeAnimatedHelper"),
    shouldUseNativeDriver = _require.shouldUseNativeDriver;

function attachNativeEvent(viewRef, eventName, argMapping) {
  var eventMappings = [];

  var traverse = function traverse(value, path) {
    if (value instanceof AnimatedValue) {
      value.__makeNative();

      eventMappings.push({
        nativeEventPath: path,
        animatedValueTag: value.__getNativeTag()
      });
    } else if (value instanceof AnimatedValueXY) {
      traverse(value.x, path.concat('x'));
      traverse(value.y, path.concat('y'));
    } else if (typeof value === 'object') {
      for (var _key in value) {
        traverse(value[_key], path.concat(_key));
      }
    }
  };

  invariant(argMapping[0] && argMapping[0].nativeEvent, 'Native driven events only support animated values contained inside `nativeEvent`.');
  traverse(argMapping[0].nativeEvent, []);
  var viewTag = ReactNative.findNodeHandle(viewRef);

  if (viewTag != null) {
    eventMappings.forEach(function (mapping) {
      NativeAnimatedHelper.API.addAnimatedEventToView(viewTag, eventName, mapping);
    });
  }

  return {
    detach: function detach() {
      if (viewTag != null) {
        eventMappings.forEach(function (mapping) {
          NativeAnimatedHelper.API.removeAnimatedEventFromView(viewTag, eventName, mapping.animatedValueTag);
        });
      }
    }
  };
}

function validateMapping(argMapping, args) {
  var validate = function validate(recMapping, recEvt, key) {
    if (recMapping instanceof AnimatedValue) {
      invariant(typeof recEvt === 'number', 'Bad mapping of event key ' + key + ', should be number but got ' + typeof recEvt);
      return;
    }

    if (recMapping instanceof AnimatedValueXY) {
      invariant(typeof recEvt.x === 'number' && typeof recEvt.y === 'number', 'Bad mapping of event key ' + key + ', should be XY but got ' + recEvt);
      return;
    }

    if (typeof recEvt === 'number') {
      invariant(recMapping instanceof AnimatedValue, 'Bad mapping of type ' + typeof recMapping + ' for key ' + key + ', event value must map to AnimatedValue');
      return;
    }

    invariant(typeof recMapping === 'object', 'Bad mapping of type ' + typeof recMapping + ' for key ' + key);
    invariant(typeof recEvt === 'object', 'Bad event of type ' + typeof recEvt + ' for key ' + key);

    for (var mappingKey in recMapping) {
      validate(recMapping[mappingKey], recEvt[mappingKey], mappingKey);
    }
  };

  invariant(args.length >= argMapping.length, 'Event has less arguments than mapping');
  argMapping.forEach(function (mapping, idx) {
    validate(mapping, args[idx], 'arg' + idx);
  });
}

var AnimatedEvent = function () {
  function AnimatedEvent(argMapping, config) {
    (0, _classCallCheck2.default)(this, AnimatedEvent);
    this._listeners = [];
    this._argMapping = argMapping;

    if (config == null) {
      console.warn('Animated.event now requires a second argument for options');
      config = {
        useNativeDriver: false
      };
    }

    if (config.listener) {
      this.__addListener(config.listener);
    }

    this._callListeners = this._callListeners.bind(this);
    this._attachedEvent = null;
    this.__isNative = shouldUseNativeDriver(config);
  }

  (0, _createClass2.default)(AnimatedEvent, [{
    key: "__addListener",
    value: function __addListener(callback) {
      this._listeners.push(callback);
    }
  }, {
    key: "__removeListener",
    value: function __removeListener(callback) {
      this._listeners = this._listeners.filter(function (listener) {
        return listener !== callback;
      });
    }
  }, {
    key: "__attach",
    value: function __attach(viewRef, eventName) {
      invariant(this.__isNative, 'Only native driven events need to be attached.');
      this._attachedEvent = attachNativeEvent(viewRef, eventName, this._argMapping);
    }
  }, {
    key: "__detach",
    value: function __detach(viewTag, eventName) {
      invariant(this.__isNative, 'Only native driven events need to be detached.');
      this._attachedEvent && this._attachedEvent.detach();
    }
  }, {
    key: "__getHandler",
    value: function __getHandler() {
      var _this = this;

      if (this.__isNative) {
        if (__DEV__) {
          var _validatedMapping = false;
          return function () {
            for (var _len = arguments.length, args = new Array(_len), _key2 = 0; _key2 < _len; _key2++) {
              args[_key2] = arguments[_key2];
            }

            if (!_validatedMapping) {
              validateMapping(_this._argMapping, args);
              _validatedMapping = true;
            }

            _this._callListeners.apply(_this, args);
          };
        } else {
          return this._callListeners;
        }
      }

      var validatedMapping = false;
      return function () {
        for (var _len2 = arguments.length, args = new Array(_len2), _key3 = 0; _key3 < _len2; _key3++) {
          args[_key3] = arguments[_key3];
        }

        if (__DEV__ && !validatedMapping) {
          validateMapping(_this._argMapping, args);
          validatedMapping = true;
        }

        var traverse = function traverse(recMapping, recEvt) {
          if (recMapping instanceof AnimatedValue) {
            if (typeof recEvt === 'number') {
              recMapping.setValue(recEvt);
            }
          } else if (recMapping instanceof AnimatedValueXY) {
            if (typeof recEvt === 'object') {
              traverse(recMapping.x, recEvt.x);
              traverse(recMapping.y, recEvt.y);
            }
          } else if (typeof recMapping === 'object') {
            for (var mappingKey in recMapping) {
              traverse(recMapping[mappingKey], recEvt[mappingKey]);
            }
          }
        };

        _this._argMapping.forEach(function (mapping, idx) {
          traverse(mapping, args[idx]);
        });

        _this._callListeners.apply(_this, args);
      };
    }
  }, {
    key: "_callListeners",
    value: function _callListeners() {
      for (var _len3 = arguments.length, args = new Array(_len3), _key4 = 0; _key4 < _len3; _key4++) {
        args[_key4] = arguments[_key4];
      }

      this._listeners.forEach(function (listener) {
        return listener.apply(void 0, args);
      });
    }
  }]);
  return AnimatedEvent;
}();

module.exports = {
  AnimatedEvent: AnimatedEvent,
  attachNativeEvent: attachNativeEvent
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFuaW1hdGVkRXZlbnQuanMiXSwibmFtZXMiOlsiQW5pbWF0ZWRWYWx1ZSIsInJlcXVpcmUiLCJBbmltYXRlZFZhbHVlWFkiLCJOYXRpdmVBbmltYXRlZEhlbHBlciIsIlJlYWN0TmF0aXZlIiwiaW52YXJpYW50Iiwic2hvdWxkVXNlTmF0aXZlRHJpdmVyIiwiYXR0YWNoTmF0aXZlRXZlbnQiLCJ2aWV3UmVmIiwiZXZlbnROYW1lIiwiYXJnTWFwcGluZyIsImV2ZW50TWFwcGluZ3MiLCJ0cmF2ZXJzZSIsInZhbHVlIiwicGF0aCIsIl9fbWFrZU5hdGl2ZSIsInB1c2giLCJuYXRpdmVFdmVudFBhdGgiLCJhbmltYXRlZFZhbHVlVGFnIiwiX19nZXROYXRpdmVUYWciLCJ4IiwiY29uY2F0IiwieSIsImtleSIsIm5hdGl2ZUV2ZW50Iiwidmlld1RhZyIsImZpbmROb2RlSGFuZGxlIiwiZm9yRWFjaCIsIm1hcHBpbmciLCJBUEkiLCJhZGRBbmltYXRlZEV2ZW50VG9WaWV3IiwiZGV0YWNoIiwicmVtb3ZlQW5pbWF0ZWRFdmVudEZyb21WaWV3IiwidmFsaWRhdGVNYXBwaW5nIiwiYXJncyIsInZhbGlkYXRlIiwicmVjTWFwcGluZyIsInJlY0V2dCIsIm1hcHBpbmdLZXkiLCJsZW5ndGgiLCJpZHgiLCJBbmltYXRlZEV2ZW50IiwiY29uZmlnIiwiX2xpc3RlbmVycyIsIl9hcmdNYXBwaW5nIiwiY29uc29sZSIsIndhcm4iLCJ1c2VOYXRpdmVEcml2ZXIiLCJsaXN0ZW5lciIsIl9fYWRkTGlzdGVuZXIiLCJfY2FsbExpc3RlbmVycyIsImJpbmQiLCJfYXR0YWNoZWRFdmVudCIsIl9faXNOYXRpdmUiLCJjYWxsYmFjayIsImZpbHRlciIsIl9fREVWX18iLCJ2YWxpZGF0ZWRNYXBwaW5nIiwic2V0VmFsdWUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFVQTs7Ozs7Ozs7QUFFQSxJQUFNQSxhQUFhLEdBQUdDLE9BQU8seUJBQTdCOztBQUNBLElBQU1D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WWQsSUFBWixDQUFKO0FBQUEsT0FBaEM7QUFDRDs7Ozs7QUFHSHlCLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjtBQUFDbkIsRUFBQUEsYUFBYSxFQUFiQSxhQUFEO0FBQWdCbEMsRUFBQUEsaUJBQWlCLEVBQWpCQTtBQUFoQixDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZsb3dcbiAqIEBmb3JtYXRcbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbmNvbnN0IEFuaW1hdGVkVmFsdWUgPSByZXF1aXJlKCcuL25vZGVzL0FuaW1hdGVkVmFsdWUnKTtcbmNvbnN0IEFuaW1hdGVkVmFsdWVYWSA9IHJlcXVpcmUoJy4vbm9kZXMvQW5pbWF0ZWRWYWx1ZVhZJyk7XG5jb25zdCBOYXRpdmVBbmltYXRlZEhlbHBlciA9IHJlcXVpcmUoJy4vTmF0aXZlQW5pbWF0ZWRIZWxwZXInKTtcbmNvbnN0IFJlYWN0TmF0aXZlID0gcmVxdWlyZSgnLi4vUmVuZGVyZXIvc2hpbXMvUmVhY3ROYXRpdmUnKTtcblxuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnaW52YXJpYW50Jyk7XG5cbmNvbnN0IHtzaG91bGRVc2VOYXRpdmVEcml2ZXJ9ID0gcmVxdWlyZSgnLi9OYXRpdmVBbmltYXRlZEhlbHBlcicpO1xuXG5leHBvcnQgdHlwZSBNYXBwaW5nID1cbiAgfCB7W2tleTogc3RyaW5nXTogTWFwcGluZywgLi4ufVxuICB8IEFuaW1hdGVkVmFsdWVcbiAgfCBBbmltYXRlZFZhbHVlWFk7XG5leHBvcnQgdHlwZSBFdmVudENvbmZpZyA9IHtcbiAgbGlzdGVuZXI/OiA/RnVuY3Rpb24sXG4gIHVzZU5hdGl2ZURyaXZlcjogYm9vbGVhbixcbn07XG5cbmZ1bmN0aW9uIGF0dGFjaE5hdGl2ZUV2ZW50KFxuICB2aWV3UmVmOiBhbnksXG4gIGV2ZW50TmFtZTogc3RyaW5nLFxuICBhcmdNYXBwaW5nOiAkUmVhZE9ubHlBcnJheTw/TWFwcGluZz4sXG4pOiB7ZGV0YWNoOiAoKSA9PiB2b2lkfSB7XG4gIC8vIEZpbmQgYW5pbWF0ZWQgdmFsdWVzIGluIGBhcmdNYXBwaW5nYCBhbmQgY3JlYXRlIGFuIGFycmF5IHJlcHJlc2VudGluZyB0aGVpclxuICAvLyBrZXkgcGF0aCBpbnNpZGUgdGhlIGBuYXRpdmVFdmVudGAgb2JqZWN0LiBFeC46IFsnY29udGVudE9mZnNldCcsICd4J10uXG4gIGNvbnN0IGV2ZW50TWFwcGluZ3MgPSBbXTtcblxuICBjb25zdCB0cmF2ZXJzZSA9ICh2YWx1ZSwgcGF0aCkgPT4ge1xuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIEFuaW1hdGVkVmFsdWUpIHtcbiAgICAgIHZhbHVlLl9fbWFrZU5hdGl2ZSgpO1xuXG4gICAgICBldmVudE1hcHBpbmdzLnB1c2goe1xuICAgICAgICBuYXRpdmVFdmVudFBhdGg6IHBhdGgsXG4gICAgICAgIGFuaW1hdGVkVmFsdWVUYWc6IHZhbHVlLl9fZ2V0TmF0aXZlVGFnKCksXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHZhbHVlIGluc3RhbmNlb2YgQW5pbWF0ZWRWYWx1ZVhZKSB7XG4gICAgICB0cmF2ZXJzZSh2YWx1ZS54LCBwYXRoLmNvbmNhdCgneCcpKTtcbiAgICAgIHRyYXZlcnNlKHZhbHVlLnksIHBhdGguY29uY2F0KCd5JykpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gdmFsdWUpIHtcbiAgICAgICAgdHJhdmVyc2UodmFsdWVba2V5XSwgcGF0aC5jb25jYXQoa2V5KSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIGludmFyaWFudChcbiAgICBhcmdNYXBwaW5nWzBdICYmIGFyZ01hcHBpbmdbMF0ubmF0aXZlRXZlbnQsXG4gICAgJ05hdGl2ZSBkcml2ZW4gZXZlbnRzIG9ubHkgc3VwcG9ydCBhbmltYXRlZCB2YWx1ZXMgY29udGFpbmVkIGluc2lkZSBgbmF0aXZlRXZlbnRgLicsXG4gICk7XG5cbiAgLy8gQXNzdW1lIHRoYXQgdGhlIGV2ZW50IGNvbnRhaW5pbmcgYG5hdGl2ZUV2ZW50YCBpcyBhbHdheXMgdGhlIGZpcnN0IGFyZ3VtZW50LlxuICB0cmF2ZXJzZShhcmdNYXBwaW5nWzBdLm5hdGl2ZUV2ZW50LCBbXSk7XG5cbiAgY29uc3Qgdmlld1RhZyA9IFJlYWN0TmF0aXZlLmZpbmROb2RlSGFuZGxlKHZpZXdSZWYpO1xuICBpZiAodmlld1RhZyAhPSBudWxsKSB7XG4gICAgZXZlbnRNYXBwaW5ncy5mb3JFYWNoKG1hcHBpbmcgPT4ge1xuICAgICAgTmF0aXZlQW5pbWF0ZWRIZWxwZXIuQVBJLmFkZEFuaW1hdGVkRXZlbnRUb1ZpZXcoXG4gICAgICAgIHZpZXdUYWcsXG4gICAgICAgIGV2ZW50TmFtZSxcbiAgICAgICAgbWFwcGluZyxcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIGRldGFjaCgpIHtcbiAgICAgIGlmICh2aWV3VGFnICE9IG51bGwpIHtcbiAgICAgICAgZXZlbnRNYXBwaW5ncy5mb3JFYWNoKG1hcHBpbmcgPT4ge1xuICAgICAgICAgIE5hdGl2ZUFuaW1hdGVkSGVscGVyLkFQSS5yZW1vdmVBbmltYXRlZEV2ZW50RnJvbVZpZXcoXG4gICAgICAgICAgICB2aWV3VGFnLFxuICAgICAgICAgICAgZXZlbnROYW1lLFxuICAgICAgICAgICAgLy8gJEZsb3dGaXhNZVtpbmNvbXBhdGlibGUtY2FsbF1cbiAgICAgICAgICAgIG1hcHBpbmcuYW5pbWF0ZWRWYWx1ZVRhZyxcbiAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9LFxuICB9O1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZU1hcHBpbmcoYXJnTWFwcGluZywgYXJncykge1xuICBjb25zdCB2YWxpZGF0ZSA9IChyZWNNYXBwaW5nLCByZWNFdnQsIGtleSkgPT4ge1xuICAgIGlmIChyZWNNYXBwaW5nIGluc3RhbmNlb2YgQW5pbWF0ZWRWYWx1ZSkge1xuICAgICAgaW52YXJpYW50KFxuICAgICAgICB0eXBlb2YgcmVjRXZ0ID09PSAnbnVtYmVyJyxcbiAgICAgICAgJ0JhZCBtYXBwaW5nIG9mIGV2ZW50IGtleSAnICtcbiAgICAgICAgICBrZXkgK1xuICAgICAgICAgICcsIHNob3VsZCBiZSBudW1iZXIgYnV0IGdvdCAnICtcbiAgICAgICAgICB0eXBlb2YgcmVjRXZ0LFxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHJlY01hcHBpbmcgaW5zdGFuY2VvZiBBbmltYXRlZFZhbHVlWFkpIHtcbiAgICAgIGludmFyaWFudChcbiAgICAgICAgdHlwZW9mIHJlY0V2dC54ID09PSAnbnVtYmVyJyAmJiB0eXBlb2YgcmVjRXZ0LnkgPT09ICdudW1iZXInLFxuICAgICAgICAnQmFkIG1hcHBpbmcgb2YgZXZlbnQga2V5ICcgKyBrZXkgKyAnLCBzaG91bGQgYmUgWFkgYnV0IGdvdCAnICsgcmVjRXZ0LFxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiByZWNFdnQgPT09ICdudW1iZXInKSB7XG4gICAgICBpbnZhcmlhbnQoXG4gICAgICAgIHJlY01hcHBpbmcgaW5zdGFuY2VvZiBBbmltYXRlZFZhbHVlLFxuICAgICAgICAnQmFkIG1hcHBpbmcgb2YgdHlwZSAnICtcbiAgICAgICAgICB0eXBlb2YgcmVjTWFwcGluZyArXG4gICAgICAgICAgJyBmb3Iga2V5ICcgK1xuICAgICAgICAgIGtleSArXG4gICAgICAgICAgJywgZXZlbnQgdmFsdWUgbXVzdCBtYXAgdG8gQW5pbWF0ZWRWYWx1ZScsXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpbnZhcmlhbnQoXG4gICAgICB0eXBlb2YgcmVjTWFwcGluZyA9PT0gJ29iamVjdCcsXG4gICAgICAnQmFkIG1hcHBpbmcgb2YgdHlwZSAnICsgdHlwZW9mIHJlY01hcHBpbmcgKyAnIGZvciBrZXkgJyArIGtleSxcbiAgICApO1xuICAgIGludmFyaWFudChcbiAgICAgIHR5cGVvZiByZWNFdnQgPT09ICdvYmplY3QnLFxuICAgICAgJ0JhZCBldmVudCBvZiB0eXBlICcgKyB0eXBlb2YgcmVjRXZ0ICsgJyBmb3Iga2V5ICcgKyBrZXksXG4gICAgKTtcbiAgICBmb3IgKGNvbnN0IG1hcHBpbmdLZXkgaW4gcmVjTWFwcGluZykge1xuICAgICAgdmFsaWRhdGUocmVjTWFwcGluZ1ttYXBwaW5nS2V5XSwgcmVjRXZ0W21hcHBpbmdLZXldLCBtYXBwaW5nS2V5KTtcbiAgICB9XG4gIH07XG5cbiAgaW52YXJpYW50KFxuICAgIGFyZ3MubGVuZ3RoID49IGFyZ01hcHBpbmcubGVuZ3RoLFxuICAgICdFdmVudCBoYXMgbGVzcyBhcmd1bWVudHMgdGhhbiBtYXBwaW5nJyxcbiAgKTtcbiAgYXJnTWFwcGluZy5mb3JFYWNoKChtYXBwaW5nLCBpZHgpID0+IHtcbiAgICB2YWxpZGF0ZShtYXBwaW5nLCBhcmdzW2lkeF0sICdhcmcnICsgaWR4KTtcbiAgfSk7XG59XG5cbmNsYXNzIEFuaW1hdGVkRXZlbnQge1xuICBfYXJnTWFwcGluZzogJFJlYWRPbmx5QXJyYXk8P01hcHBpbmc+O1xuICBfbGlzdGVuZXJzOiBBcnJheTxGdW5jdGlvbj4gPSBbXTtcbiAgX2NhbGxMaXN0ZW5lcnM6IEZ1bmN0aW9uO1xuICBfYXR0YWNoZWRFdmVudDogP3tkZXRhY2g6ICgpID0+IHZvaWQsIC4uLn07XG4gIF9faXNOYXRpdmU6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoYXJnTWFwcGluZzogJFJlYWRPbmx5QXJyYXk8P01hcHBpbmc+LCBjb25maWc6IEV2ZW50Q29uZmlnKSB7XG4gICAgdGhpcy5fYXJnTWFwcGluZyA9IGFyZ01hcHBpbmc7XG5cbiAgICBpZiAoY29uZmlnID09IG51bGwpIHtcbiAgICAgIGNvbnNvbGUud2FybignQW5pbWF0ZWQuZXZlbnQgbm93IHJlcXVpcmVzIGEgc2Vjb25kIGFyZ3VtZW50IGZvciBvcHRpb25zJyk7XG4gICAgICBjb25maWcgPSB7dXNlTmF0aXZlRHJpdmVyOiBmYWxzZX07XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy5saXN0ZW5lcikge1xuICAgICAgdGhpcy5fX2FkZExpc3RlbmVyKGNvbmZpZy5saXN0ZW5lcik7XG4gICAgfVxuICAgIHRoaXMuX2NhbGxMaXN0ZW5lcnMgPSB0aGlzLl9jYWxsTGlzdGVuZXJzLmJpbmQodGhpcyk7XG4gICAgdGhpcy5fYXR0YWNoZWRFdmVudCA9IG51bGw7XG4gICAgdGhpcy5fX2lzTmF0aXZlID0gc2hvdWxkVXNlTmF0aXZlRHJpdmVyKGNvbmZpZyk7XG4gIH1cblxuICBfX2FkZExpc3RlbmVyKGNhbGxiYWNrOiBGdW5jdGlvbik6IHZvaWQge1xuICAgIHRoaXMuX2xpc3RlbmVycy5wdXNoKGNhbGxiYWNrKTtcbiAgfVxuXG4gIF9fcmVtb3ZlTGlzdGVuZXIoY2FsbGJhY2s6IEZ1bmN0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5fbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzLmZpbHRlcihsaXN0ZW5lciA9PiBsaXN0ZW5lciAhPT0gY2FsbGJhY2spO1xuICB9XG5cbiAgX19hdHRhY2godmlld1JlZjogYW55LCBldmVudE5hbWU6IHN0cmluZykge1xuICAgIGludmFyaWFudChcbiAgICAgIHRoaXMuX19pc05hdGl2ZSxcbiAgICAgICdPbmx5IG5hdGl2ZSBkcml2ZW4gZXZlbnRzIG5lZWQgdG8gYmUgYXR0YWNoZWQuJyxcbiAgICApO1xuXG4gICAgdGhpcy5fYXR0YWNoZWRFdmVudCA9IGF0dGFjaE5hdGl2ZUV2ZW50KFxuICAgICAgdmlld1JlZixcbiAgICAgIGV2ZW50TmFtZSxcbiAgICAgIHRoaXMuX2FyZ01hcHBpbmcsXG4gICAgKTtcbiAgfVxuXG4gIF9fZGV0YWNoKHZpZXdUYWc6IGFueSwgZXZlbnROYW1lOiBzdHJpbmcpIHtcbiAgICBpbnZhcmlhbnQoXG4gICAgICB0aGlzLl9faXNOYXRpdmUsXG4gICAgICAnT25seSBuYXRpdmUgZHJpdmVuIGV2ZW50cyBuZWVkIHRvIGJlIGRldGFjaGVkLicsXG4gICAgKTtcblxuICAgIHRoaXMuX2F0dGFjaGVkRXZlbnQgJiYgdGhpcy5fYXR0YWNoZWRFdmVudC5kZXRhY2goKTtcbiAgfVxuXG4gIF9fZ2V0SGFuZGxlcigpOiBhbnkgfCAoKC4uLmFyZ3M6IGFueSkgPT4gdm9pZCkge1xuICAgIGlmICh0aGlzLl9faXNOYXRpdmUpIHtcbiAgICAgIGlmIChfX0RFVl9fKSB7XG4gICAgICAgIGxldCB2YWxpZGF0ZWRNYXBwaW5nID0gZmFsc2U7XG4gICAgICAgIHJldHVybiAoLi4uYXJnczogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKCF2YWxpZGF0ZWRNYXBwaW5nKSB7XG4gICAgICAgICAgICB2YWxpZGF0ZU1hcHBpbmcodGhpcy5fYXJnTWFwcGluZywgYXJncyk7XG4gICAgICAgICAgICB2YWxpZGF0ZWRNYXBwaW5nID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5fY2FsbExpc3RlbmVycyguLi5hcmdzKTtcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jYWxsTGlzdGVuZXJzO1xuICAgICAgfVxuICAgIH1cblxuICAgIGxldCB2YWxpZGF0ZWRNYXBwaW5nID0gZmFsc2U7XG4gICAgcmV0dXJuICguLi5hcmdzOiBhbnkpID0+IHtcbiAgICAgIGlmIChfX0RFVl9fICYmICF2YWxpZGF0ZWRNYXBwaW5nKSB7XG4gICAgICAgIHZhbGlkYXRlTWFwcGluZyh0aGlzLl9hcmdNYXBwaW5nLCBhcmdzKTtcbiAgICAgICAgdmFsaWRhdGVkTWFwcGluZyA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRyYXZlcnNlID0gKHJlY01hcHBpbmcsIHJlY0V2dCkgPT4ge1xuICAgICAgICBpZiAocmVjTWFwcGluZyBpbnN0YW5jZW9mIEFuaW1hdGVkVmFsdWUpIHtcbiAgICAgICAgICBpZiAodHlwZW9mIHJlY0V2dCA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgIHJlY01hcHBpbmcuc2V0VmFsdWUocmVjRXZ0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAocmVjTWFwcGluZyBpbnN0YW5jZW9mIEFuaW1hdGVkVmFsdWVYWSkge1xuICAgICAgICAgIGlmICh0eXBlb2YgcmVjRXZ0ID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgdHJhdmVyc2UocmVjTWFwcGluZy54LCByZWNFdnQueCk7XG4gICAgICAgICAgICB0cmF2ZXJzZShyZWNNYXBwaW5nLnksIHJlY0V2dC55KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlY01hcHBpbmcgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgZm9yIChjb25zdCBtYXBwaW5nS2V5IGluIHJlY01hcHBpbmcpIHtcbiAgICAgICAgICAgIC8qICRGbG93Rml4TWVbcHJvcC1taXNzaW5nXSAoPj0wLjEyMC4wKSBUaGlzIGNvbW1lbnQgc3VwcHJlc3NlcyBhblxuICAgICAgICAgICAgICogZXJyb3IgZm91bmQgd2hlbiBGbG93IHYwLjEyMCB3YXMgZGVwbG95ZWQuIFRvIHNlZSB0aGUgZXJyb3IsXG4gICAgICAgICAgICAgKiBkZWxldGUgdGhpcyBjb21tZW50IGFuZCBydW4gRmxvdy4gKi9cbiAgICAgICAgICAgIHRyYXZlcnNlKHJlY01hcHBpbmdbbWFwcGluZ0tleV0sIHJlY0V2dFttYXBwaW5nS2V5XSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgdGhpcy5fYXJnTWFwcGluZy5mb3JFYWNoKChtYXBwaW5nLCBpZHgpID0+IHtcbiAgICAgICAgdHJhdmVyc2UobWFwcGluZywgYXJnc1tpZHhdKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLl9jYWxsTGlzdGVuZXJzKC4uLmFyZ3MpO1xuICAgIH07XG4gIH1cblxuICBfY2FsbExpc3RlbmVycyguLi5hcmdzOiBhbnkpIHtcbiAgICB0aGlzLl9saXN0ZW5lcnMuZm9yRWFjaChsaXN0ZW5lciA9PiBsaXN0ZW5lciguLi5hcmdzKSk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7QW5pbWF0ZWRFdmVudCwgYXR0YWNoTmF0aXZlRXZlbnR9O1xuIl19