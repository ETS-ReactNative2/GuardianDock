8685acd30cb36a3d5b0faf93aa54efcb
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

function _createForOfIteratorHelperLoose(o, allowArrayLike) { var it = typeof Symbol !== "undefined" && o[Symbol.iterator] || o["@@iterator"]; if (it) return (it = it.call(o)).next.bind(it); if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") { if (it) o = it; var i = 0; return function () { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

var invariant = require('invariant');

var ViewabilityHelper = function () {
  function ViewabilityHelper() {
    var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {
      viewAreaCoveragePercentThreshold: 0
    };
    (0, _classCallCheck2.default)(this, ViewabilityHelper);
    this._hasInteracted = false;
    this._timers = new Set();
    this._viewableIndices = [];
    this._viewableItems = new Map();
    this._config = config;
  }

  (0, _createClass2.default)(ViewabilityHelper, [{
    key: "dispose",
    value: function dispose() {
      this._timers.forEach(clearTimeout);
    }
  }, {
    key: "computeViewableItems",
    value: function computeViewableItems(itemCount, scrollOffset, viewportHeight, getFrameMetrics, renderRange) {
      var _this$_config = this._config,
          itemVisiblePercentThreshold = _this$_config.itemVisiblePercentThreshold,
          viewAreaCoveragePercentThreshold = _this$_config.viewAreaCoveragePercentThreshold;
      var viewAreaMode = viewAreaCoveragePercentThreshold != null;
      var viewablePercentThreshold = viewAreaMode ? viewAreaCoveragePercentThreshold : itemVisiblePercentThreshold;
      invariant(viewablePercentThreshold != null && itemVisiblePercentThreshold != null !== (viewAreaCoveragePercentThreshold != null), 'Must set exactly one of itemVisiblePercentThreshold or viewAreaCoveragePercentThreshold');
      var viewableIndices = [];

      if (itemCount === 0) {
        return viewableIndices;
      }

      var firstVisible = -1;

      var _ref = renderRange || {
        first: 0,
        last: itemCount - 1
      },
          first = _ref.first,
          last = _ref.last;

      if (last >= itemCount) {
        console.warn('Invalid render range computing viewability ' + JSON.stringify({
          renderRange: renderRange,
          itemCount: itemCount
        }));
        return [];
      }

      for (var idx = first; idx <= last; idx++) {
        var metrics = getFrameMetrics(idx);

        if (!metrics) {
          continue;
        }

        var top = metrics.offset - scrollOffset;
        var bottom = top + metrics.length;

        if (top < viewportHeight && bottom > 0) {
          firstVisible = idx;

          if (_isViewable(viewAreaMode, viewablePercentThreshold, top, bottom, viewportHeight, metrics.length)) {
            viewableIndices.push(idx);
          }
        } else if (firstVisible >= 0) {
          break;
        }
      }

      return viewableIndices;
    }
  }, {
    key: "onUpdate",
    value: function onUpdate(itemCount, scrollOffset, viewportHeight, getFrameMetrics, createViewToken, onViewableItemsChanged, renderRange) {
      var _this = this;

      if (this._config.waitForInteraction && !this._hasInteracted || itemCount === 0 || !getFrameMetrics(0)) {
        return;
      }

      var viewableIndices = [];

      if (itemCount) {
        viewableIndices = this.computeViewableItems(itemCount, scrollOffset, viewportHeight, getFrameMetrics, renderRange);
      }

      if (this._viewableIndices.length === viewableIndices.length && this._viewableIndices.every(function (v, ii) {
        return v === viewableIndices[ii];
      })) {
        return;
      }

      this._viewableIndices = viewableIndices;

      if (this._config.minimumViewTime) {
        var handle = setTimeout(function () {
          _this._timers.delete(handle);

          _this._onUpdateSync(viewableIndices, onViewableItemsChanged, createViewToken);
        }, this._config.minimumViewTime);

        this._timers.add(handle);
      } else {
        this._onUpdateSync(viewableIndices, onViewableItemsChanged, createViewToken);
      }
    }
  }, {
    key: "resetViewableIndices",
    value: function resetViewableIndices() {
      this._viewableIndices = [];
    }
  }, {
    key: "recordInteraction",
    value: function recordInteraction() {
      this._hasInteracted = true;
    }
  }, {
    key: "_onUpdateSync",
    value: function _onUpdateSync(viewableIndicesToCheck, onViewableItemsChanged, createViewToken) {
      var _this2 = this;

      viewableIndicesToCheck = viewableIndicesToCheck.filter(function (ii) {
        return _this2._viewableIndices.includes(ii);
      });
      var prevItems = this._viewableItems;
      var nextItems = new Map(viewableIndicesToCheck.map(function (ii) {
        var viewable = createViewToken(ii, true);
        return [viewable.key, viewable];
      }));
      var changed = [];

      for (var _iterator = _createForOfIteratorHelperLoose(nextItems), _step; !(_step = _iterator()).done;) {
        var _ref2 = _step.value;

        var _ref3 = (0, _slicedToArray2.default)(_ref2, 2);

        var key = _ref3[0];
        var viewable = _ref3[1];

        if (!prevItems.has(key)) {
          changed.push(viewable);
        }
      }

      for (var _iterator2 = _createForOfIteratorHelperLoose(prevItems), _step2; !(_step2 = _iterator2()).done;) {
        var _ref4 = _step2.value;

        var _ref5 = (0, _slicedToArray2.default)(_ref4, 2);

        var _key = _ref5[0];
        var _viewable = _ref5[1];

        if (!nextItems.has(_key)) {
          changed.push((0, _extends2.default)({}, _viewable, {
            isViewable: false
          }));
        }
      }

      if (changed.length > 0) {
        this._viewableItems = nextItems;
        onViewableItemsChanged({
          viewableItems: Array.from(nextItems.values()),
          changed: changed,
          viewabilityConfig: this._config
        });
      }
    }
  }]);
  return ViewabilityHelper;
}();

function _isViewable(viewAreaMode, viewablePercentThreshold, top, bottom, viewportHeight, itemLength) {
  if (_isEntirelyVisible(top, bottom, viewportHeight)) {
    return true;
  } else {
    var pixels = _getPixelsVisible(top, bottom, viewportHeight);

    var percent = 100 * (viewAreaMode ? pixels / viewportHeight : pixels / itemLength);
    return percent >= viewablePercentThreshold;
  }
}

function _getPixelsVisible(top, bottom, viewportHeight) {
  var visibleHeight = Math.min(bottom, viewportHeight) - Math.max(top, 0);
  return Math.max(0, visibleHeight);
}

function _isEntirelyVisible(top, bottom, viewportHeight) {
  return top >= 0 && bottom <= viewportHeight && bottom > top;
}

module.exports = ViewabilityHelper;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlZpZXdhYmlsaXR5SGVscGVyLmpzIl0sIm5hbWVzIjpbImludmFyaWFudCIsInJlcXVpcmUiLCJWaWV3YWJpbGl0eUhlbHBlciIsImNvbmZpZyIsInZpZXdBcmVhQ292ZXJhZ2VQZXJjZW50VGhyZXNob2xkIiwiX2hhc0ludGVyYWN0ZWQiLCJfdGltZXJzIiwiU2V0IiwiX3ZpZXdhYmxlSW5kaWNlcyIsIl92aWV3YWJsZUl0ZW1zIiwiTWFwIiwiX2NvbmZpZyIsImZvckVhY2giLCJjbGVhclRpbWVvdXQiLCJpdGVtQ291bnQiLCJzY3JvbGxPZmZzZXQiLCJ2aWV3cG9ydEhlaWdodCIsImdldEZyYW1lTWV0cmljcyIsInJlbmRlclJhbmdlIiwiaXRlbVZpc2libGVQZXJjZW50VGhyZXNob2xkIiwidmlld0FyZWFNb2RlIiwidmlld2FibGVQZXJjZW50VGhyZXNob2xkIiwidmlld2FibGVJbmRpY2VzIiwiZmlyc3RWaXNpYmxlIiwiZmlyc3QiLCJsYXN0IiwiY29uc29sZSIsIndhcm4iLCJKU09OIiwic3RyaW5naWZ5IiwiaWR4IiwibWV0cmljcyIsInRvcCIsIm9mZnNldCIsImJvdHRvbSIsImxlbmd0aCIsIl9pc1ZpZXdhYmxlIiwicHVzaCIsImNyZWF0ZVZpZXdUb2tlbiIsIm9uVmlld2FibGVJdGVtc0NoYW5nZWQiLCJ3YWl0Rm9ySW50ZXJhY3Rpb24iLCJjb21wdXRlVmlld2FibGVJdGVtcyIsImV2ZXJ5IiwidiIsImlpIiwibWluaW11bVZpZXdUaW1lIiwiaGFuZGxlIiwic2V0VGltZW91dCIsImRlbGV0ZSIsIl9vblVwZGF0ZVN5bmMiLCJhZGQiLCJ2aWV3YWJsZUluZGljZXNUb0NoZWNrIiwiZmlsdGVyIiwiaW5jbHVkZXMiLCJwcmV2SXRlbXMiLCJuZXh0SXRlbXMiLCJtYXAiLCJ2aWV3YWJsZSIsImtleSIsImNoYW5nZWQiLCJoYXMiLCJpc1ZpZXdhYmxlIiwidmlld2FibGVJdGVtcyIsIkFycmF5IiwiZnJvbSIsInZhbHVlcyIsInZpZXdhYmlsaXR5Q29uZmlnIiwiaXRlbUxlbmd0aCIsIl9pc0VudGlyZWx5VmlzaWJsZSIsInBpeGVscyIsIl9nZXRQaXhlbHNWaXNpYmxlIiwicGVyY2VudCIsInZpc2libGVIZWlnaHQiLCJNYXRoIiwibWluIiwibWF4IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBVUE7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBLElBQU1BLFNBQVMsR0FBR0MsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0lBOERNQyxpQjtBQU9KLCtCQUVFO0FBQUEsUUFEQUMsTUFDQSx1RUFENEI7QUFBQ0MsTUFBQUEsZ0NBQWdDLEVBQUU7QUFBbkMsS0FDNUI7QUFBQTtBQUFBLFNBUEZDLGNBT0UsR0FQd0IsS0FPeEI7QUFBQSxTQU5GQyxPQU1FLEdBTnFCLElBQUlDLEdBQUosRUFNckI7QUFBQSxTQUxGQyxnQkFLRSxHQUxnQyxFQUtoQztBQUFBLFNBSkZDLGNBSUUsR0FKdUMsSUFBSUMsR0FBSixFQUl2QztBQUNBLFNBQUtDLE9BQUwsR0FBZVIsTUFBZjtBQUNEOzs7O1dBS0QsbUJBQVU7QUFJUixXQUFLRyxPQUFMLENBQWFNLE9BQWIsQ0FBcUJDLFlBQXJCO0FBQ0Q7OztXQUtELDhCQUNFQyxTQURGLEVBRUVDLFlBRkYsRUFHRUMsY0FIRixFQUlFQyxlQUpGLEVBWUVDLFdBWkYsRUFpQmlCO0FBQ2YsMEJBR0ksS0FBS1AsT0FIVDtBQUFBLFVBQ0VRLDJCQURGLGlCQUNFQSwyQkFERjtBQUFBLFVBRUVmLGdDQUZGLGlCQUVFQSxnQ0FGRjtBQUlBLFVBQU1nQixZQUFZLEdBQUdoQixnQ0FBZ0MsSUFBSSxJQUF6RDtBQUNBLFVBQU1pQix3QkFBd0IsR0FBR0QsWUFBWSxHQUN6Q2hCLGdDQUR5QyxHQUV6Q2UsMkJBRko7QUFHQW5CLE1BQUFBLFNBQVMsQ0FDUHFCLHdCQUF3QixJQUFJLElBQTVCLElBQ0dGLDJCQUEyQixJQUFJLElBQWhDLE1BQ0dmLGdDQUFnQyxJQUFJLElBRHZDLENBRkssRUFJUCx5RkFKTyxDQUFUO0FBTUEsVUFB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QUFPSSxPQUFPLElBQUlsRCx3QkFBbEI7QUFDRDtBQUNGOztBQUVELFNBQVNpRCxpQkFBVCxDQUNFdEMsR0FERixFQUVFRSxNQUZGLEVBR0VsQixjQUhGLEVBSVU7QUFDUixNQUFNd0QsYUFBYSxHQUFHQyxJQUFJLENBQUNDLEdBQUwsQ0FBU3hDLE1BQVQsRUFBaUJsQixjQUFqQixJQUFtQ3lELElBQUksQ0FBQ0UsR0FBTCxDQUFTM0MsR0FBVCxFQUFjLENBQWQsQ0FBekQ7QUFDQSxTQUFPeUMsSUFBSSxDQUFDRSxHQUFMLENBQVMsQ0FBVCxFQUFZSCxhQUFaLENBQVA7QUFDRDs7QUFFRCxTQUFTSixrQkFBVCxDQUNFcEMsR0FERixFQUVFRSxNQUZGLEVBR0VsQixjQUhGLEVBSVc7QUFDVCxTQUFPZ0IsR0FBRyxJQUFJLENBQVAsSUFBWUUsTUFBTSxJQUFJbEIsY0FBdEIsSUFBd0NrQixNQUFNLEdBQUdGLEdBQXhEO0FBQ0Q7O0FBRUQ0QyxNQUFNLENBQUNDLE9BQVAsR0FBaUIzRSxpQkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKiBAZm9ybWF0XG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBpbnZhcmlhbnQgPSByZXF1aXJlKCdpbnZhcmlhbnQnKTtcblxuZXhwb3J0IHR5cGUgVmlld1Rva2VuID0ge1xuICBpdGVtOiBhbnksXG4gIGtleTogc3RyaW5nLFxuICBpbmRleDogP251bWJlcixcbiAgaXNWaWV3YWJsZTogYm9vbGVhbixcbiAgc2VjdGlvbj86IGFueSxcbiAgLi4uXG59O1xuXG5leHBvcnQgdHlwZSBWaWV3YWJpbGl0eUNvbmZpZ0NhbGxiYWNrUGFpciA9IHtcbiAgdmlld2FiaWxpdHlDb25maWc6IFZpZXdhYmlsaXR5Q29uZmlnLFxuICBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkOiAoaW5mbzoge1xuICAgIHZpZXdhYmxlSXRlbXM6IEFycmF5PFZpZXdUb2tlbj4sXG4gICAgY2hhbmdlZDogQXJyYXk8Vmlld1Rva2VuPixcbiAgICAuLi5cbiAgfSkgPT4gdm9pZCxcbiAgLi4uXG59O1xuXG5leHBvcnQgdHlwZSBWaWV3YWJpbGl0eUNvbmZpZyA9IHt8XG4gIC8qKlxuICAgKiBNaW5pbXVtIGFtb3VudCBvZiB0aW1lIChpbiBtaWxsaXNlY29uZHMpIHRoYXQgYW4gaXRlbSBtdXN0IGJlIHBoeXNpY2FsbHkgdmlld2FibGUgYmVmb3JlIHRoZVxuICAgKiB2aWV3YWJpbGl0eSBjYWxsYmFjayB3aWxsIGJlIGZpcmVkLiBBIGhpZ2ggbnVtYmVyIG1lYW5zIHRoYXQgc2Nyb2xsaW5nIHRocm91Z2ggY29udGVudCB3aXRob3V0XG4gICAqIHN0b3BwaW5nIHdpbGwgbm90IG1hcmsgdGhlIGNvbnRlbnQgYXMgdmlld2FibGUuXG4gICAqL1xuICBtaW5pbXVtVmlld1RpbWU/OiBudW1iZXIsXG5cbiAgLyoqXG4gICAqIFBlcmNlbnQgb2Ygdmlld3BvcnQgdGhhdCBtdXN0IGJlIGNvdmVyZWQgZm9yIGEgcGFydGlhbGx5IG9jY2x1ZGVkIGl0ZW0gdG8gY291bnQgYXNcbiAgICogXCJ2aWV3YWJsZVwiLCAwLTEwMC4gRnVsbHkgdmlzaWJsZSBpdGVtcyBhcmUgYWx3YXlzIGNvbnNpZGVyZWQgdmlld2FibGUuIEEgdmFsdWUgb2YgMCBtZWFuc1xuICAgKiB0aGF0IGEgc2luZ2xlIHBpeGVsIGluIHRoZSB2aWV3cG9ydCBtYWtlcyB0aGUgaXRlbSB2aWV3YWJsZSwgYW5kIGEgdmFsdWUgb2YgMTAwIG1lYW5zIHRoYXRcbiAgICogYW4gaXRlbSBtdXN0IGJlIGVpdGhlciBlbnRpcmVseSB2aXNpYmxlIG9yIGNvdmVyIHRoZSBlbnRpcmUgdmlld3BvcnQgdG8gY291bnQgYXMgdmlld2FibGUuXG4gICAqL1xuICB2aWV3QXJlYUNvdmVyYWdlUGVyY2VudFRocmVzaG9sZD86IG51bWJlcixcblxuICAvKipcbiAgICogU2ltaWxhciB0byBgdmlld0FyZWFQZXJjZW50VGhyZXNob2xkYCwgYnV0IGNvbnNpZGVycyB0aGUgcGVyY2VudCBvZiB0aGUgaXRlbSB0aGF0IGlzIHZpc2libGUsXG4gICAqIHJhdGhlciB0aGFuIHRoZSBmcmFjdGlvbiBvZiB0aGUgdmlld2FibGUgYXJlYSBpdCBjb3ZlcnMuXG4gICAqL1xuICBpdGVtVmlzaWJsZVBlcmNlbnRUaHJlc2hvbGQ/OiBudW1iZXIsXG5cbiAgLyoqXG4gICAqIE5vdGhpbmcgaXMgY29uc2lkZXJlZCB2aWV3YWJsZSB1bnRpbCB0aGUgdXNlciBzY3JvbGxzIG9yIGByZWNvcmRJbnRlcmFjdGlvbmAgaXMgY2FsbGVkIGFmdGVyXG4gICAqIHJlbmRlci5cbiAgICovXG4gIHdhaXRGb3JJbnRlcmFjdGlvbj86IGJvb2xlYW4sXG58fTtcblxuLyoqXG4gKiBBIFV0aWxpdHkgY2xhc3MgZm9yIGNhbGN1bGF0aW5nIHZpZXdhYmxlIGl0ZW1zIGJhc2VkIG9uIGN1cnJlbnQgbWV0cmljcyBsaWtlIHNjcm9sbCBwb3NpdGlvbiBhbmRcbiAqIGxheW91dC5cbiAqXG4gKiBBbiBpdGVtIGlzIHNhaWQgdG8gYmUgaW4gYSBcInZpZXdhYmxlXCIgc3RhdGUgd2hlbiBhbnkgb2YgdGhlIGZvbGxvd2luZ1xuICogaXMgdHJ1ZSBmb3IgbG9uZ2VyIHRoYW4gYG1pbmltdW1WaWV3VGltZWAgbWlsbGlzZWNvbmRzIChhZnRlciBhbiBpbnRlcmFjdGlvbiBpZiBgd2FpdEZvckludGVyYWN0aW9uYFxuICogaXMgdHJ1ZSk6XG4gKlxuICogLSBPY2N1cHlpbmcgPj0gYHZpZXdBcmVhQ292ZXJhZ2VQZXJjZW50VGhyZXNob2xkYCBvZiB0aGUgdmlldyBhcmVhIFhPUiBmcmFjdGlvbiBvZiB0aGUgaXRlbVxuICogICB2aXNpYmxlIGluIHRoZSB2aWV3IGFyZWEgPj0gYGl0ZW1WaXNpYmxlUGVyY2VudFRocmVzaG9sZGAuXG4gKiAtIEVudGlyZWx5IHZpc2libGUgb24gc2NyZWVuXG4gKi9cbmNsYXNzIFZpZXdhYmlsaXR5SGVscGVyIHtcbiAgX2NvbmZpZzogVmlld2FiaWxpdHlDb25maWc7XG4gIF9oYXNJbnRlcmFjdGVkOiBib29sZWFuID0gZmFsc2U7XG4gIF90aW1lcnM6IFNldDxudW1iZXI+ID0gbmV3IFNldCgpO1xuICBfdmlld2FibGVJbmRpY2VzOiBBcnJheTxudW1iZXI+ID0gW107XG4gIF92aWV3YWJsZUl0ZW1zOiBNYXA8c3RyaW5nLCBWaWV3VG9rZW4+ID0gbmV3IE1hcCgpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGNvbmZpZzogVmlld2FiaWxpdHlDb25maWcgPSB7dmlld0FyZWFDb3ZlcmFnZVBlcmNlbnRUaHJlc2hvbGQ6IDB9LFxuICApIHtcbiAgICB0aGlzLl9jb25maWcgPSBjb25maWc7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW51cCwgZS5nLiBvbiB1bm1vdW50LiBDbGVhcnMgYW55IHBlbmRpbmcgdGltZXJzLlxuICAgKi9cbiAgZGlzcG9zZSgpIHtcbiAgICAvKiAkRmxvd0ZpeE1lW2luY29tcGF0aWJsZS1jYWxsXSAoPj0wLjYzLjAgc2l0ZT1yZWFjdF9uYXRpdmVfZmIpIFRoaXNcbiAgICAgKiBjb21tZW50IHN1cHByZXNzZXMgYW4gZXJyb3IgZm91bmQgd2hlbiBGbG93IHYwLjYzIHdhcyBkZXBsb3llZC4gVG8gc2VlXG4gICAgICogdGhlIGVycm9yIGRlbGV0ZSB0aGlzIGNvbW1lbnQgYW5kIHJ1biBGbG93LiAqL1xuICAgIHRoaXMuX3RpbWVycy5mb3JFYWNoKGNsZWFyVGltZW91dCk7XG4gIH1cblxuICAvKipcbiAgICogRGV0ZXJtaW5lcyB3aGljaCBpdGVtcyBhcmUgdmlld2FibGUgYmFzZWQgb24gdGhlIGN1cnJlbnQgbWV0cmljcyBhbmQgY29uZmlnLlxuICAgKi9cbiAgY29tcHV0ZVZpZXdhYmxlSXRlbXMoXG4gICAgaXRlbUNvdW50OiBudW1iZXIsXG4gICAgc2Nyb2xsT2Zmc2V0OiBudW1iZXIsXG4gICAgdmlld3BvcnRIZWlnaHQ6IG51bWJlcixcbiAgICBnZXRGcmFtZU1ldHJpY3M6IChcbiAgICAgIGluZGV4OiBudW1iZXIsXG4gICAgKSA9PiA/e1xuICAgICAgbGVuZ3RoOiBudW1iZXIsXG4gICAgICBvZmZzZXQ6IG51bWJlcixcbiAgICAgIC4uLlxuICAgIH0sXG4gICAgLy8gT3B0aW9uYWwgb3B0aW1pemF0aW9uIHRvIHJlZHVjZSB0aGUgc2NhbiBzaXplXG4gICAgcmVuZGVyUmFuZ2U/OiB7XG4gICAgICBmaXJzdDogbnVtYmVyLFxuICAgICAgbGFzdDogbnVtYmVyLFxuICAgICAgLi4uXG4gICAgfSxcbiAgKTogQXJyYXk8bnVtYmVyPiB7XG4gICAgY29uc3Qge1xuICAgICAgaXRlbVZpc2libGVQZXJjZW50VGhyZXNob2xkLFxuICAgICAgdmlld0FyZWFDb3ZlcmFnZVBlcmNlbnRUaHJlc2hvbGQsXG4gICAgfSA9IHRoaXMuX2NvbmZpZztcbiAgICBjb25zdCB2aWV3QXJlYU1vZGUgPSB2aWV3QXJlYUNvdmVyYWdlUGVyY2VudFRocmVzaG9sZCAhPSBudWxsO1xuICAgIGNvbnN0IHZpZXdhYmxlUGVyY2VudFRocmVzaG9sZCA9IHZpZXdBcmVhTW9kZVxuICAgICAgPyB2aWV3QXJlYUNvdmVyYWdlUGVyY2VudFRocmVzaG9sZFxuICAgICAgOiBpdGVtVmlzaWJsZVBlcmNlbnRUaHJlc2hvbGQ7XG4gICAgaW52YXJpYW50KFxuICAgICAgdmlld2FibGVQZXJjZW50VGhyZXNob2xkICE9IG51bGwgJiZcbiAgICAgICAgKGl0ZW1WaXNpYmxlUGVyY2VudFRocmVzaG9sZCAhPSBudWxsKSAhPT1cbiAgICAgICAgICAodmlld0FyZWFDb3ZlcmFnZVBlcmNlbnRUaHJlc2hvbGQgIT0gbnVsbCksXG4gICAgICAnTXVzdCBzZXQgZXhhY3RseSBvbmUgb2YgaXRlbVZpc2libGVQZXJjZW50VGhyZXNob2xkIG9yIHZpZXdBcmVhQ292ZXJhZ2VQZXJjZW50VGhyZXNob2xkJyxcbiAgICApO1xuICAgIGNvbnN0IHZpZXdhYmxlSW5kaWNlcyA9IFtdO1xuICAgIGlmIChpdGVtQ291bnQgPT09IDApIHtcbiAgICAgIHJldHVybiB2aWV3YWJsZUluZGljZXM7XG4gICAgfVxuICAgIGxldCBmaXJzdFZpc2libGUgPSAtMTtcbiAgICBjb25zdCB7Zmlyc3QsIGxhc3R9ID0gcmVuZGVyUmFuZ2UgfHwge2ZpcnN0OiAwLCBsYXN0OiBpdGVtQ291bnQgLSAxfTtcbiAgICBpZiAobGFzdCA+PSBpdGVtQ291bnQpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgJ0ludmFsaWQgcmVuZGVyIHJhbmdlIGNvbXB1dGluZyB2aWV3YWJpbGl0eSAnICtcbiAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7cmVuZGVyUmFuZ2UsIGl0ZW1Db3VudH0pLFxuICAgICAgKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgZm9yIChsZXQgaWR4ID0gZmlyc3Q7IGlkeCA8PSBsYXN0OyBpZHgrKykge1xuICAgICAgY29uc3QgbWV0cmljcyA9IGdldEZyYW1lTWV0cmljcyhpZHgpO1xuICAgICAgaWYgKCFtZXRyaWNzKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgdG9wID0gbWV0cmljcy5vZmZzZXQgLSBzY3JvbGxPZmZzZXQ7XG4gICAgICBjb25zdCBib3R0b20gPSB0b3AgKyBtZXRyaWNzLmxlbmd0aDtcbiAgICAgIGlmICh0b3AgPCB2aWV3cG9ydEhlaWdodCAmJiBib3R0b20gPiAwKSB7XG4gICAgICAgIGZpcnN0VmlzaWJsZSA9IGlkeDtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIF9pc1ZpZXdhYmxlKFxuICAgICAgICAgICAgdmlld0FyZWFNb2RlLFxuICAgICAgICAgICAgdmlld2FibGVQZXJjZW50VGhyZXNob2xkLFxuICAgICAgICAgICAgdG9wLFxuICAgICAgICAgICAgYm90dG9tLFxuICAgICAgICAgICAgdmlld3BvcnRIZWlnaHQsXG4gICAgICAgICAgICBtZXRyaWNzLmxlbmd0aCxcbiAgICAgICAgICApXG4gICAgICAgICkge1xuICAgICAgICAgIHZpZXdhYmxlSW5kaWNlcy5wdXNoKGlkeCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSBpZiAoZmlyc3RWaXNpYmxlID49IDApIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB2aWV3YWJsZUluZGljZXM7XG4gIH1cblxuICAvKipcbiAgICogRmlndXJlcyBvdXQgd2hpY2ggaXRlbXMgYXJlIHZpZXdhYmxlIGFuZCBob3cgdGhhdCBoYXMgY2hhbmdlZCBmcm9tIGJlZm9yZSBhbmQgY2FsbHNcbiAgICogYG9uVmlld2FibGVJdGVtc0NoYW5nZWRgIGFzIGFwcHJvcHJpYXRlLlxuICAgKi9cbiAgb25VcGRhdGUoXG4gICAgaXRlbUNvdW50OiBudW1iZXIsXG4gICAgc2Nyb2xsT2Zmc2V0OiBudW1iZXIsXG4gICAgdmlld3BvcnRIZWlnaHQ6IG51bWJlcixcbiAgICBnZXRGcmFtZU1ldHJpY3M6IChcbiAgICAgIGluZGV4OiBudW1iZXIsXG4gICAgKSA9PiA/e1xuICAgICAgbGVuZ3RoOiBudW1iZXIsXG4gICAgICBvZmZzZXQ6IG51bWJlcixcbiAgICAgIC4uLlxuICAgIH0sXG4gICAgY3JlYXRlVmlld1Rva2VuOiAoaW5kZXg6IG51bWJlciwgaXNWaWV3YWJsZTogYm9vbGVhbikgPT4gVmlld1Rva2VuLFxuICAgIG9uVmlld2FibGVJdGVtc0NoYW5nZWQ6ICh7XG4gICAgICB2aWV3YWJsZUl0ZW1zOiBBcnJheTxWaWV3VG9rZW4+LFxuICAgICAgY2hhbmdlZDogQXJyYXk8Vmlld1Rva2VuPixcbiAgICAgIC4uLlxuICAgIH0pID0+IHZvaWQsXG4gICAgLy8gT3B0aW9uYWwgb3B0aW1pemF0aW9uIHRvIHJlZHVjZSB0aGUgc2NhbiBzaXplXG4gICAgcmVuZGVyUmFuZ2U/OiB7XG4gICAgICBmaXJzdDogbnVtYmVyLFxuICAgICAgbGFzdDogbnVtYmVyLFxuICAgICAgLi4uXG4gICAgfSxcbiAgKTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgKHRoaXMuX2NvbmZpZy53YWl0Rm9ySW50ZXJhY3Rpb24gJiYgIXRoaXMuX2hhc0ludGVyYWN0ZWQpIHx8XG4gICAgICBpdGVtQ291bnQgPT09IDAgfHxcbiAgICAgICFnZXRGcmFtZU1ldHJpY3MoMClcbiAgICApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbGV0IHZpZXdhYmxlSW5kaWNlcyA9IFtdO1xuICAgIGlmIChpdGVtQ291bnQpIHtcbiAgICAgIHZpZXdhYmxlSW5kaWNlcyA9IHRoaXMuY29tcHV0ZVZpZXdhYmxlSXRlbXMoXG4gICAgICAgIGl0ZW1Db3VudCxcbiAgICAgICAgc2Nyb2xsT2Zmc2V0LFxuICAgICAgICB2aWV3cG9ydEhlaWdodCxcbiAgICAgICAgZ2V0RnJhbWVNZXRyaWNzLFxuICAgICAgICByZW5kZXJSYW5nZSxcbiAgICAgICk7XG4gICAgfVxuICAgIGlmIChcbiAgICAgIHRoaXMuX3ZpZXdhYmxlSW5kaWNlcy5sZW5ndGggPT09IHZpZXdhYmxlSW5kaWNlcy5sZW5ndGggJiZcbiAgICAgIHRoaXMuX3ZpZXdhYmxlSW5kaWNlcy5ldmVyeSgodiwgaWkpID0+IHYgPT09IHZpZXdhYmxlSW5kaWNlc1tpaV0pXG4gICAgKSB7XG4gICAgICAvLyBXZSBtaWdodCBnZXQgYSBsb3Qgb2Ygc2Nyb2xsIGV2ZW50cyB3aGVyZSB2aXNpYmlsaXR5IGRvZXNuJ3QgY2hhbmdlIGFuZCB3ZSBkb24ndCB3YW50IHRvIGRvXG4gICAgICAvLyBleHRyYSB3b3JrIGluIHRob3NlIGNhc2VzLlxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl92aWV3YWJsZUluZGljZXMgPSB2aWV3YWJsZUluZGljZXM7XG4gICAgaWYgKHRoaXMuX2NvbmZpZy5taW5pbXVtVmlld1RpbWUpIHtcbiAgICAgIGNvbnN0IGhhbmRsZSA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAvKiAkRmxvd0ZpeE1lW2luY29tcGF0aWJsZS1jYWxsXSAoPj0wLjYzLjAgc2l0ZT1yZWFjdF9uYXRpdmVfZmIpIFRoaXNcbiAgICAgICAgICogY29tbWVudCBzdXBwcmVzc2VzIGFuIGVycm9yIGZvdW5kIHdoZW4gRmxvdyB2MC42MyB3YXMgZGVwbG95ZWQuIFRvXG4gICAgICAgICAqIHNlZSB0aGUgZXJyb3IgZGVsZXRlIHRoaXMgY29tbWVudCBhbmQgcnVuIEZsb3cuICovXG4gICAgICAgIHRoaXMuX3RpbWVycy5kZWxldGUoaGFuZGxlKTtcbiAgICAgICAgdGhpcy5fb25VcGRhdGVTeW5jKFxuICAgICAgICAgIHZpZXdhYmxlSW5kaWNlcyxcbiAgICAgICAgICBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkLFxuICAgICAgICAgIGNyZWF0ZVZpZXdUb2tlbixcbiAgICAgICAgKTtcbiAgICAgIH0sIHRoaXMuX2NvbmZpZy5taW5pbXVtVmlld1RpbWUpO1xuICAgICAgLyogJEZsb3dGaXhNZVtpbmNvbXBhdGlibGUtY2FsbF0gKD49MC42My4wIHNpdGU9cmVhY3RfbmF0aXZlX2ZiKSBUaGlzXG4gICAgICAgKiBjb21tZW50IHN1cHByZXNzZXMgYW4gZXJyb3IgZm91bmQgd2hlbiBGbG93IHYwLjYzIHdhcyBkZXBsb3llZC4gVG8gc2VlXG4gICAgICAgKiB0aGUgZXJyb3IgZGVsZXRlIHRoaXMgY29tbWVudCBhbmQgcnVuIEZsb3cuICovXG4gICAgICB0aGlzLl90aW1lcnMuYWRkKGhhbmRsZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX29uVXBkYXRlU3luYyhcbiAgICAgICAgdmlld2FibGVJbmRpY2VzLFxuICAgICAgICBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkLFxuICAgICAgICBjcmVhdGVWaWV3VG9rZW4sXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBjbGVhbi11cCBjYWNoZWQgX3ZpZXdhYmxlSW5kaWNlcyB0byBldmFsdWF0ZSBjaGFuZ2VkIGl0ZW1zIG9uIG5leHQgdXBkYXRlXG4gICAqL1xuICByZXNldFZpZXdhYmxlSW5kaWNlcygpIHtcbiAgICB0aGlzLl92aWV3YWJsZUluZGljZXMgPSBbXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWNvcmRzIHRoYXQgYW4gaW50ZXJhY3Rpb24gaGFzIGhhcHBlbmVkIGV2ZW4gaWYgdGhlcmUgaGFzIGJlZW4gbm8gc2Nyb2xsLlxuICAgKi9cbiAgcmVjb3JkSW50ZXJhY3Rpb24oKSB7XG4gICAgdGhpcy5faGFzSW50ZXJhY3RlZCA9IHRydWU7XG4gIH1cblxuICBfb25VcGRhdGVTeW5jKFxuICAgIHZpZXdhYmxlSW5kaWNlc1RvQ2hlY2ssXG4gICAgb25WaWV3YWJsZUl0ZW1zQ2hhbmdlZCxcbiAgICBjcmVhdGVWaWV3VG9rZW4sXG4gICkge1xuICAgIC8vIEZpbHRlciBvdXQgaW5kaWNlcyB0aGF0IGhhdmUgZ29uZSBvdXQgb2YgdmlldyBzaW5jZSB0aGlzIGNhbGwgd2FzIHNjaGVkdWxlZC5cbiAgICB2aWV3YWJsZUluZGljZXNUb0NoZWNrID0gdmlld2FibGVJbmRpY2VzVG9DaGVjay5maWx0ZXIoaWkgPT5cbiAgICAgIHRoaXMuX3ZpZXdhYmxlSW5kaWNlcy5pbmNsdWRlcyhpaSksXG4gICAgKTtcbiAgICBjb25zdCBwcmV2SXRlbXMgPSB0aGlzLl92aWV3YWJsZUl0ZW1zO1xuICAgIGNvbnN0IG5leHRJdGVtcyA9IG5ldyBNYXAoXG4gICAgICB2aWV3YWJsZUluZGljZXNUb0NoZWNrLm1hcChpaSA9PiB7XG4gICAgICAgIGNvbnN0IHZpZXdhYmxlID0gY3JlYXRlVmlld1Rva2VuKGlpLCB0cnVlKTtcbiAgICAgICAgcmV0dXJuIFt2aWV3YWJsZS5rZXksIHZpZXdhYmxlXTtcbiAgICAgIH0pLFxuICAgICk7XG5cbiAgICBjb25zdCBjaGFuZ2VkID0gW107XG4gICAgZm9yIChjb25zdCBba2V5LCB2aWV3YWJsZV0gb2YgbmV4dEl0ZW1zKSB7XG4gICAgICBpZiAoIXByZXZJdGVtcy5oYXMoa2V5KSkge1xuICAgICAgICBjaGFuZ2VkLnB1c2godmlld2FibGUpO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZpZXdhYmxlXSBvZiBwcmV2SXRlbXMpIHtcbiAgICAgIGlmICghbmV4dEl0ZW1zLmhhcyhrZXkpKSB7XG4gICAgICAgIGNoYW5nZWQucHVzaCh7Li4udmlld2FibGUsIGlzVmlld2FibGU6IGZhbHNlfSk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChjaGFuZ2VkLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuX3ZpZXdhYmxlSXRlbXMgPSBuZXh0SXRlbXM7XG4gICAgICBvblZpZXdhYmxlSXRlbXNDaGFuZ2VkKHtcbiAgICAgICAgdmlld2FibGVJdGVtczogQXJyYXkuZnJvbShuZXh0SXRlbXMudmFsdWVzKCkpLFxuICAgICAgICBjaGFuZ2VkLFxuICAgICAgICB2aWV3YWJpbGl0eUNvbmZpZzogdGhpcy5fY29uZmlnLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIF9pc1ZpZXdhYmxlKFxuICB2aWV3QXJlYU1vZGU6IGJvb2xlYW4sXG4gIHZpZXdhYmxlUGVyY2VudFRocmVzaG9sZDogbnVtYmVyLFxuICB0b3A6IG51bWJlcixcbiAgYm90dG9tOiBudW1iZXIsXG4gIHZpZXdwb3J0SGVpZ2h0OiBudW1iZXIsXG4gIGl0ZW1MZW5ndGg6IG51bWJlcixcbik6IGJvb2xlYW4ge1xuICBpZiAoX2lzRW50aXJlbHlWaXNpYmxlKHRvcCwgYm90dG9tLCB2aWV3cG9ydEhlaWdodCkpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBwaXhlbHMgPSBfZ2V0UGl4ZWxzVmlzaWJsZSh0b3AsIGJvdHRvbSwgdmlld3BvcnRIZWlnaHQpO1xuICAgIGNvbnN0IHBlcmNlbnQgPVxuICAgICAgMTAwICogKHZpZXdBcmVhTW9kZSA/IHBpeGVscyAvIHZpZXdwb3J0SGVpZ2h0IDogcGl4ZWxzIC8gaXRlbUxlbmd0aCk7XG4gICAgcmV0dXJuIHBlcmNlbnQgPj0gdmlld2FibGVQZXJjZW50VGhyZXNob2xkO1xuICB9XG59XG5cbmZ1bmN0aW9uIF9nZXRQaXhlbHNWaXNpYmxlKFxuICB0b3A6IG51bWJlcixcbiAgYm90dG9tOiBudW1iZXIsXG4gIHZpZXdwb3J0SGVpZ2h0OiBudW1iZXIsXG4pOiBudW1iZXIge1xuICBjb25zdCB2aXNpYmxlSGVpZ2h0ID0gTWF0aC5taW4oYm90dG9tLCB2aWV3cG9ydEhlaWdodCkgLSBNYXRoLm1heCh0b3AsIDApO1xuICByZXR1cm4gTWF0aC5tYXgoMCwgdmlzaWJsZUhlaWdodCk7XG59XG5cbmZ1bmN0aW9uIF9pc0VudGlyZWx5VmlzaWJsZShcbiAgdG9wOiBudW1iZXIsXG4gIGJvdHRvbTogbnVtYmVyLFxuICB2aWV3cG9ydEhlaWdodDogbnVtYmVyLFxuKTogYm9vbGVhbiB7XG4gIHJldHVybiB0b3AgPj0gMCAmJiBib3R0b20gPD0gdmlld3BvcnRIZWlnaHQgJiYgYm90dG9tID4gdG9wO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFZpZXdhYmlsaXR5SGVscGVyO1xuIl19