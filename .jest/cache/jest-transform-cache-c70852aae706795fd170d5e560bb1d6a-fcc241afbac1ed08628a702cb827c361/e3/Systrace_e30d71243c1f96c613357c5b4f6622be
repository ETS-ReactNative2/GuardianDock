7fd691a25c9bbc2698a745550bdaf6ee
'use strict';

var invariant = require('invariant');

var TRACE_TAG_REACT_APPS = 1 << 17;
var TRACE_TAG_JS_VM_CALLS = 1 << 27;
var _enabled = false;
var _asyncCookie = 0;
var _markStack = [];

var _markStackIndex = -1;

var _canInstallReactHook = false;
var REACT_MARKER = "\u269B";
var userTimingPolyfill = __DEV__ ? {
  mark: function mark(markName) {
    if (_enabled) {
      _markStackIndex++;
      _markStack[_markStackIndex] = markName;
      var systraceLabel = markName;

      if (markName[0] === REACT_MARKER) {
        var indexOfId = markName.lastIndexOf(' (#');
        var cutoffIndex = indexOfId !== -1 ? indexOfId : markName.length;
        systraceLabel = markName.slice(2, cutoffIndex);
      }

      Systrace.beginEvent(systraceLabel);
    }
  },
  measure: function measure(measureName, startMark, endMark) {
    if (_enabled) {
      invariant(typeof measureName === 'string' && typeof startMark === 'string' && typeof endMark === 'undefined', 'Only performance.measure(string, string) overload is supported.');
      var topMark = _markStack[_markStackIndex];
      invariant(startMark === topMark, 'There was a mismatching performance.measure() call. ' + 'Expected "%s" but got "%s."', topMark, startMark);
      _markStackIndex--;
      Systrace.endEvent();
    }
  },
  clearMarks: function clearMarks(markName) {
    if (_enabled) {
      if (_markStackIndex === -1) {
        return;
      }

      if (markName === _markStack[_markStackIndex]) {
        if (userTimingPolyfill != null) {
          userTimingPolyfill.measure(markName, markName);
        }
      }
    }
  },
  clearMeasures: function clearMeasures() {}
} : null;

function installPerformanceHooks(polyfill) {
  if (polyfill) {
    if (global.performance === undefined) {
      global.performance = {};
    }

    Object.keys(polyfill).forEach(function (methodName) {
      if (typeof global.performance[methodName] !== 'function') {
        global.performance[methodName] = polyfill[methodName];
      }
    });
  }
}

var Systrace = {
  installReactHook: function installReactHook() {
    if (_enabled) {
      if (__DEV__) {
        installPerformanceHooks(userTimingPolyfill);
      }
    }

    _canInstallReactHook = true;
  },
  setEnabled: function setEnabled(enabled) {
    if (_enabled !== enabled) {
      if (__DEV__) {
        if (enabled) {
          global.nativeTraceBeginLegacy && global.nativeTraceBeginLegacy(TRACE_TAG_JS_VM_CALLS);
        } else {
          global.nativeTraceEndLegacy && global.nativeTraceEndLegacy(TRACE_TAG_JS_VM_CALLS);
        }

        if (_canInstallReactHook) {
          if (enabled) {
            installPerformanceHooks(userTimingPolyfill);
          }
        }
      }

      _enabled = enabled;
    }
  },
  isEnabled: function isEnabled() {
    return _enabled;
  },
  beginEvent: function beginEvent(profileName, args) {
    if (_enabled) {
      var profileNameString = typeof profileName === 'function' ? profileName() : profileName;
      global.nativeTraceBeginSection(TRACE_TAG_REACT_APPS, profileNameString, args);
    }
  },
  endEvent: function endEvent() {
    if (_enabled) {
      global.nativeTraceEndSection(TRACE_TAG_REACT_APPS);
    }
  },
  beginAsyncEvent: function beginAsyncEvent(profileName) {
    var cookie = _asyncCookie;

    if (_enabled) {
      _asyncCookie++;
      var profileNameString = typeof profileName === 'function' ? profileName() : profileName;
      global.nativeTraceBeginAsyncSection(TRACE_TAG_REACT_APPS, profileNameString, cookie);
    }

    return cookie;
  },
  endAsyncEvent: function endAsyncEvent(profileName, cookie) {
    if (_enabled) {
      var profileNameString = typeof profileName === 'function' ? profileName() : profileName;
      global.nativeTraceEndAsyncSection(TRACE_TAG_REACT_APPS, profileNameString, cookie);
    }
  },
  counterEvent: function counterEvent(profileName, value) {
    if (_enabled) {
      var profileNameString = typeof profileName === 'function' ? profileName() : profileName;
      global.nativeTraceCounter && global.nativeTraceCounter(TRACE_TAG_REACT_APPS, profileNameString, value);
    }
  }
};

if (__DEV__) {
  global[(global.__METRO_GLOBAL_PREFIX__ || '') + '__SYSTRACE'] = Systrace;
}

module.exports = Systrace;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlN5c3RyYWNlLmpzIl0sIm5hbWVzIjpbImludmFyaWFudCIsInJlcXVpcmUiLCJUUkFDRV9UQUdfUkVBQ1RfQVBQUyIsIlRSQUNFX1RBR19KU19WTV9DQUxMUyIsIl9lbmFibGVkIiwiX2FzeW5jQ29va2llIiwiX21hcmtTdGFjayIsIl9tYXJrU3RhY2tJbmRleCIsIl9jYW5JbnN0YWxsUmVhY3RIb29rIiwiUkVBQ1RfTUFSS0VSIiwidXNlclRpbWluZ1BvbHlmaWxsIiwiX19ERVZfXyIsIm1hcmsiLCJtYXJrTmFtZSIsInN5c3RyYWNlTGFiZWwiLCJpbmRleE9mSWQiLCJsYXN0SW5kZXhPZiIsImN1dG9mZkluZGV4IiwibGVuZ3RoIiwic2xpY2UiLCJTeXN0cmFjZSIsImJlZ2luRXZlbnQiLCJtZWFzdXJlIiwibWVhc3VyZU5hbWUiLCJzdGFydE1hcmsiLCJlbmRNYXJrIiwidG9wTWFyayIsImVuZEV2ZW50IiwiY2xlYXJNYXJrcyIsImNsZWFyTWVhc3VyZXMiLCJpbnN0YWxsUGVyZm9ybWFuY2VIb29rcyIsInBvbHlmaWxsIiwiZ2xvYmFsIiwicGVyZm9ybWFuY2UiLCJ1bmRlZmluZWQiLCJPYmplY3QiLCJrZXlzIiwiZm9yRWFjaCIsIm1ldGhvZE5hbWUiLCJpbnN0YWxsUmVhY3RIb29rIiwic2V0RW5hYmxlZCIsImVuYWJsZWQiLCJuYXRpdmVUcmFjZUJlZ2luTGVnYWN5IiwibmF0aXZlVHJhY2VFbmRMZWdhY3kiLCJpc0VuYWJsZWQiLCJwcm9maWxlTmFtZSIsImFyZ3MiLCJwcm9maWxlTmFtZVN0cmluZyIsIm5hdGl2ZVRyYWNlQmVnaW5TZWN0aW9uIiwibmF0aXZlVHJhY2VFbmRTZWN0aW9uIiwiYmVnaW5Bc3luY0V2ZW50IiwiY29va2llIiwibmF0aXZlVHJhY2VCZWdpbkFzeW5jU2VjdGlvbiIsImVuZEFzeW5jRXZlbnQiLCJuYXRpdmVUcmFjZUVuZEFzeW5jU2VjdGlvbiIsImNvdW50ZXJFdmVudCIsInZhbHVlIiwibmF0aXZlVHJhY2VDb3Vu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RUFBYztBQUNaLFVBQU0yQyxpQkFBaUIsR0FDckIsT0FBT0YsV0FBUCxLQUF1QixVQUF2QixHQUFvQ0EsV0FBVyxFQUEvQyxHQUFvREEsV0FEdEQ7QUFFQWIsTUFBQUEsTUFBTSxDQUFDeUIsa0JBQVAsSUFDRXpCLE1BQU0sQ0FBQ3lCLGtCQUFQLENBQ0V2RCxvQkFERixFQUVFNkMsaUJBRkYsRUFHRVMsS0FIRixDQURGO0FBTUQ7QUFDRjtBQXhHYyxDQUFqQjs7QUEyR0EsSUFBSTdDLE9BQUosRUFBYTtBQUdYcUIsRUFBQUEsTUFBTSxDQUFDLENBQUNBLE1BQU0sQ0FBQzBCLHVCQUFQLElBQWtDLEVBQW5DLElBQXlDLFlBQTFDLENBQU4sR0FBZ0V0QyxRQUFoRTtBQUNEOztBQUVEdUMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCeEMsUUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93IHN0cmljdFxuICogQGZvcm1hdFxuICovXG5cbid1c2Ugc3RyaWN0JztcblxuY29uc3QgaW52YXJpYW50ID0gcmVxdWlyZSgnaW52YXJpYW50Jyk7XG5cbmNvbnN0IFRSQUNFX1RBR19SRUFDVF9BUFBTID0gMSA8PCAxNzsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1iaXR3aXNlXG5jb25zdCBUUkFDRV9UQUdfSlNfVk1fQ0FMTFMgPSAxIDw8IDI3OyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWJpdHdpc2VcblxubGV0IF9lbmFibGVkID0gZmFsc2U7XG5sZXQgX2FzeW5jQ29va2llID0gMDtcbmNvbnN0IF9tYXJrU3RhY2sgPSBbXTtcbmxldCBfbWFya1N0YWNrSW5kZXggPSAtMTtcbmxldCBfY2FuSW5zdGFsbFJlYWN0SG9vayA9IGZhbHNlO1xuXG4vLyBJbXBsZW1lbnRzIGEgc3Vic2V0IG9mIFVzZXIgVGltaW5nIEFQSSBuZWNlc3NhcnkgZm9yIFJlYWN0IG1lYXN1cmVtZW50cy5cbi8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9Vc2VyX1RpbWluZ19BUElcbmNvbnN0IFJFQUNUX01BUktFUiA9ICdcXHUyNjlCJztcbmNvbnN0IHVzZXJUaW1pbmdQb2x5ZmlsbCA9IF9fREVWX19cbiAgPyB7XG4gICAgICBtYXJrKG1hcmtOYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKF9lbmFibGVkKSB7XG4gICAgICAgICAgX21hcmtTdGFja0luZGV4Kys7XG4gICAgICAgICAgX21hcmtTdGFja1tfbWFya1N0YWNrSW5kZXhdID0gbWFya05hbWU7XG4gICAgICAgICAgbGV0IHN5c3RyYWNlTGFiZWwgPSBtYXJrTmFtZTtcbiAgICAgICAgICAvLyBTaW5jZSBwZXJmIG1lYXN1cmVtZW50cyBhcmUgYSBzaGFyZWQgbmFtZXNwYWNlIGluIFVzZXIgVGltaW5nIEFQSSxcbiAgICAgICAgICAvLyB3ZSBwcmVmaXggYWxsIFJlYWN0IHJlc3VsdHMgd2l0aCBhIFJlYWN0IGVtb2ppLlxuICAgICAgICAgIGlmIChtYXJrTmFtZVswXSA9PT0gUkVBQ1RfTUFSS0VSKSB7XG4gICAgICAgICAgICAvLyBUaGlzIGlzIGNvbWluZyBmcm9tIFJlYWN0LlxuICAgICAgICAgICAgLy8gUmVtb3ZpbmcgY29tcG9uZW50IElEcyBrZWVwcyB0cmFjZSBjb2xvcnMgc3RhYmxlLlxuICAgICAgICAgICAgY29uc3QgaW5kZXhPZklkID0gbWFya05hbWUubGFzdEluZGV4T2YoJyAoIycpO1xuICAgICAgICAgICAgY29uc3QgY3V0b2ZmSW5kZXggPSBpbmRleE9mSWQgIT09IC0xID8gaW5kZXhPZklkIDogbWFya05hbWUubGVuZ3RoO1xuICAgICAgICAgICAgLy8gQWxzbyBjdXQgb2ZmIHRoZSBlbW9qaSBiZWNhdXNlIGl0IGJyZWFrcyBTeXN0cmFjZVxuICAgICAgICAgICAgc3lzdHJhY2VMYWJlbCA9IG1hcmtOYW1lLnNsaWNlKDIsIGN1dG9mZkluZGV4KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgU3lzdHJhY2UuYmVnaW5FdmVudChzeXN0cmFjZUxhYmVsKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIG1lYXN1cmUobWVhc3VyZU5hbWU6IHN0cmluZywgc3RhcnRNYXJrOiA/c3RyaW5nLCBlbmRNYXJrOiA/c3RyaW5nKSB7XG4gICAgICAgIGlmIChfZW5hYmxlZCkge1xuICAgICAgICAgIGludmFyaWFudChcbiAgICAgICAgICAgIHR5cGVvZiBtZWFzdXJlTmFtZSA9PT0gJ3N0cmluZycgJiZcbiAgICAgICAgICAgICAgdHlwZW9mIHN0YXJ0TWFyayA9PT0gJ3N0cmluZycgJiZcbiAgICAgICAgICAgICAgdHlwZW9mIGVuZE1hcmsgPT09ICd1bmRlZmluZWQnLFxuICAgICAgICAgICAgJ09ubHkgcGVyZm9ybWFuY2UubWVhc3VyZShzdHJpbmcsIHN0cmluZykgb3ZlcmxvYWQgaXMgc3VwcG9ydGVkLicsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCB0b3BNYXJrID0gX21hcmtTdGFja1tfbWFya1N0YWNrSW5kZXhdO1xuICAgICAgICAgIGludmFyaWFudChcbiAgICAgICAgICAgIHN0YXJ0TWFyayA9PT0gdG9wTWFyayxcbiAgICAgICAgICAgICdUaGVyZSB3YXMgYSBtaXNtYXRjaGluZyBwZXJmb3JtYW5jZS5tZWFzdXJlKCkgY2FsbC4gJyArXG4gICAgICAgICAgICAgICdFeHBlY3RlZCBcIiVzXCIgYnV0IGdvdCBcIiVzLlwiJyxcbiAgICAgICAgICAgIHRvcE1hcmssXG4gICAgICAgICAgICBzdGFydE1hcmssXG4gICAgICAgICAgKTtcbiAgICAgICAgICBfbWFya1N0YWNrSW5kZXgtLTtcbiAgICAgICAgICAvLyBXZSBjYW4ndCB1c2UgbW9yZSBkZXNjcmlwdGl2ZSBtZWFzdXJlTmFtZSBiZWNhdXNlIFN5c3RyYWNlIGRvZXNuJ3RcbiAgICAgICAgICAvLyBsZXQgdXMgZWRpdCBsYWJlbHMgcG9zdCBmYWN0dW0uXG4gICAgICAgICAgU3lzdHJhY2UuZW5kRXZlbnQoKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGNsZWFyTWFya3MobWFya05hbWU6IHN0cmluZykge1xuICAgICAgICBpZiAoX2VuYWJsZWQpIHtcbiAgICAgICAgICBpZiAoX21hcmtTdGFja0luZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAobWFya05hbWUgPT09IF9tYXJrU3RhY2tbX21hcmtTdGFja0luZGV4XSkge1xuICAgICAgICAgICAgLy8gUmVhY3QgdXNlcyB0aGlzIGZvciBcImNhbmNlbGxpbmdcIiBzdGFydGVkIG1lYXN1cmVtZW50cy5cbiAgICAgICAgICAgIC8vIFN5c3RyYWNlIGRvZXNuJ3Qgc3VwcG9ydCBkZWxldGluZyBtZWFzdXJlbWVudHMsIHNvIHdlIGp1c3Qgc3RvcCB0aGVtLlxuICAgICAgICAgICAgaWYgKHVzZXJUaW1pbmdQb2x5ZmlsbCAhPSBudWxsKSB7XG4gICAgICAgICAgICAgIHVzZXJUaW1pbmdQb2x5ZmlsbC5tZWFzdXJlKG1hcmtOYW1lLCBtYXJrTmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgY2xlYXJNZWFzdXJlcygpIHtcbiAgICAgICAgLy8gUmVhY3QgY2FsbHMgdGhpcyB0byBhdm9pZCBtZW1vcnkgbGVha3MgaW4gYnJvd3NlcnMsIGJ1dCB3ZSBkb24ndCBrZWVwXG4gICAgICAgIC8vIG1lYXN1cmVtZW50cyBhbnl3YXkuXG4gICAgICB9LFxuICAgIH1cbiAgOiBudWxsO1xuXG5mdW5jdGlvbiBpbnN0YWxsUGVyZm9ybWFuY2VIb29rcyhwb2x5ZmlsbCkge1xuICBpZiAocG9seWZpbGwpIHtcbiAgICBpZiAoZ2xvYmFsLnBlcmZvcm1hbmNlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGdsb2JhbC5wZXJmb3JtYW5jZSA9IHt9O1xuICAgIH1cblxuICAgIE9iamVjdC5rZXlzKHBvbHlmaWxsKS5mb3JFYWNoKG1ldGhvZE5hbWUgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBnbG9iYWwucGVyZm9ybWFuY2VbbWV0aG9kTmFtZV0gIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgZ2xvYmFsLnBlcmZvcm1hbmNlW21ldGhvZE5hbWVdID0gcG9seWZpbGxbbWV0aG9kTmFtZV07XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxuY29uc3QgU3lzdHJhY2UgPSB7XG4gIGluc3RhbGxSZWFjdEhvb2soKSB7XG4gICAgaWYgKF9lbmFibGVkKSB7XG4gICAgICBpZiAoX19ERVZfXykge1xuICAgICAgICBpbnN0YWxsUGVyZm9ybWFuY2VIb29rcyh1c2VyVGltaW5nUG9seWZpbGwpO1xuICAgICAgfVxuICAgIH1cbiAgICBfY2FuSW5zdGFsbFJlYWN0SG9vayA9IHRydWU7XG4gIH0sXG5cbiAgc2V0RW5hYmxlZChlbmFibGVkOiBib29sZWFuKSB7XG4gICAgaWYgKF9lbmFibGVkICE9PSBlbmFibGVkKSB7XG4gICAgICBpZiAoX19ERVZfXykge1xuICAgICAgICBpZiAoZW5hYmxlZCkge1xuICAgICAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUJlZ2luTGVnYWN5ICYmXG4gICAgICAgICAgICBnbG9iYWwubmF0aXZlVHJhY2VCZWdpbkxlZ2FjeShUUkFDRV9UQUdfSlNfVk1fQ0FMTFMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUVuZExlZ2FjeSAmJlxuICAgICAgICAgICAgZ2xvYmFsLm5hdGl2ZVRyYWNlRW5kTGVnYWN5KFRSQUNFX1RBR19KU19WTV9DQUxMUyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF9jYW5JbnN0YWxsUmVhY3RIb29rKSB7XG4gICAgICAgICAgaWYgKGVuYWJsZWQpIHtcbiAgICAgICAgICAgIGluc3RhbGxQZXJmb3JtYW5jZUhvb2tzKHVzZXJUaW1pbmdQb2x5ZmlsbCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBfZW5hYmxlZCA9IGVuYWJsZWQ7XG4gICAgfVxuICB9LFxuXG4gIGlzRW5hYmxlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gX2VuYWJsZWQ7XG4gIH0sXG5cbiAgLyoqXG4gICAqIGJlZ2luRXZlbnQvZW5kRXZlbnQgZm9yIHN0YXJ0aW5nIGFuZCB0aGVuIGVuZGluZyBhIHByb2ZpbGUgd2l0aGluIHRoZSBzYW1lIGNhbGwgc3RhY2sgZnJhbWVcbiAgICoqL1xuICBiZWdpbkV2ZW50KFxuICAgIHByb2ZpbGVOYW1lPzogc3RyaW5nIHwgKCgpID0+IHN0cmluZyksXG4gICAgYXJncz86IHtbc3RyaW5nXTogc3RyaW5nLCAuLi59LFxuICApIHtcbiAgICBpZiAoX2VuYWJsZWQpIHtcbiAgICAgIGNvbnN0IHByb2ZpbGVOYW1lU3RyaW5nID1cbiAgICAgICAgdHlwZW9mIHByb2ZpbGVOYW1lID09PSAnZnVuY3Rpb24nID8gcHJvZmlsZU5hbWUoKSA6IHByb2ZpbGVOYW1lO1xuICAgICAgZ2xvYmFsLm5hdGl2ZVRyYWNlQmVnaW5TZWN0aW9uKFxuICAgICAgICBUUkFDRV9UQUdfUkVBQ1RfQVBQUyxcbiAgICAgICAgcHJvZmlsZU5hbWVTdHJpbmcsXG4gICAgICAgIGFyZ3MsXG4gICAgICApO1xuICAgIH1cbiAgfSxcblxuICBlbmRFdmVudCgpIHtcbiAgICBpZiAoX2VuYWJsZWQpIHtcbiAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUVuZFNlY3Rpb24oVFJBQ0VfVEFHX1JFQUNUX0FQUFMpO1xuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogYmVnaW5Bc3luY0V2ZW50L2VuZEFzeW5jRXZlbnQgZm9yIHN0YXJ0aW5nIGFuZCB0aGVuIGVuZGluZyBhIHByb2ZpbGUgd2hlcmUgdGhlIGVuZCBjYW4gZWl0aGVyXG4gICAqIG9jY3VyIG9uIGFub3RoZXIgdGhyZWFkIG9yIG91dCBvZiB0aGUgY3VycmVudCBzdGFjayBmcmFtZSwgZWcgYXdhaXRcbiAgICogdGhlIHJldHVybmVkIGNvb2tpZSB2YXJpYWJsZSBzaG91bGQgYmUgdXNlZCBhcyBpbnB1dCBpbnRvIHRoZSBlbmRBc3luY0V2ZW50IGNhbGwgdG8gZW5kIHRoZSBwcm9maWxlXG4gICAqKi9cbiAgYmVnaW5Bc3luY0V2ZW50KHByb2ZpbGVOYW1lPzogc3RyaW5nIHwgKCgpID0+IHN0cmluZykpOiBudW1iZXIge1xuICAgIGNvbnN0IGNvb2tpZSA9IF9hc3luY0Nvb2tpZTtcbiAgICBpZiAoX2VuYWJsZWQpIHtcbiAgICAgIF9hc3luY0Nvb2tpZSsrO1xuICAgICAgY29uc3QgcHJvZmlsZU5hbWVTdHJpbmcgPVxuICAgICAgICB0eXBlb2YgcHJvZmlsZU5hbWUgPT09ICdmdW5jdGlvbicgPyBwcm9maWxlTmFtZSgpIDogcHJvZmlsZU5hbWU7XG4gICAgICBnbG9iYWwubmF0aXZlVHJhY2VCZWdpbkFzeW5jU2VjdGlvbihcbiAgICAgICAgVFJBQ0VfVEFHX1JFQUNUX0FQUFMsXG4gICAgICAgIHByb2ZpbGVOYW1lU3RyaW5nLFxuICAgICAgICBjb29raWUsXG4gICAgICApO1xuICAgIH1cbiAgICByZXR1cm4gY29va2llO1xuICB9LFxuXG4gIGVuZEFzeW5jRXZlbnQocHJvZmlsZU5hbWU/OiBzdHJpbmcgfCAoKCkgPT4gc3RyaW5nKSwgY29va2llPzogbnVtYmVyKSB7XG4gICAgaWYgKF9lbmFibGVkKSB7XG4gICAgICBjb25zdCBwcm9maWxlTmFtZVN0cmluZyA9XG4gICAgICAgIHR5cGVvZiBwcm9maWxlTmFtZSA9PT0gJ2Z1bmN0aW9uJyA/IHByb2ZpbGVOYW1lKCkgOiBwcm9maWxlTmFtZTtcbiAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUVuZEFzeW5jU2VjdGlvbihcbiAgICAgICAgVFJBQ0VfVEFHX1JFQUNUX0FQUFMsXG4gICAgICAgIHByb2ZpbGVOYW1lU3RyaW5nLFxuICAgICAgICBjb29raWUsXG4gICAgICApO1xuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICogY291bnRlckV2ZW50IHJlZ2lzdGVycyB0aGUgdmFsdWUgdG8gdGhlIHByb2ZpbGVOYW1lIG9uIHRoZSBzeXN0cmFjZSB0aW1lbGluZVxuICAgKiovXG4gIGNvdW50ZXJFdmVudChwcm9maWxlTmFtZT86IHN0cmluZyB8ICgoKSA9PiBzdHJpbmcpLCB2YWx1ZT86IG51bWJlcikge1xuICAgIGlmIChfZW5hYmxlZCkge1xuICAgICAgY29uc3QgcHJvZmlsZU5hbWVTdHJpbmcgPVxuICAgICAgICB0eXBlb2YgcHJvZmlsZU5hbWUgPT09ICdmdW5jdGlvbicgPyBwcm9maWxlTmFtZSgpIDogcHJvZmlsZU5hbWU7XG4gICAgICBnbG9iYWwubmF0aXZlVHJhY2VDb3VudGVyICYmXG4gICAgICAgIGdsb2JhbC5uYXRpdmVUcmFjZUNvdW50ZXIoXG4gICAgICAgICAgVFJBQ0VfVEFHX1JFQUNUX0FQUFMsXG4gICAgICAgICAgcHJvZmlsZU5hbWVTdHJpbmcsXG4gICAgICAgICAgdmFsdWUsXG4gICAgICAgICk7XG4gICAgfVxuICB9LFxufTtcblxuaWYgKF9fREVWX18pIHtcbiAgLy8gVGhlIG1ldHJvIHJlcXVpcmUgcG9seWZpbGwgY2FuIG5vdCBoYXZlIGRlcGVuZGVuY2llcyAodHJ1ZSBmb3IgYWxsIHBvbHlmaWxscykuXG4gIC8vIEVuc3VyZSB0aGF0IGBTeXN0cmFjZWAgaXMgYXZhaWxhYmxlIGluIHBvbHlmaWxsIGJ5IGV4cG9zaW5nIGl0IGdsb2JhbGx5LlxuICBnbG9iYWxbKGdsb2JhbC5fX01FVFJPX0dMT0JBTF9QUkVGSVhfXyB8fCAnJykgKyAnX19TWVNUUkFDRSddID0gU3lzdHJhY2U7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gU3lzdHJhY2U7XG4iXX0=