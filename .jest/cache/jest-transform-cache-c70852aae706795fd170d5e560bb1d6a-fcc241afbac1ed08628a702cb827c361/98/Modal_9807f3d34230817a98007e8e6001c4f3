6bef7fc0f714bcdec48b23fd71687bbd
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _extends2 = _interopRequireDefault2(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault2(require("@babel/runtime/helpers/slicedToArray"));

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = Modal;

var React = _interopRequireWildcard(require("react"));

var _reactNative = require("react-native");

var _reactNativeIphoneXHelper = require("react-native-iphone-x-helper");

var _Surface = _interopRequireDefault(require("./Surface"));

var _theming = require("../core/theming");

var _useAnimatedValue = _interopRequireDefault(require("../utils/useAnimatedValue"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _getRequireWildcardCache() {
  if (typeof WeakMap !== "function") return null;
  var cache = new WeakMap();

  _getRequireWildcardCache = function _getRequireWildcardCache() {
    return cache;
  };

  return cache;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache();

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

var DEFAULT_DURATION = 220;
var TOP_INSET = (0, _reactNativeIphoneXHelper.getStatusBarHeight)(true);
var BOTTOM_INSET = (0, _reactNativeIphoneXHelper.getBottomSpace)();

function Modal(_ref) {
  var _ref$dismissable = _ref.dismissable,
      dismissable = _ref$dismissable === void 0 ? true : _ref$dismissable,
      _ref$visible = _ref.visible,
      visible = _ref$visible === void 0 ? false : _ref$visible,
      _ref$overlayAccessibi = _ref.overlayAccessibilityLabel,
      overlayAccessibilityLabel = _ref$overlayAccessibi === void 0 ? 'Close modal' : _ref$overlayAccessibi,
      onDismiss = _ref.onDismiss,
      children = _ref.children,
      contentContainerStyle = _ref.contentContainerStyle,
      style = _ref.style;
  var visibleRef = React.useRef(visible);
  React.useEffect(function () {
    visibleRef.current = visible;
  });

  var _ref2 = (0, _theming.useTheme)(),
      colors = _ref2.colors,
      animation = _ref2.animation;

  var opacity = (0, _useAnimatedValue.default)(visible ? 1 : 0);

  var _React$useState = React.useState(visible),
      _React$useState2 = (0, _slicedToArray2.default)(_React$useState, 2),
      rendered = _React$useState2[0],
      setRendered = _React$useState2[1];

  if (visible && !rendered) {
    setRendered(true);
  }

  var handleBack = function handleBack() {
    if (dismissable) {
      hideModal();
    }

    return true;
  };

  var subscription = React.useRef(undefined);

  var showModal = function showModal() {
    var _subscription$current;

    if ((_subscription$current = subscription.current) !== null && _subscription$current !== void 0 && _subscription$current.remove) {
      subscription.current.remove();
    } else {
      _reactNative.BackHandler.removeEventListener('hardwareBackPress', handleBack);
    }

    subscription.current = _reactNative.BackHandler.addEventListener('hardwareBackPress', handleBack);
    var scale = animation.scale;

    _reactNative.Animated.timing(opacity, {
      toValue: 1,
      duration: scale * DEFAULT_DURATION,
      easing: _reactNative.Easing.out(_reactNative.Easing.cubic),
      useNativeDriver: true
    }).start();
  };

  var hideModal = function hideModal() {
    var _subscription$current2;

    if ((_subscription$current2 = subscription.current) !== null && _subscription$current2 !== void 0 && _subscription$current2.remove) {
      var _subscription$current3;

      (_subscription$current3 = subscription.current) === null || _subscription$current3 === void 0 ? void 0 : _subscription$current3.remove();
    } else {
      _reactNative.BackHandler.removeEventListener('hardwareBackPress', handleBack);
    }

    var scale = animation.scale;

    _reactNative.Animated.timing(opacity, {
      toValue: 0,
      duration: scale * DEFAULT_DURATION,
      easing: _reactNative.Easing.out(_reactNative.Easing.cubic),
      useNativeDriver: true
    }).start(function (_ref3) {
      var finished = _ref3.finished;

      if (!finished) {
        return;
      }

      if (visible && onDismiss) {
        onDismiss();
      }

      if (visibleRef.current) {
        showModal();
      } else {
        setRendered(false);
      }
    });
  };

  var prevVisible = React.useRef(null);
  React.useEffect(function () {
    if (prevVisible.current !== visible) {
      if (visible) {
        showModal();
      } else {
        hideModal();
      }
    }

    prevVisible.current = visible;
  });
  if (!rendered) return null;
  return React.createElement(_reactNative.Animated.View, {
    pointerEvents: visible ? 'auto' : 'none',
    accessibilityViewIsModal: true,
    accessibilityLiveRegion: "polite",
    style: _reactNative.StyleSheet.absoluteFill,
    onAccessibilityEscape: hideModal
  }, React.createElement(_reactNative.TouchableWithoutFeedback, {
    accessibilityLabel: overlayAccessibilityLabel,
    accessibilityRole: "button",
    disabled: !dismissable,
    onPress: dismissable ? hideModal : undefined,
    importantForAccessibility: "no"
  }, React.createElement(_reactNative.Animated.View, {
    style: [styles.backdrop, {
      backgroundColor: colors.backdrop,
      opacity: opacity
    }]
  })), React.createElement(_reactNative.View, {
    style: [styles.wrapper, {
      marginTop: TOP_INSET,
      marginBottom: BOTTOM_INSET
    }, style],
    pointerEvents: "box-none"
  }, React.createElement(_Surface.default, {
    style: [{
      opacity: opacity
    }, styles.content, contentContainerStyle]
  }, children)));
}

var styles = _reactNative.StyleSheet.create({
  backdrop: {
    flex: 1
  },
  wrapper: (0, _extends2.default)({}, _reactNative.StyleSheet.absoluteFillObject, {
    justifyContent: 'center'
  }),
  content: {
    backgroundColor: 'transparent',
    justifyContent: 'center'
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUFSc0IsQ0FBbEJuQixDQUFmIiwibmFtZXMiOlsiREVGQVVMVF9EVVJBVElPTiIsIlRPUF9JTlNFVCIsIkJPVFRPTV9JTlNFVCIsIk1vZGFsIiwiZGlzbWlzc2FibGUiLCJ2aXNpYmxlIiwib3ZlcmxheUFjY2Vzc2liaWxpdHlMYWJlbCIsIm9uRGlzbWlzcyIsImNoaWxkcmVuIiwiY29udGVudENvbnRhaW5lclN0eWxlIiwic3R5bGUiLCJ2aXNpYmxlUmVmIiwiUmVhY3QiLCJ1c2VSZWYiLCJ1c2VFZmZlY3QiLCJjdXJyZW50IiwiY29sb3JzIiwiYW5pbWF0aW9uIiwib3BhY2l0eSIsInVzZVN0YXRlIiwicmVuZGVyZWQiLCJzZXRSZW5kZXJlZCIsImhhbmRsZUJhY2siLCJoaWRlTW9kYWwiLCJzdWJzY3JpcHRpb24iLCJ1bmRlZmluZWQiLCJzaG93TW9kYWwiLCJfc3Vic2NyaXB0aW9uJGN1cnJlbnQiLCJyZW1vdmUiLCJCYWNrSGFuZGxlciIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJhZGRFdmVudExpc3RlbmVyIiwic2NhbGUiLCJBbmltYXRlZCIsInRpbWluZyIsInRvVmFsdWUiLCJkdXJhdGlvbiIsImVhc2luZyIsIkVhc2luZyIsIm91dCIsImN1YmljIiwidXNlTmF0aXZlRHJpdmVyIiwic3RhcnQiLCJfc3Vic2NyaXB0aW9uJGN1cnJlbnQyIiwiZmluaXNoZWQiLCJwcmV2VmlzaWJsZSIsIl9yZWFjdE5hdGl2ZSIsIlZpZXciLCJwb2ludGVyRXZlbnRzIiwiYWNjZXNzaWJpbGl0eVZpZXdJc01vZGFsIiwiYWNjZXNzaWJpbGl0eUxpdmVSZWdpb24iLCJTdHlsZVNoZWV0IiwiYWJzb2x1dGVGaWxsIiwib25BY2Nlc3NpYmlsaXR5RXNjYXBlIiwiYWNjZXNzaWJpbGl0eUxhYmVsIiwiYWNjZXNzaWJpbGl0eVJvbGUiLCJkaXNhYmxlZCIsIm9uUHJlc3MiLCJpbXBvcnRhbnRGb3JBY2Nlc3NpYmlsaXR5Iiwic3R5bGVzIiwiYmFja2Ryb3AiLCJiYWNrZ3JvdW5kQ29sb3IiLCJ3cmFwcGVyIiwibWFyZ2luVG9wIiwibWFyZ2luQm90dG9tIiwiX1N1cmZhY2UiLCJjb250ZW50IiwiY3JlYXRlIiwiZmxleCIsImFic29sdXRlRmlsbE9iamVjdCIsImp1c3RpZnlDb250ZW50Il0sInNvdXJjZXMiOlsiTW9kYWwudHN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7XG4gIEFuaW1hdGVkLFxuICBCYWNrSGFuZGxlcixcbiAgRWFzaW5nLFxuICBTdHlsZVByb3AsXG4gIFN0eWxlU2hlZXQsXG4gIFRvdWNoYWJsZVdpdGhvdXRGZWVkYmFjayxcbiAgVmlld1N0eWxlLFxuICBWaWV3LFxuICBOYXRpdmVFdmVudFN1YnNjcmlwdGlvbixcbn0gZnJvbSAncmVhY3QtbmF0aXZlJztcbmltcG9ydCB7XG4gIGdldFN0YXR1c0JhckhlaWdodCxcbiAgZ2V0Qm90dG9tU3BhY2UsXG59IGZyb20gJ3JlYWN0LW5hdGl2ZS1pcGhvbmUteC1oZWxwZXInO1xuaW1wb3J0IFN1cmZhY2UgZnJvbSAnLi9TdXJmYWNlJztcbmltcG9ydCB7IHVzZVRoZW1lIH0gZnJvbSAnLi4vY29yZS90aGVtaW5nJztcbmltcG9ydCB1c2VBbmltYXRlZFZhbHVlIGZyb20gJy4uL3V0aWxzL3VzZUFuaW1hdGVkVmFsdWUnO1xuXG50eXBlIFByb3BzID0ge1xuICAvKipcbiAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIGNsaWNraW5nIG91dHNpZGUgdGhlIG1vZGFsIGRpc21pc3MgaXQuXG4gICAqL1xuICBkaXNtaXNzYWJsZT86IGJvb2xlYW47XG4gIC8qKlxuICAgKiBDYWxsYmFjayB0aGF0IGlzIGNhbGxlZCB3aGVuIHRoZSB1c2VyIGRpc21pc3NlcyB0aGUgbW9kYWwuXG4gICAqL1xuICBvbkRpc21pc3M/OiAoKSA9PiB2b2lkO1xuICAvKipcbiAgICogQWNjZXNzaWJpbGl0eSBsYWJlbCBmb3IgdGhlIG92ZXJsYXkuIFRoaXMgaXMgcmVhZCBieSB0aGUgc2NyZWVuIHJlYWRlciB3aGVuIHRoZSB1c2VyIHRhcHMgb3V0c2lkZSB0aGUgbW9kYWwuXG4gICAqL1xuICBvdmVybGF5QWNjZXNzaWJpbGl0eUxhYmVsPzogc3RyaW5nO1xuICAvKipcbiAgICogRGV0ZXJtaW5lcyBXaGV0aGVyIHRoZSBtb2RhbCBpcyB2aXNpYmxlLlxuICAgKi9cbiAgdmlzaWJsZTogYm9vbGVhbjtcbiAgLyoqXG4gICAqIENvbnRlbnQgb2YgdGhlIGBNb2RhbGAuXG4gICAqL1xuICBjaGlsZHJlbjogUmVhY3QuUmVhY3ROb2RlO1xuICAvKipcbiAgICogU3R5bGUgZm9yIHRoZSBjb250ZW50IG9mIHRoZSBtb2RhbFxuICAgKi9cbiAgY29udGVudENvbnRhaW5lclN0eWxlPzogU3R5bGVQcm9wPFZpZXdTdHlsZT47XG4gIC8qKlxuICAgKiBTdHlsZSBmb3IgdGhlIHdyYXBwZXIgb2YgdGhlIG1vZGFsLlxuICAgKiBVc2UgdGhpcyBwcm9wIHRvIGNoYW5nZSB0aGUgZGVmYXVsdCB3cmFwcGVyIHN0eWxlIG9yIHRvIG92ZXJyaWRlIHNhZmUgYXJlYSBpbnNldHMgd2l0aCBtYXJnaW5Ub3AgYW5kIG1hcmdpbkJvdHRvbS5cbiAgICovXG4gIHN0eWxlPzogU3R5bGVQcm9wPFZpZXdTdHlsZT47XG59O1xuXG5jb25zdCBERUZBVUxUX0RVUkFUSU9OID0gMjIwO1xuY29uc3QgVE9QX0lOU0VUID0gZ2V0U3RhdHVzQmFySGVpZ2h0KHRydWUpO1xuY29uc3QgQk9UVE9NX0lOU0VUID0gZ2V0Qm90dG9tU3BhY2UoKTtcblxuLyoqXG4gKiBUaGUgTW9kYWwgY29tcG9uZW50IGlzIGEgc2ltcGxlIHdheSB0byBwcmVzZW50IGNvbnRlbnQgYWJvdmUgYW4gZW5jbG9zaW5nIHZpZXcuXG4gKiBUbyByZW5kZXIgdGhlIGBNb2RhbGAgYWJvdmUgb3RoZXIgY29tcG9uZW50cywgeW91J2xsIG5lZWQgdG8gd3JhcCBpdCB3aXRoIHRoZSBbYFBvcnRhbGBdKHBvcnRhbC5odG1sKSBjb21wb25lbnQuXG4gKlxuICogPGRpdiBjbGFzcz1cInNjcmVlbnNob3RzXCI+XG4gKiAgIDxmaWd1cmU+XG4gKiAgICAgPGltZyBjbGFzcz1cIm1lZGl1bVwiIHNyYz1cInNjcmVlbnNob3RzL21vZGFsLmdpZlwiIC8+XG4gKiAgIDwvZmlndXJlPlxuICogPC9kaXY+XG4gKlxuICogIyMgVXNhZ2VcbiAqIGBgYGpzXG4gKiBpbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG4gKiBpbXBvcnQgeyBNb2RhbCwgUG9ydGFsLCBUZXh0LCBCdXR0b24sIFByb3ZpZGVyIH0gZnJvbSAncmVhY3QtbmF0aXZlLXBhcGVyJztcbiAqXG4gKiBjb25zdCBNeUNvbXBvbmVudCA9ICgpID0+IHtcbiAqICAgY29uc3QgW3Zpc2libGUsIHNldFZpc2libGVdID0gUmVhY3QudXNlU3RhdGUoZmFsc2UpO1xuICpcbiAqICAgY29uc3Qgc2hvd01vZGFsID0gKCkgPT4gc2V0VmlzaWJsZSh0cnVlKTtcbiAqICAgY29uc3QgaGlkZU1vZGFsID0gKCkgPT4gc2V0VmlzaWJsZShmYWxzZSk7XG4gKiAgIGNvbnN0IGNvbnRhaW5lclN0eWxlID0ge2JhY2tncm91bmRDb2xvcjogJ3doaXRlJywgcGFkZGluZzogMjB9O1xuICpcbiAqICAgcmV0dXJuIChcbiAqICAgICA8UHJvdmlkZXI+XG4gKiAgICAgICA8UG9ydGFsPlxuICogICAgICAgICA8TW9kYWwgdmlzaWJsZT17dmlzaWJsZX0gb25EaXNtaXNzPXtoaWRlTW9kYWx9IGNvbnRlbnRDb250YWluZXJTdHlsZT17Y29udGFpbmVyU3R5bGV9PlxuICogICAgICAgICAgIDxUZXh0PkV4YW1wbGUgTW9kYWwuICBDbGljayBvdXRzaWRlIHRoaXMgYXJlYSB0byBkaXNtaXNzLjwvVGV4dD5cbiAqICAgICAgICAgPC9Nb2RhbD5cbiAqICAgICAgIDwvUG9ydGFsPlxuICogICAgICAgPEJ1dHRvbiBzdHlsZT17e21hcmdpblRvcDogMzB9fSBvblByZXNzPXtzaG93TW9kYWx9PlxuICogICAgICAgICBTaG93XG4gKiAgICAgICA8L0J1dHRvbj5cbiAqICAgICA8L1Byb3ZpZGVyPlxuICogICApO1xuICogfTtcbiAqXG4gKiBleHBvcnQgZGVmYXVsdCBNeUNvbXBvbmVudDtcbiAqIGBgYFxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBNb2RhbCh7XG4gIGRpc21pc3NhYmxlID0gdHJ1ZSxcbiAgdmlzaWJsZSA9IGZhbHNlLFxuICBvdmVybGF5QWNjZXNzaWJpbGl0eUxhYmVsID0gJ0Nsb3NlIG1vZGFsJyxcbiAgb25EaXNtaXNzLFxuICBjaGlsZHJlbixcbiAgY29udGVudENvbnRhaW5lclN0eWxlLFxuICBzdHlsZSxcbn06IFByb3BzKSB7XG4gIGNvbnN0IHZpc2libGVSZWYgPSBSZWFjdC51c2VSZWYodmlzaWJsZSk7XG5cbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICB2aXNpYmxlUmVmLmN1cnJlbnQgPSB2aXNpYmxlO1xuICB9KTtcblxuICBjb25zdCB7IGNvbG9ycywgYW5pbWF0aW9uIH0gPSB1c2VUaGVtZSgpO1xuXG4gIGNvbnN0IG9wYWNpdHkgPSB1c2VBbmltYXRlZFZhbHVlKHZpc2libGUgPyAxIDogMCk7XG5cbiAgY29uc3QgW3JlbmRlcmVkLCBzZXRSZW5kZXJlZF0gPSBSZWFjdC51c2VTdGF0ZSh2aXNpYmxlKTtcblxuICBpZiAodmlzaWJsZSAmJiAhcmVuZGVyZWQpIHtcbiAgICBzZXRSZW5kZXJlZCh0cnVlKTtcbiAgfVxuXG4gIGNvbnN0IGhhbmRsZUJhY2sgPSAoKSA9PiB7XG4gICAgaWYgKGRpc21pc3NhYmxlKSB7XG4gICAgICBoaWRlTW9kYWwoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG5cbiAgY29uc3Qgc3Vic2NyaXB0aW9uID0gUmVhY3QudXNlUmVmPE5hdGl2ZUV2ZW50U3Vic2NyaXB0aW9uIHwgdW5kZWZpbmVkPihcbiAgICB1bmRlZmluZWRcbiAgKTtcblxuICBjb25zdCBzaG93TW9kYWwgPSAoKSA9PiB7XG4gICAgaWYgKHN1YnNjcmlwdGlvbi5jdXJyZW50Py5yZW1vdmUpIHtcbiAgICAgIHN1YnNjcmlwdGlvbi5jdXJyZW50LnJlbW92ZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBCYWNrSGFuZGxlci5yZW1vdmVFdmVudExpc3RlbmVyKCdoYXJkd2FyZUJhY2tQcmVzcycsIGhhbmRsZUJhY2spO1xuICAgIH1cbiAgICBzdWJzY3JpcHRpb24uY3VycmVudCA9IEJhY2tIYW5kbGVyLmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAnaGFyZHdhcmVCYWNrUHJlc3MnLFxuICAgICAgaGFuZGxlQmFja1xuICAgICk7XG5cbiAgICBjb25zdCB7IHNjYWxlIH0gPSBhbmltYXRpb247XG5cbiAgICBBbmltYXRlZC50aW1pbmcob3BhY2l0eSwge1xuICAgICAgdG9WYWx1ZTogMSxcbiAgICAgIGR1cmF0aW9uOiBzY2FsZSAqIERFRkFVTFRfRFVSQVRJT04sXG4gICAgICBlYXNpbmc6IEVhc2luZy5vdXQoRWFzaW5nLmN1YmljKSxcbiAgICAgIHVzZU5hdGl2ZURyaXZlcjogdHJ1ZSxcbiAgICB9KS5zdGFydCgpO1xuICB9O1xuXG4gIGNvbnN0IGhpZGVNb2RhbCA9ICgpID0+IHtcbiAgICBpZiAoc3Vic2NyaXB0aW9uLmN1cnJlbnQ/LnJlbW92ZSkge1xuICAgICAgc3Vic2NyaXB0aW9uLmN1cnJlbnQ/LnJlbW92ZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBCYWNrSGFuZGxlci5yZW1vdmVFdmVudExpc3RlbmVyKCdoYXJkd2FyZUJhY2tQcmVzcycsIGhhbmRsZUJhY2spO1xuICAgIH1cblxuICAgIGNvbnN0IHsgc2NhbGUgfSA9IGFuaW1hdGlvbjtcblxuICAgIEFuaW1hdGVkLnRpbWluZyhvcGFjaXR5LCB7XG4gICAgICB0b1ZhbHVlOiAwLFxuICAgICAgZHVyYXRpb246IHNjYWxlICogREVGQVVMVF9EVVJBVElPTixcbiAgICAgIGVhc2luZzogRWFzaW5nLm91dChFYXNpbmcuY3ViaWMpLFxuICAgICAgdXNlTmF0aXZlRHJpdmVyOiB0cnVlLFxuICAgIH0pLnN0YXJ0KCh7IGZpbmlzaGVkIH0pID0+IHtcbiAgICAgIGlmICghZmluaXNoZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBpZiAodmlzaWJsZSAmJiBvbkRpc21pc3MpIHtcbiAgICAgICAgb25EaXNtaXNzKCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh2aXNpYmxlUmVmLmN1cnJlbnQpIHtcbiAgICAgICAgc2hvd01vZGFsKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzZXRSZW5kZXJlZChmYWxzZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgY29uc3QgcHJldlZpc2libGUgPSBSZWFjdC51c2VSZWY8Ym9vbGVhbiB8IG51bGw+KG51bGwpO1xuXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKHByZXZWaXNpYmxlLmN1cnJlbnQgIT09IHZpc2libGUpIHtcbiAgICAgIGlmICh2aXNpYmxlKSB7XG4gICAgICAgIHNob3dNb2RhbCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaGlkZU1vZGFsKCk7XG4gICAgICB9XG4gICAgfVxuICAgIHByZXZWaXNpYmxlLmN1cnJlbnQgPSB2aXNpYmxlO1xuICB9KTtcblxuICBpZiAoIXJlbmRlcmVkKSByZXR1cm4gbnVsbDtcblxuICByZXR1cm4gKFxuICAgIDxBbmltYXRlZC5WaWV3XG4gICAgICBwb2ludGVyRXZlbnRzPXt2aXNpYmxlID8gJ2F1dG8nIDogJ25vbmUnfVxuICAgICAgYWNjZXNzaWJpbGl0eVZpZXdJc01vZGFsXG4gICAgICBhY2Nlc3NpYmlsaXR5TGl2ZVJlZ2lvbj1cInBvbGl0ZVwiXG4gICAgICBzdHlsZT17U3R5bGVTaGVldC5hYnNvbHV0ZUZpbGx9XG4gICAgICBvbkFjY2Vzc2liaWxpdHlFc2NhcGU9e2hpZGVNb2RhbH1cbiAgICA+XG4gICAgICA8VG91Y2hhYmxlV2l0aG91dEZlZWRiYWNrXG4gICAgICAgIGFjY2Vzc2liaWxpdHlMYWJlbD17b3ZlcmxheUFjY2Vzc2liaWxpdHlMYWJlbH1cbiAgICAgICAgYWNjZXNzaWJpbGl0eVJvbGU9XCJidXR0b25cIlxuICAgICAgICBkaXNhYmxlZD17IWRpc21pc3NhYmxlfVxuICAgICAgICBvblByZXNzPXtkaXNtaXNzYWJsZSA/IGhpZGVNb2RhbCA6IHVuZGVmaW5lZH1cbiAgICAgICAgaW1wb3J0YW50Rm9yQWNjZXNzaWJpbGl0eT1cIm5vXCJcbiAgICAgID5cbiAgICAgICAgPEFuaW1hdGVkLlZpZXdcbiAgICAgICAgICBzdHlsZT17W1xuICAgICAgICAgICAgc3R5bGVzLmJhY2tkcm9wLFxuICAgICAgICAgICAgeyBiYWNrZ3JvdW5kQ29sb3I6IGNvbG9ycy5iYWNrZHJvcCwgb3BhY2l0eSB9LFxuICAgICAgICAgIF19XG4gICAgICAgIC8+XG4gICAgICA8L1RvdWNoYWJsZVdpdGhvdXRGZWVkYmFjaz5cbiAgICAgIDxWaWV3XG4gICAgICAgIHN0eWxlPXtbXG4gICAgICAgICAgc3R5bGVzLndyYXBwZXIsXG4gICAgICAgICAgeyBtYXJnaW5Ub3A6IFRPUF9JTlNFVCwgbWFyZ2luQm90dG9tOiBCT1RUT01fSU5TRVQgfSxcbiAgICAgICAgICBzdHlsZSxcbiAgICAgICAgXX1cbiAgICAgICAgcG9pbnRlckV2ZW50cz1cImJveC1ub25lXCJcbiAgICAgID5cbiAgICAgICAgPFN1cmZhY2VcbiAgICAgICAgICBzdHlsZT17XG4gICAgICAgICAgICBbeyBvcGFjaXR5IH0sIHN0eWxlcy5jb250ZW50LCBjb250ZW50Q29udGFpbmVyU3R5bGVdIGFzIFN0eWxlUHJvcDxcbiAgICAgICAgICAgICAgVmlld1N0eWxlXG4gICAgICAgICAgICA+XG4gICAgICAgICAgfVxuICAgICAgICA+XG4gICAgICAgICAge2NoaWxkcmVufVxuICAgICAgICA8L1N1cmZhY2U+XG4gICAgICA8L1ZpZXc+XG4gICAgPC9BbmltYXRlZC5WaWV3PlxuICApO1xufVxuXG5jb25zdCBzdHlsZXMgPSBTdHlsZVNoZWV0LmNyZWF0ZSh7XG4gIGJhY2tkcm9wOiB7XG4gICAgZmxleDogMSxcbiAgfSxcbiAgd3JhcHBlcjoge1xuICAgIC4uLlN0eWxlU2hlZXQuYWJzb2x1dGVGaWxsT2JqZWN0LFxuICAgIGp1c3RpZnlDb250ZW50OiAnY2VudGVyJyxcbiAgfSxcbiAgY29udGVudDoge1xuICAgIGJhY2tncm91bmRDb2xvcjogJ3RyYW5zcGFyZW50JyxcbiAgICBqdXN0aWZ5Q29udGVudDogJ2NlbnRlcicsXG4gIH0sXG59KTtcbiJdfQ==