83a82612761434692eb2ebc9af136896
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.startListening = startListening;
exports.stopListening = stopListening;

var _reactNative = require("react-native");

var _State = require("../../State");

var _EventType = require("../../EventType");

var _handlersRegistry = require("../handlersRegistry");

var _utils = require("../../utils");

var gestureHandlerEventSubscription = null;
var gestureHandlerStateChangeEventSubscription = null;
var warningMessage = (0, _utils.tagMessage)('You have to use react-native-reanimated in order to control the state of the gesture.');
var dummyStateManager = {
  begin: function begin() {
    console.warn(warningMessage);
  },
  activate: function activate() {
    console.warn(warningMessage);
  },
  end: function end() {
    console.warn(warningMessage);
  },
  fail: function fail() {
    console.warn(warningMessage);
  }
};
var lastUpdateEvent = [];

function isStateChangeEvent(event) {
  return event.oldState != null;
}

function isTouchEvent(event) {
  return event.eventType != null;
}

function onGestureHandlerEvent(event) {
  var _handler$handlers7, _handler$handlers7$on, _handler$handlers8, _handler$handlers8$on, _handler$handlers9, _handler$handlers9$on, _handler$handlers10, _handler$handlers10$o;

  var handler = (0, _handlersRegistry.findHandler)(event.handlerTag);

  if (handler) {
    if (isStateChangeEvent(event)) {
      if (event.oldState === _State.State.UNDETERMINED && event.state === _State.State.BEGAN) {
        var _handler$handlers$onB, _handler$handlers;

        (_handler$handlers$onB = (_handler$handlers = handler.handlers).onBegin) === null || _handler$handlers$onB === void 0 ? void 0 : _handler$handlers$onB.call(_handler$handlers, event);
      } else if ((event.oldState === _State.State.BEGAN || event.oldState === _State.State.UNDETERMINED) && event.state === _State.State.ACTIVE) {
        var _handler$handlers$onS, _handler$handlers2;

        (_handler$handlers$onS = (_handler$handlers2 = handler.handlers).onStart) === null || _handler$handlers$onS === void 0 ? void 0 : _handler$handlers$onS.call(_handler$handlers2, event);
        lastUpdateEvent[handler.handlers.handlerTag] = event;
      } else if (event.oldState !== event.state && event.state === _State.State.END) {
        var _handler$handlers$onF, _handler$handlers4;

        if (event.oldState === _State.State.ACTIVE) {
          var _handler$handlers$onE, _handler$handlers3;

          (_handler$handlers$onE = (_handler$handlers3 = handler.handlers).onEnd) === null || _handler$handlers$onE === void 0 ? void 0 : _handler$handlers$onE.call(_handler$handlers3, event, true);
        }

        (_handler$handlers$onF = (_handler$handlers4 = handler.handlers).onFinalize) === null || _handler$handlers$onF === void 0 ? void 0 : _handler$handlers$onF.call(_handler$handlers4, event, true);
        lastUpdateEvent[handler.handlers.handlerTag] = undefined;
      } else if ((event.state === _State.State.FAILED || event.state === _State.State.CANCELLED) && event.oldState !== event.state) {
        var _handler$handlers$onF2, _handler$handlers6;

        if (event.oldState === _State.State.ACTIVE) {
          var _handler$handlers$onE2, _handler$handlers5;

          (_handler$handlers$onE2 = (_handler$handlers5 = handler.handlers).onEnd) === null || _handler$handlers$onE2 === void 0 ? void 0 : _handler$handlers$onE2.call(_handler$handlers5, event, false);
        }

        (_handler$handlers$onF2 = (_handler$handlers6 = handler.handlers).onFinalize) === null || _handler$handlers$onF2 === void 0 ? void 0 : _handler$handlers$onF2.call(_handler$handlers6, event, false);
        lastUpdateEvent[handler.handlers.handlerTag] = undefined;
      }
    } else if (isTouchEvent(event)) {
      switch (event.eventType) {
        case _EventType.EventType.TOUCHES_DOWN:
          (_handler$handlers7 = handler.handlers) === null || _handler$handlers7 === void 0 ? void 0 : (_handler$handlers7$on = _handler$handlers7.onTouchesDown) === null || _handler$handlers7$on === void 0 ? void 0 : _handler$handlers7$on.call(_handler$handlers7, event, dummyStateManager);
          break;

        case _EventType.EventType.TOUCHES_MOVE:
          (_handler$handlers8 = handler.handlers) === null || _handler$handlers8 === void 0 ? void 0 : (_handler$handlers8$on = _handler$handlers8.onTouchesMove) === null || _handler$handlers8$on === void 0 ? void 0 : _handler$handlers8$on.call(_handler$handlers8, event, dummyStateManager);
          break;

        case _EventType.EventType.TOUCHES_UP:
          (_handler$handlers9 = handler.handlers) === null || _handler$handlers9 === void 0 ? void 0 : (_handler$handlers9$on = _handler$handlers9.onTouchesUp) === null || _handler$handlers9$on === void 0 ? void 0 : _handler$handlers9$on.call(_handler$handlers9, event, dummyStateManager);
          break;

        case _EventType.EventType.TOUCHES_CANCELLED:
          (_handler$handlers10 = handler.handlers) === null || _handler$handlers10 === void 0 ? void 0 : (_handler$handlers10$o = _handler$handlers10.onTouchesCancelled) === null || _handler$handlers10$o === void 0 ? void 0 : _handler$handlers10$o.call(_handler$handlers10, event, dummyStateManager);
          break;
      }
    } else {
      var _handler$handlers$onU, _handler$handlers11;

      (_handler$handlers$onU = (_handler$handlers11 = handler.handlers).onUpdate) === null || _handler$handlers$onU === void 0 ? void 0 : _handler$handlers$onU.call(_handler$handlers11, event);

      if (handler.handlers.onChange && handler.handlers.changeEventCalculator) {
        var _handler$handlers$onC, _handler$handlers12, _handler$handlers$cha, _handler$handlers13;

        (_handler$handlers$onC = (_handler$handlers12 = handler.handlers).onChange) === null || _handler$handlers$onC === void 0 ? void 0 : _handler$handlers$onC.call(_handler$handlers12, (_handler$handlers$cha = (_handler$handlers13 = handler.handlers).changeEventCalculator) === null || _handler$handlers$cha === void 0 ? void 0 : _handler$handlers$cha.call(_handler$handlers13, event, lastUpdateEvent[handler.handlers.handlerTag]));
        lastUpdateEvent[handler.handlers.handlerTag] = event;
      }
    }
  } else {
    var oldHandler = (0, _handlersRegistry.findOldGestureHandler)(event.handlerTag);

    if (oldHandler) {
      var nativeEvent = {
        nativeEvent: event
      };

      if (isStateChangeEvent(event)) {
        oldHandler.onGestureStateChange(nativeEvent);
      } else {
        oldHandler.onGestureEvent(nativeEvent);
      }

      return;
    }
  }
}

function startListening() {
  stopListening();
  gestureHandlerEventSubscription = _reactNative.DeviceEventEmitter.addListener('onGestureHandlerEvent', onGestureHandlerEvent);
  gestureHandlerStateChangeEventSubscription = _reactNative.DeviceEventEmitter.addListener('onGestureHandlerStateChange', onGestureHandlerEvent);
}

function stopListening() {
  if (gestureHandlerEventSubscription) {
    gestureHandlerEventSubscription.remove();
    gestureHandlerEventSubscription = null;
  }

  if (gestureHandlerStateChangeEventSubscription) {
    gestureHandlerStateChangeEventSubscription.remove();
    gestureHandlerStateChangeEventSubscription = null;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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IiwiZ2VzdHVyZUhhbmRsZXJTdGF0ZUNoYW5nZUV2ZW50U3Vic2NyaXB0aW9uIiwid2FybmluZ01lc3NhZ2UiLCJkdW1teVN0YXRlTWFuYWdlciIsImJlZ2luIiwiY29uc29sZSIsIndhcm4iLCJhY3RpdmF0ZSIsImVuZCIsImZhaWwiLCJsYXN0VXBkYXRlRXZlbnQiLCJpc1N0YXRlQ2hhbmdlRXZlbnQiLCJldmVudCIsIm9sZFN0YXRlIiwiaXNUb3VjaEV2ZW50IiwiZXZlbnRUeXBlIiwib25HZXN0dXJlSGFuZGxlckV2ZW50IiwiaGFuZGxlciIsImhhbmRsZXJUYWciLCJTdGF0ZSIsIlVOREVURVJNSU5FRCIsInN0YXRlIiwiQkVHQU4iLCJoYW5kbGVycyIsIm9uQmVnaW4iLCJBQ1RJVkUiLCJvblN0YXJ0IiwiRU5EIiwib25FbmQiLCJvbkZpbmFsaXplIiwidW5kZWZpbmVkIiwiRkFJTEVEIiwiQ0FOQ0VMTEVEIiwiRXZlbnRUeXBlIiwiVE9VQ0hFU19ET1dOIiwib25Ub3VjaGVzRG93biIsIlRPVUNIRVNfTU9WRSIsIm9uVG91Y2hlc01vdmUiLCJUT1VDSEVTX1VQIiwib25Ub3VjaGVzVXAiLCJUT1VDSEVTX0NBTkNFTExFRCIsIm9uVG91Y2hlc0NhbmNlbGxlZCIsIm9uVXBkYXRlIiwib25DaGFuZ2UiLCJjaGFuZ2VFdmVudENhbGN1bGF0b3IiLCJfaGFuZGxlciRoYW5kbGVycyRjaGEiLCJvbGRIYW5kbGVyIiwibmF0aXZlRXZlbnQiLCJvbkdlc3R1cmVTdGF0ZUNoYW5nZSIsIm9uR2VzdHVyZUV2ZW50Iiwic3RhcnRMaXN0ZW5pbmciLCJzdG9wTGlzdGVuaW5nIiwiRGV2aWNlRXZlbnRFbWl0dGVyIiwiYWRkTGlzdGVuZXIiLCJyZW1vdmUiXSwic291cmNlcyI6WyJldmVudFJlY2VpdmVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERldmljZUV2ZW50RW1pdHRlciwgRW1pdHRlclN1YnNjcmlwdGlvbiB9IGZyb20gJ3JlYWN0LW5hdGl2ZSc7XG5pbXBvcnQgeyBTdGF0ZSB9IGZyb20gJy4uLy4uL1N0YXRlJztcbmltcG9ydCB7IEV2ZW50VHlwZSB9IGZyb20gJy4uLy4uL0V2ZW50VHlwZSc7XG5pbXBvcnQge1xuICBHZXN0dXJlVG91Y2hFdmVudCxcbiAgR2VzdHVyZVVwZGF0ZUV2ZW50LFxuICBHZXN0dXJlU3RhdGVDaGFuZ2VFdmVudCxcbn0gZnJvbSAnLi4vZ2VzdHVyZUhhbmRsZXJDb21tb24nO1xuaW1wb3J0IHsgR2VzdHVyZVN0YXRlTWFuYWdlclR5cGUgfSBmcm9tICcuL2dlc3R1cmVTdGF0ZU1hbmFnZXInO1xuaW1wb3J0IHsgZmluZEhhbmRsZXIsIGZpbmRPbGRHZXN0dXJlSGFuZGxlciB9IGZyb20gJy4uL2hhbmRsZXJzUmVnaXN0cnknO1xuaW1wb3J0IHsgQmFzZUdlc3R1cmUgfSBmcm9tICcuL2dlc3R1cmUnO1xuaW1wb3J0IHsgdGFnTWVzc2FnZSB9IGZyb20gJy4uLy4uL3V0aWxzJztcblxubGV0IGdlc3R1cmVIYW5kbGVyRXZlbnRTdWJzY3JpcHRpb246IEVtaXR0ZXJTdWJzY3JpcHRpb24gfCBudWxsID0gbnVsbDtcbmxldCBnZXN0dXJlSGFuZGxlclN0YXRlQ2hhbmdlRXZlbnRTdWJzY3JpcHRpb246IEVtaXR0ZXJTdWJzY3JpcHRpb24gfCBudWxsID0gbnVsbDtcblxuY29uc3Qgd2FybmluZ01lc3NhZ2UgPSB0YWdNZXNzYWdlKFxuICAnWW91IGhhdmUgdG8gdXNlIHJlYWN0LW5hdGl2ZS1yZWFuaW1hdGVkIGluIG9yZGVyIHRvIGNvbnRyb2wgdGhlIHN0YXRlIG9mIHRoZSBnZXN0dXJlLidcbik7XG5cbmNvbnN0IGR1bW15U3RhdGVNYW5hZ2VyOiBHZXN0dXJlU3RhdGVNYW5hZ2VyVHlwZSA9IHtcbiAgYmVnaW46ICgpID0+IHtcbiAgICBjb25zb2xlLndhcm4od2FybmluZ01lc3NhZ2UpO1xuICB9LFxuICBhY3RpdmF0ZTogKCkgPT4ge1xuICAgIGNvbnNvbGUud2Fybih3YXJuaW5nTWVzc2FnZSk7XG4gIH0sXG4gIGVuZDogKCkgPT4ge1xuICAgIGNvbnNvbGUud2Fybih3YXJuaW5nTWVzc2FnZSk7XG4gIH0sXG4gIGZhaWw6ICgpID0+IHtcbiAgICBjb25zb2xlLndhcm4od2FybmluZ01lc3NhZ2UpO1xuICB9LFxufTtcblxuY29uc3QgbGFzdFVwZGF0ZUV2ZW50OiAoR2VzdHVyZVVwZGF0ZUV2ZW50IHwgdW5kZWZpbmVkKVtdID0gW107XG5cbmZ1bmN0aW9uIGlzU3RhdGVDaGFuZ2VFdmVudChcbiAgZXZlbnQ6IEdlc3R1cmVVcGRhdGVFdmVudCB8IEdlc3R1cmVTdGF0ZUNoYW5nZUV2ZW50IHwgR2VzdHVyZVRvdWNoRXZlbnRcbik6IGV2ZW50IGlzIEdlc3R1cmVTdGF0ZUNoYW5nZUV2ZW50IHtcbiAgLy8gQHRzLWlnbm9yZSBvbGRTdGF0ZSBkb2Vzbid0IGV4aXN0IG9uIEdlc3R1cmVUb3VjaEV2ZW50IGFuZCB0aGF0J3MgdGhlIHBvaW50XG4gIHJldHVybiBldmVudC5vbGRTdGF0ZSAhPSBudWxsO1xufVxuXG5mdW5jdGlvbiBpc1RvdWNoRXZlbnQoXG4gIGV2ZW50OiBHZXN0dXJlVXBkYXRlRXZlbnQgfCBHZXN0dXJlU3RhdGVDaGFuZ2VFdmVudCB8IEdlc3R1cmVUb3VjaEV2ZW50XG4pOiBldmVudCBpcyBHZXN0dXJlVG91Y2hFdmVudCB7XG4gIHJldHVybiBldmVudC5ldmVudFR5cGUgIT0gbnVsbDtcbn1cblxuZnVuY3Rpb24gb25HZXN0dXJlSGFuZGxlckV2ZW50KFxuICBldmVudDogR2VzdHVyZVVwZGF0ZUV2ZW50IHwgR2VzdHVyZVN0YXRlQ2hhbmdlRXZlbnQgfCBHZXN0dXJlVG91Y2hFdmVudFxuKSB7XG4gIGNvbnN0IGhhbmRsZXIgPSBmaW5kSGFuZGxlcihldmVudC5oYW5kbGVyVGFnKSBhcyBCYXNlR2VzdHVyZTxcbiAgICBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPlxuICA+O1xuXG4gIGlmIChoYW5kbGVyKSB7XG4gICAgaWYgKGlzU3RhdGVDaGFuZ2VFdmVudChldmVudCkpIHtcbiAgICAgIGlmIChcbiAgICAgICAgZXZlbnQub2xkU3RhdGUgPT09IFN0YXRlLlVOREVURVJNSU5FRCAmJlxuICAgICAgICBldmVudC5zdGF0ZSA9PT0gU3RhdGUuQkVHQU5cbiAgICAgICkge1xuICAgICAgICBoYW5kbGVyLmhhbmRsZXJzLm9uQmVnaW4/LihldmVudCk7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAoZXZlbnQub2xkU3RhdGUgPT09IFN0YXRlLkJFR0FOIHx8XG4gICAgICAgICAgZXZlbnQub2xkU3RhdGUgPT09IFN0YXRlLlVOREVURVJNSU5FRCkgJiZcbiAgICAgICAgZXZlbnQuc3RhdGUgPT09IFN0YXRlLkFDVElWRVxuICAgICAgKSB7XG4gICAgICAgIGhhbmRsZXIuaGFuZGxlcnMub25TdGFydD8uKGV2ZW50KTtcbiAgICAgICAgbGFzdFVwZGF0ZUV2ZW50W2hhbmRsZXIuaGFuZGxlcnMuaGFuZGxlclRhZ10gPSBldmVudDtcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQub2xkU3RhdGUgIT09IGV2ZW50LnN0YXRlICYmIGV2ZW50LnN0YXRlID09PSBTdGF0ZS5FTkQpIHtcbiAgICAgICAgaWYgKGV2ZW50Lm9sZFN0YXRlID09PSBTdGF0ZS5BQ1RJVkUpIHtcbiAgICAgICAgICBoYW5kbGVyLmhhbmRsZXJzLm9uRW5kPy4oZXZlbnQsIHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIGhhbmRsZXIuaGFuZGxlcnMub25GaW5hbGl6ZT8uKGV2ZW50LCB0cnVlKTtcbiAgICAgICAgbGFzdFVwZGF0ZUV2ZW50W2hhbmRsZXIuaGFuZGxlcnMuaGFuZGxlclRhZ10gPSB1bmRlZmluZWQ7XG4gICAgICB9IGVsc2UgaWYgKFxuICAgICAgICAoZXZlbnQuc3RhdGUgPT09IFN0YXRlLkZBSUxFRCB8fCBldmVudC5zdGF0ZSA9PT0gU3RhdGUuQ0FOQ0VMTEVEKSAmJlxuICAgICAgICBldmVudC5vbGRTdGF0ZSAhPT0gZXZlbnQuc3RhdGVcbiAgICAgICkge1xuICAgICAgICBpZiAoZXZlbnQub2xkU3RhdGUgPT09IFN0YXRlLkFDVElWRSkge1xuICAgICAgICAgIGhhbmRsZXIuaGFuZGxlcnMub25FbmQ/LihldmVudCwgZmFsc2UpO1xuICAgICAgICB9XG4gICAgICAgIGhhbmRsZXIuaGFuZGxlcnMub25GaW5hbGl6ZT8uKGV2ZW50LCBmYWxzZSk7XG4gICAgICAgIGxhc3RVcGRhdGVFdmVudFtoYW5kbGVyLmhhbmRsZXJzLmhhbmRsZXJUYWddID0gdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoaXNUb3VjaEV2ZW50KGV2ZW50KSkge1xuICAgICAgc3dpdGNoIChldmVudC5ldmVudFR5cGUpIHtcbiAgICAgICAgY2FzZSBFdmVudFR5cGUuVE9VQ0hFU19ET1dOOlxuICAgICAgICAgIGhhbmRsZXIuaGFuZGxlcnM/Lm9uVG91Y2hlc0Rvd24/LihldmVudCwgZHVtbXlTdGF0ZU1hbmFnZXIpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIEV2ZW50VHlwZS5UT1VDSEVTX01PVkU6XG4gICAgICAgICAgaGFuZGxlci5oYW5kbGVycz8ub25Ub3VjaGVzTW92ZT8uKGV2ZW50LCBkdW1teVN0YXRlTWFuYWdlcik7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgRXZlbnRUeXBlLlRPVUNIRVNfVVA6XG4gICAgICAgICAgaGFuZGxlci5oYW5kbGVycz8ub25Ub3VjaGVzVXA/LihldmVudCwgZHVtbXlTdGF0ZU1hbmFnZXIpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIEV2ZW50VHlwZS5UT1VDSEVTX0NBTkNFTExFRDpcbiAgICAgICAgICBoYW5kbGVyLmhhbmRsZXJzPy5vblRvdWNoZXNDYW5jZWxsZWQ/LihldmVudCwgZHVtbXlTdGF0ZU1hbmFnZXIpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBoYW5kbGVyLmhhbmRsZXJzLm9uVXBkYXRlPy4oZXZlbnQpO1xuXG4gICAgICBpZiAoaGFuZGxlci5oYW5kbGVycy5vbkNoYW5nZSAmJiBoYW5kbGVyLmhhbmRsZXJzLmNoYW5nZUV2ZW50Q2FsY3VsYXRvcikge1xuICAgICAgICBoYW5kbGVyLmhhbmRsZXJzLm9uQ2hhbmdlPy4oXG4gICAgICAgICAgaGFuZGxlci5oYW5kbGVycy5jaGFuZ2VFdmVudENhbGN1bGF0b3I/LihcbiAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgICAgbGFzdFVwZGF0ZUV2ZW50W2hhbmRsZXIuaGFuZGxlcnMuaGFuZGxlclRhZ11cbiAgICAgICAgICApXG4gICAgICAgICk7XG5cbiAgICAgICAgbGFzdFVwZGF0ZUV2ZW50W2hhbmRsZXIuaGFuZGxlcnMuaGFuZGxlclRhZ10gPSBldmVudDtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgY29uc3Qgb2xkSGFuZGxlciA9IGZpbmRPbGRHZXN0dXJlSGFuZGxlcihldmVudC5oYW5kbGVyVGFnKTtcbiAgICBpZiAob2xkSGFuZGxlcikge1xuICAgICAgY29uc3QgbmF0aXZlRXZlbnQgPSB7IG5hdGl2ZUV2ZW50OiBldmVudCB9O1xuICAgICAgaWYgKGlzU3RhdGVDaGFuZ2VFdmVudChldmVudCkpIHtcbiAgICAgICAgb2xkSGFuZGxlci5vbkdlc3R1cmVTdGF0ZUNoYW5nZShuYXRpdmVFdmVudCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvbGRIYW5kbGVyLm9uR2VzdHVyZUV2ZW50KG5hdGl2ZUV2ZW50KTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN0YXJ0TGlzdGVuaW5nKCkge1xuICBzdG9wTGlzdGVuaW5nKCk7XG5cbiAgZ2VzdHVyZUhhbmRsZXJFdmVudFN1YnNjcmlwdGlvbiA9IERldmljZUV2ZW50RW1pdHRlci5hZGRMaXN0ZW5lcihcbiAgICAnb25HZXN0dXJlSGFuZGxlckV2ZW50JyxcbiAgICBvbkdlc3R1cmVIYW5kbGVyRXZlbnRcbiAgKTtcblxuICBnZXN0dXJlSGFuZGxlclN0YXRlQ2hhbmdlRXZlbnRTdWJzY3JpcHRpb24gPSBEZXZpY2VFdmVudEVtaXR0ZXIuYWRkTGlzdGVuZXIoXG4gICAgJ29uR2VzdHVyZUhhbmRsZXJTdGF0ZUNoYW5nZScsXG4gICAgb25HZXN0dXJlSGFuZGxlckV2ZW50XG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdG9wTGlzdGVuaW5nKCkge1xuICBpZiAoZ2VzdHVyZUhhbmRsZXJFdmVudFN1YnNjcmlwdGlvbikge1xuICAgIGdlc3R1cmVIYW5kbGVyRXZlbnRTdWJzY3JpcHRpb24ucmVtb3ZlKCk7XG4gICAgZ2VzdHVyZUhhbmRsZXJFdmVudFN1YnNjcmlwdGlvbiA9IG51bGw7XG4gIH1cblxuICBpZiAoZ2VzdHVyZUhhbmRsZXJTdGF0ZUNoYW5nZUV2ZW50U3Vic2NyaXB0aW9uKSB7XG4gICAgZ2VzdHVyZUhhbmRsZXJTdGF0ZUNoYW5nZUV2ZW50U3Vic2NyaXB0aW9uLnJlbW92ZSgpO1xuICAgIGdlc3R1cmVIYW5kbGVyU3RhdGVDaGFuZ2VFdmVudFN1YnNjcmlwdGlvbiA9IG51bGw7XG4gIH1cbn1cbiJdfQ==