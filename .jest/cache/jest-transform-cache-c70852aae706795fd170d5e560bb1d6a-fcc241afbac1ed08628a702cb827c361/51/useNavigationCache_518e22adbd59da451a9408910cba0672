fde76b65e2e34929010354a5be5ca6d6
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault2(require("@babel/runtime/helpers/defineProperty"));

var _objectWithoutProperties2 = _interopRequireDefault2(require("@babel/runtime/helpers/objectWithoutProperties"));

var _extends3 = _interopRequireDefault2(require("@babel/runtime/helpers/extends"));

var _excluded = ["emit"];
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = useNavigationCache;

var _routers = require("@react-navigation/routers");

var React = _interopRequireWildcard(require("react"));

var _NavigationBuilderContext = _interopRequireDefault(require("./NavigationBuilderContext"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _getRequireWildcardCache(nodeInterop) {
  if (typeof WeakMap !== "function") return null;
  var cacheBabelInterop = new WeakMap();
  var cacheNodeInterop = new WeakMap();
  return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) {
    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;
  })(nodeInterop);
}

function _interopRequireWildcard(obj, nodeInterop) {
  if (!nodeInterop && obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache(nodeInterop);

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

function useNavigationCache(_ref) {
  var state = _ref.state,
      getState = _ref.getState,
      navigation = _ref.navigation,
      _setOptions = _ref.setOptions,
      router = _ref.router,
      emitter = _ref.emitter;

  var _React$useContext = React.useContext(_NavigationBuilderContext.default),
      stackRef = _React$useContext.stackRef;

  var cache = React.useMemo(function () {
    return {
      current: {}
    };
  }, [getState, navigation, _setOptions, router, emitter]);
  var actions = (0, _extends3.default)({}, router.actionCreators, _routers.CommonActions);
  cache.current = state.routes.reduce(function (acc, route) {
    var previous = cache.current[route.key];

    if (previous) {
      acc[route.key] = previous;
    } else {
      var emit = navigation.emit,
          rest = (0, _objectWithoutProperties2.default)(navigation, _excluded);

      var _dispatch = function dispatch(thunk) {
        var action = typeof thunk === 'function' ? thunk(getState()) : thunk;

        if (action != null) {
          navigation.dispatch((0, _extends3.default)({
            source: route.key
          }, action));
        }
      };

      var withStack = function withStack(callback) {
        var isStackSet = false;

        try {
          if (process.env.NODE_ENV !== 'production' && stackRef && !stackRef.current) {
            stackRef.current = new Error().stack;
            isStackSet = true;
          }

          callback();
        } finally {
          if (isStackSet && stackRef) {
            stackRef.current = undefined;
          }
        }
      };

      var helpers = Object.keys(actions).reduce(function (acc, name) {
        acc[name] = function () {
          for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
            args[_key] = arguments[_key];
          }

          return withStack(function () {
            return _dispatch(actions[name].apply(actions, args));
          });
        };

        return acc;
      }, {});
      acc[route.key] = (0, _extends3.default)({}, rest, helpers, emitter.create(route.key), {
        dispatch: function dispatch(thunk) {
          return withStack(function () {
            return _dispatch(thunk);
          });
        },
        setOptions: function setOptions(options) {
          return _setOptions(function (o) {
            return (0, _extends3.default)({}, o, (0, _defineProperty2.default)({}, route.key, (0, _extends3.default)({}, o[route.key], options)));
          });
        },
        isFocused: function isFocused() {
          var state = getState();

          if (state.routes[state.index].key !== route.key) {
            return false;
          }

          return navigation ? navigation.isFocused() : true;
        }
      });
    }

    return acc;
  }, {});
  return cache.current;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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Q0UsT0FBYjtBQUNEIiwibmFtZXMiOlsidXNlTmF2aWdhdGlvbkNhY2hlIiwic3RhdGUiLCJnZXRTdGF0ZSIsIm5hdmlnYXRpb24iLCJzZXRPcHRpb25zIiwicm91dGVyIiwiZW1pdHRlciIsIlJlYWN0IiwidXNlQ29udGV4dCIsIk5hdmlnYXRpb25CdWlsZGVyQ29udGV4dCIsInN0YWNrUmVmIiwiY2FjaGUiLCJ1c2VNZW1vIiwiY3VycmVudCIsImFjdGlvbnMiLCJhY3Rpb25DcmVhdG9ycyIsIkNvbW1vbkFjdGlvbnMiLCJyb3V0ZXMiLCJyZWR1Y2UiLCJhY2MiLCJyb3V0ZSIsInByZXZpb3VzIiwia2V5IiwiZW1pdCIsInJlc3QiLCJkaXNwYXRjaCIsInRodW5rIiwiYWN0aW9uIiwic291cmNlIiwid2l0aFN0YWNrIiwiY2FsbGJhY2siLCJpc1N0YWNrU2V0IiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwiRXJyb3IiLCJzdGFjayIsInVuZGVmaW5lZCIsImhlbHBlcnMiLCJPYmplY3QiLCJrZXlzIiwibmFtZSIsImFyZ3MiLCJhcmd1bWVudHMiLCJjcmVhdGUiLCJvcHRpb25zIiwibyIsImlzRm9jdXNlZCIsImluZGV4Il0sInNvdXJjZXMiOlsidXNlTmF2aWdhdGlvbkNhY2hlLnRzeCJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21tb25BY3Rpb25zLFxuICBOYXZpZ2F0aW9uQWN0aW9uLFxuICBOYXZpZ2F0aW9uU3RhdGUsXG4gIFBhcmFtTGlzdEJhc2UsXG4gIFJvdXRlcixcbn0gZnJvbSAnQHJlYWN0LW5hdmlnYXRpb24vcm91dGVycyc7XG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XG5cbmltcG9ydCBOYXZpZ2F0aW9uQnVpbGRlckNvbnRleHQgZnJvbSAnLi9OYXZpZ2F0aW9uQnVpbGRlckNvbnRleHQnO1xuaW1wb3J0IHR5cGUgeyBOYXZpZ2F0aW9uSGVscGVycywgTmF2aWdhdGlvblByb3AgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB0eXBlIHsgTmF2aWdhdGlvbkV2ZW50RW1pdHRlciB9IGZyb20gJy4vdXNlRXZlbnRFbWl0dGVyJztcblxudHlwZSBPcHRpb25zPFxuICBTdGF0ZSBleHRlbmRzIE5hdmlnYXRpb25TdGF0ZSxcbiAgRXZlbnRNYXAgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4+ID0ge1xuICBzdGF0ZTogU3RhdGU7XG4gIGdldFN0YXRlOiAoKSA9PiBTdGF0ZTtcbiAgbmF2aWdhdGlvbjogTmF2aWdhdGlvbkhlbHBlcnM8UGFyYW1MaXN0QmFzZT4gJlxuICAgIFBhcnRpYWw8TmF2aWdhdGlvblByb3A8UGFyYW1MaXN0QmFzZSwgc3RyaW5nLCBhbnksIGFueSwgYW55Pj47XG4gIHNldE9wdGlvbnM6IChcbiAgICBjYjogKG9wdGlvbnM6IFJlY29yZDxzdHJpbmcsIG9iamVjdD4pID0+IFJlY29yZDxzdHJpbmcsIG9iamVjdD5cbiAgKSA9PiB2b2lkO1xuICByb3V0ZXI6IFJvdXRlcjxTdGF0ZSwgTmF2aWdhdGlvbkFjdGlvbj47XG4gIGVtaXR0ZXI6IE5hdmlnYXRpb25FdmVudEVtaXR0ZXI8RXZlbnRNYXA+O1xufTtcblxudHlwZSBOYXZpZ2F0aW9uQ2FjaGU8XG4gIFN0YXRlIGV4dGVuZHMgTmF2aWdhdGlvblN0YXRlLFxuICBTY3JlZW5PcHRpb25zIGV4dGVuZHMge30sXG4gIEV2ZW50TWFwIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55PlxuPiA9IFJlY29yZDxcbiAgc3RyaW5nLFxuICBOYXZpZ2F0aW9uUHJvcDxQYXJhbUxpc3RCYXNlLCBzdHJpbmcsIFN0YXRlLCBTY3JlZW5PcHRpb25zLCBFdmVudE1hcD5cbj47XG5cbi8qKlxuICogSG9vayB0byBjYWNoZSBuYXZpZ2F0aW9uIG9iamVjdHMgZm9yIGVhY2ggc2NyZWVuIGluIHRoZSBuYXZpZ2F0b3IuXG4gKiBJdCdzIGltcG9ydGFudCB0byBjYWNoZSB0aGVtIHRvIG1ha2Ugc3VyZSBuYXZpZ2F0aW9uIG9iamVjdHMgZG9uJ3QgY2hhbmdlIGJldHdlZW4gcmVuZGVycy5cbiAqIFRoaXMgbGV0cyB1cyBhcHBseSBvcHRpbWl6YXRpb25zIGxpa2UgYFJlYWN0Lm1lbW9gIHRvIG1pbmltaXplIHJlLXJlbmRlcmluZyBzY3JlZW5zLlxuICovXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB1c2VOYXZpZ2F0aW9uQ2FjaGU8XG4gIFN0YXRlIGV4dGVuZHMgTmF2aWdhdGlvblN0YXRlLFxuICBTY3JlZW5PcHRpb25zIGV4dGVuZHMge30sXG4gIEV2ZW50TWFwIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55PlxuPih7XG4gIHN0YXRlLFxuICBnZXRTdGF0ZSxcbiAgbmF2aWdhdGlvbixcbiAgc2V0T3B0aW9ucyxcbiAgcm91dGVyLFxuICBlbWl0dGVyLFxufTogT3B0aW9uczxTdGF0ZSwgRXZlbnRNYXA+KSB7XG4gIGNvbnN0IHsgc3RhY2tSZWYgfSA9IFJlYWN0LnVzZUNvbnRleHQoTmF2aWdhdGlvbkJ1aWxkZXJDb250ZXh0KTtcblxuICAvLyBDYWNoZSBvYmplY3Qgd2hpY2ggaG9sZHMgbmF2aWdhdGlvbiBvYmplY3RzIGZvciBlYWNoIHNjcmVlblxuICAvLyBXZSB1c2UgYFJlYWN0LnVzZU1lbW9gIGluc3RlYWQgb2YgYFJlYWN0LnVzZVJlZmAgY296IHdlIHdhbnQgdG8gaW52YWxpZGF0ZSBpdCB3aGVuIGRlcHMgY2hhbmdlXG4gIC8vIEluIHJlYWxpdHksIHRoZXNlIGRlcHMgd2lsbCByYXJlbHkgY2hhbmdlLCBpZiBldmVyXG4gIGNvbnN0IGNhY2hlID0gUmVhY3QudXNlTWVtbyhcbiAgICAoKSA9PiAoeyBjdXJyZW50OiB7fSBhcyBOYXZpZ2F0aW9uQ2FjaGU8U3RhdGUsIFNjcmVlbk9wdGlvbnMsIEV2ZW50TWFwPiB9KSxcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzXG4gICAgW2dldFN0YXRlLCBuYXZpZ2F0aW9uLCBzZXRPcHRpb25zLCByb3V0ZXIsIGVtaXR0ZXJdXG4gICk7XG5cbiAgY29uc3QgYWN0aW9ucyA9IHtcbiAgICAuLi5yb3V0ZXIuYWN0aW9uQ3JlYXRvcnMsXG4gICAgLi4uQ29tbW9uQWN0aW9ucyxcbiAgfTtcblxuICBjYWNoZS5jdXJyZW50ID0gc3RhdGUucm91dGVzLnJlZHVjZTxcbiAgICBOYXZpZ2F0aW9uQ2FjaGU8U3RhdGUsIFNjcmVlbk9wdGlvbnMsIEV2ZW50TWFwPlxuICA+KChhY2MsIHJvdXRlKSA9PiB7XG4gICAgY29uc3QgcHJldmlvdXMgPSBjYWNoZS5jdXJyZW50W3JvdXRlLmtleV07XG5cbiAgICB0eXBlIFRodW5rID1cbiAgICAgIHwgTmF2aWdhdGlvbkFjdGlvblxuICAgICAgfCAoKHN0YXRlOiBTdGF0ZSkgPT4gTmF2aWdhdGlvbkFjdGlvbiB8IG51bGwgfCB1bmRlZmluZWQpO1xuXG4gICAgaWYgKHByZXZpb3VzKSB7XG4gICAgICAvLyBJZiBhIGNhY2hlZCBuYXZpZ2F0aW9uIG9iamVjdCBhbHJlYWR5IGV4aXN0cywgcmV1c2UgaXRcbiAgICAgIGFjY1tyb3V0ZS5rZXldID0gcHJldmlvdXM7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnNcbiAgICAgIGNvbnN0IHsgZW1pdCwgLi4ucmVzdCB9ID0gbmF2aWdhdGlvbjtcblxuICAgICAgY29uc3QgZGlzcGF0Y2ggPSAodGh1bms6IFRodW5rKSA9PiB7XG4gICAgICAgIGNvbnN0IGFjdGlvbiA9IHR5cGVvZiB0aHVuayA9PT0gJ2Z1bmN0aW9uJyA/IHRodW5rKGdldFN0YXRlKCkpIDogdGh1bms7XG5cbiAgICAgICAgaWYgKGFjdGlvbiAhPSBudWxsKSB7XG4gICAgICAgICAgbmF2aWdhdGlvbi5kaXNwYXRjaCh7IHNvdXJjZTogcm91dGUua2V5LCAuLi5hY3Rpb24gfSk7XG4gICAgICAgIH1cbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IHdpdGhTdGFjayA9IChjYWxsYmFjazogKCkgPT4gdm9pZCkgPT4ge1xuICAgICAgICBsZXQgaXNTdGFja1NldCA9IGZhbHNlO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJlxuICAgICAgICAgICAgc3RhY2tSZWYgJiZcbiAgICAgICAgICAgICFzdGFja1JlZi5jdXJyZW50XG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICAvLyBDYXB0dXJlIHRoZSBzdGFjayB0cmFjZSBmb3IgZGV2dG9vbHNcbiAgICAgICAgICAgIHN0YWNrUmVmLmN1cnJlbnQgPSBuZXcgRXJyb3IoKS5zdGFjaztcbiAgICAgICAgICAgIGlzU3RhY2tTZXQgPSB0cnVlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgaWYgKGlzU3RhY2tTZXQgJiYgc3RhY2tSZWYpIHtcbiAgICAgICAgICAgIHN0YWNrUmVmLmN1cnJlbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBjb25zdCBoZWxwZXJzID0gT2JqZWN0LmtleXMoYWN0aW9ucykucmVkdWNlPFJlY29yZDxzdHJpbmcsICgpID0+IHZvaWQ+PihcbiAgICAgICAgKGFjYywgbmFtZSkgPT4ge1xuICAgICAgICAgIGFjY1tuYW1lXSA9ICguLi5hcmdzOiBhbnkpID0+XG4gICAgICAgICAgICB3aXRoU3RhY2soKCkgPT5cbiAgICAgICAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvcjogbmFtZSBpcyBhIHZhbGlkIGtleSwgYnV0IFR5cGVTY3JpcHQgaXMgZHVtYlxuICAgICAgICAgICAgICBkaXNwYXRjaChhY3Rpb25zW25hbWVdKC4uLmFyZ3MpKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgIHJldHVybiBhY2M7XG4gICAgICAgIH0sXG4gICAgICAgIHt9XG4gICAgICApO1xuXG4gICAgICBhY2Nbcm91dGUua2V5XSA9IHtcbiAgICAgICAgLi4ucmVzdCxcbiAgICAgICAgLi4uaGVscGVycyxcbiAgICAgICAgLy8gRklYTUU6IHRvbyBtdWNoIHdvcmsgdG8gZml4IHRoZSB0eXBlcyBmb3Igbm93XG4gICAgICAgIC4uLihlbWl0dGVyLmNyZWF0ZShyb3V0ZS5rZXkpIGFzIGFueSksXG4gICAgICAgIGRpc3BhdGNoOiAodGh1bms6IFRodW5rKSA9PiB3aXRoU3RhY2soKCkgPT4gZGlzcGF0Y2godGh1bmspKSxcbiAgICAgICAgc2V0T3B0aW9uczogKG9wdGlvbnM6IG9iamVjdCkgPT5cbiAgICAgICAgICBzZXRPcHRpb25zKChvKSA9PiAoe1xuICAgICAgICAgICAgLi4ubyxcbiAgICAgICAgICAgIFtyb3V0ZS5rZXldOiB7IC4uLm9bcm91dGUua2V5XSwgLi4ub3B0aW9ucyB9LFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgaXNGb2N1c2VkOiAoKSA9PiB7XG4gICAgICAgICAgY29uc3Qgc3RhdGUgPSBnZXRTdGF0ZSgpO1xuXG4gICAgICAgICAgaWYgKHN0YXRlLnJvdXRlc1tzdGF0ZS5pbmRleF0ua2V5ICE9PSByb3V0ZS5rZXkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICAvLyBJZiB0aGUgY3VycmVudCBzY3JlZW4gaXMgZm9jdXNlZCwgd2UgYWxzbyBuZWVkIHRvIGNoZWNrIGlmIHBhcmVudCBuYXZpZ2F0b3IgaXMgZm9jdXNlZFxuICAgICAgICAgIC8vIFRoaXMgbWFrZXMgc3VyZSB0aGF0IHdlIHJldHVybiB0aGUgZm9jdXMgc3RhdGUgaW4gdGhlIHdob2xlIHRyZWUsIG5vdCBqdXN0IHRoaXMgbmF2aWdhdG9yXG4gICAgICAgICAgcmV0dXJuIG5hdmlnYXRpb24gPyBuYXZpZ2F0aW9uLmlzRm9jdXNlZCgpIDogdHJ1ZTtcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIGFjYztcbiAgfSwge30pO1xuXG4gIHJldHVybiBjYWNoZS5jdXJyZW50O1xufVxuIl19