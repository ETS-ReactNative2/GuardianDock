8cc4dcf3596b83c967723b8f95fc56d5
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var AnimatedValue = require('./nodes/AnimatedValue');

var AnimatedValueXY = require('./nodes/AnimatedValueXY');

var NativeAnimatedHelper = require('./NativeAnimatedHelper');

var ReactNative = require('../Renderer/shims/ReactNative');

var invariant = require('invariant');

var _require = require('./NativeAnimatedHelper'),
    shouldUseNativeDriver = _require.shouldUseNativeDriver;

function attachNativeEvent(viewRef, eventName, argMapping) {
  var eventMappings = [];

  var traverse = function traverse(value, path) {
    if (value instanceof AnimatedValue) {
      value.__makeNative();

      eventMappings.push({
        nativeEventPath: path,
        animatedValueTag: value.__getNativeTag()
      });
    } else if (value instanceof AnimatedValueXY) {
      traverse(value.x, path.concat('x'));
      traverse(value.y, path.concat('y'));
    } else if (typeof value === 'object') {
      for (var _key in value) {
        traverse(value[_key], path.concat(_key));
      }
    }
  };

  invariant(argMapping[0] && argMapping[0].nativeEvent, 'Native driven events only support animated values contained inside `nativeEvent`.');
  traverse(argMapping[0].nativeEvent, []);
  var viewTag = ReactNative.findNodeHandle(viewRef);

  if (viewTag != null) {
    eventMappings.forEach(function (mapping) {
      NativeAnimatedHelper.API.addAnimatedEventToView(viewTag, eventName, mapping);
    });
  }

  return {
    detach: function detach() {
      if (viewTag != null) {
        eventMappings.forEach(function (mapping) {
          NativeAnimatedHelper.API.removeAnimatedEventFromView(viewTag, eventName, mapping.animatedValueTag);
        });
      }
    }
  };
}

function validateMapping(argMapping, args) {
  var validate = function validate(recMapping, recEvt, key) {
    if (recMapping instanceof AnimatedValue) {
      invariant(typeof recEvt === 'number', 'Bad mapping of event key ' + key + ', should be number but got ' + typeof recEvt);
      return;
    }

    if (recMapping instanceof AnimatedValueXY) {
      invariant(typeof recEvt.x === 'number' && typeof recEvt.y === 'number', 'Bad mapping of event key ' + key + ', should be XY but got ' + recEvt);
      return;
    }

    if (typeof recEvt === 'number') {
      invariant(recMapping instanceof AnimatedValue, 'Bad mapping of type ' + typeof recMapping + ' for key ' + key + ', event value must map to AnimatedValue');
      return;
    }

    invariant(typeof recMapping === 'object', 'Bad mapping of type ' + typeof recMapping + ' for key ' + key);
    invariant(typeof recEvt === 'object', 'Bad event of type ' + typeof recEvt + ' for key ' + key);

    for (var mappingKey in recMapping) {
      validate(recMapping[mappingKey], recEvt[mappingKey], mappingKey);
    }
  };

  invariant(args.length >= argMapping.length, 'Event has less arguments than mapping');
  argMapping.forEach(function (mapping, idx) {
    validate(mapping, args[idx], 'arg' + idx);
  });
}

var AnimatedEvent = function () {
  function AnimatedEvent(argMapping, config) {
    (0, _classCallCheck2.default)(this, AnimatedEvent);
    this._listeners = [];
    this._argMapping = argMapping;

    if (config == null) {
      console.warn('Animated.event now requires a second argument for options');
      config = {
        useNativeDriver: false
      };
    }

    if (config.listener) {
      this.__addListener(config.listener);
    }

    this._callListeners = this._callListeners.bind(this);
    this._attachedEvent = null;
    this.__isNative = shouldUseNativeDriver(config);
  }

  (0, _createClass2.default)(AnimatedEvent, [{
    key: "__addListener",
    value: function __addListener(callback) {
      this._listeners.push(callback);
    }
  }, {
    key: "__removeListener",
    value: function __removeListener(callback) {
      this._listeners = this._listeners.filter(function (listener) {
        return listener !== callback;
      });
    }
  }, {
    key: "__attach",
    value: function __attach(viewRef, eventName) {
      invariant(this.__isNative, 'Only native driven events need to be attached.');
      this._attachedEvent = attachNativeEvent(viewRef, eventName, this._argMapping);
    }
  }, {
    key: "__detach",
    value: function __detach(viewTag, eventName) {
      invariant(this.__isNative, 'Only native driven events need to be detached.');
      this._attachedEvent && this._attachedEvent.detach();
    }
  }, {
    key: "__getHandler",
    value: function __getHandler() {
      var _this = this;

      if (this.__isNative) {
        if (__DEV__) {
          var _validatedMapping = false;
          return function () {
            for (var _len = arguments.length, args = new Array(_len), _key2 = 0; _key2 < _len; _key2++) {
              args[_key2] = arguments[_key2];
            }

            if (!_validatedMapping) {
              validateMapping(_this._argMapping, args);
              _validatedMapping = true;
            }

            _this._callListeners.apply(_this, args);
          };
        } else {
          return this._callListeners;
        }
      }

      var validatedMapping = false;
      return function () {
        for (var _len2 = arguments.length, args = new Array(_len2), _key3 = 0; _key3 < _len2; _key3++) {
          args[_key3] = arguments[_key3];
        }

        if (__DEV__ && !validatedMapping) {
          validateMapping(_this._argMapping, args);
          validatedMapping = true;
        }

        var traverse = function traverse(recMapping, recEvt) {
          if (recMapping instanceof AnimatedValue) {
            if (typeof recEvt === 'number') {
              recMapping.setValue(recEvt);
            }
          } else if (recMapping instanceof AnimatedValueXY) {
            if (typeof recEvt === 'object') {
              traverse(recMapping.x, recEvt.x);
              traverse(recMapping.y, recEvt.y);
            }
          } else if (typeof recMapping === 'object') {
            for (var mappingKey in recMapping) {
              traverse(recMapping[mappingKey], recEvt[mappingKey]);
            }
          }
        };

        _this._argMapping.forEach(function (mapping, idx) {
          traverse(mapping, args[idx]);
        });

        _this._callListeners.apply(_this, args);
      };
    }
  }, {
    key: "_callListeners",
    value: function _callListeners() {
      for (var _len3 = arguments.length, args = new Array(_len3), _key4 = 0; _key4 < _len3; _key4++) {
        args[_key4] = arguments[_key4];
      }

      this._listeners.forEach(function (listener) {
        return listener.apply(void 0, args);
      });
    }
  }]);
  return AnimatedEvent;
}();

module.exports = {
  AnimatedEvent: AnimatedEvent,
  attachNativeEvent: attachNativeEvent
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFuaW1hdGVkRXZlbnQuanMiXSwibmFtZXMiOlsiQW5pbWF0ZWRWYWx1ZSIsInJlcXVpcmUiLCJBbmltYXRlZFZhbHVlWFkiLCJOYXRpdmVBbmltYXRlZEhlbHBlciIsIlJlYWN0TmF0aXZlIiwiaW52YXJpYW50Iiwic2hvdWxkVXNlTmF0aXZlRHJpdmVyIiwiYXR0YWNoTmF0aXZlRXZlbnQiLCJ2aWV3UmVmIiwiZXZlbnROYW1lIiwiYXJnTWFwcGluZyIsImV2ZW50TWFwcGluZ3MiLCJ0cmF2ZXJzZSIsInZhbHVlIiwicGF0aCIsIl9fbWFrZU5hdGl2ZSIsInB1c2giLCJuYXRpdmVFdmVudFBhdGgiLCJhbmltYXRlZFZhbHVlVGFnIiwiX19nZXROYXRpdmVUYWciLCJ4IiwiY29uY2F0IiwieSIsImtleSIsIm5hdGl2ZUV2ZW50Iiwidmlld1RhZyIsImZpbmROb2RlSGFuZGxlIiwiZm9yRWFjaCIsIm1hcHBpbmciLCJBUEkiLCJhZGRBbmltYXRlZEV2ZW50VG9WaWV3IiwiZGV0YWNoIiwicmVtb3ZlQW5pbWF0ZWRFdmVudEZyb21WaWV3IiwidmFsaWRhdGVNYXBwaW5nIiwiYXJncyIsInZhbGlkYXRlIiwicmVjTWFwcGluZyIsInJlY0V2dCIsIm1hcHBpbmdLZXkiLCJsZW5ndGgiLCJpZHgiLCJBbmltYXRlZEV2ZW50IiwiY29uZmlnIiwiX2xpc3RlbmVycyIsIl9hcmdNYXBwaW5nIiwiY29uc29sZSIsIndhcm4iLCJ1c2VOYXRpdmVEcml2ZXIiLCJsaXN0ZW5lciIsIl9fYWRkTGlzdGVuZXIiLCJfY2FsbExpc3RlbmVycyIsImJpbmQiLCJfYXR0YWNoZWRFdmVudCIsIl9faXNOYXRpdmUiLCJjYWxsYmFjayIsImZpbHRlciIsIl9fREVWX18iLCJ2YWxpZGF0ZWRNYXBwaW5nIiwic2V0VmFsdWUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFVQTs7Ozs7Ozs7QUFFQSxJQUFNQSxhQUFhLEdBQUdDLE9BQU8sQ0FBQyx1QkFBRCxDQUE3Qjs7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QixPQUFoQixDQUF3QixVQUFBcUIsUUFBUTtBQUFBLGVBQUlBLFFBQVEsTUFBUixTQUFZZCxJQUFaLENBQUo7QUFBQSxPQUFoQztBQUNEOzs7OztBQUdIeUIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCO0FBQUNuQixFQUFBQSxhQUFhLEVBQWJBLGFBQUQ7QUFBZ0JsQyxFQUFBQSxpQkFBaUIsRUFBakJBO0FBQWhCLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgKGMpIEZhY2Vib29rLCBJbmMuIGFuZCBpdHMgYWZmaWxpYXRlcy5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZSBmb3VuZCBpbiB0aGVcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqXG4gKiBAZmxvd1xuICogQGZvcm1hdFxuICovXG5cbid1c2Ugc3RyaWN0JztcblxuY29uc3QgQW5pbWF0ZWRWYWx1ZSA9IHJlcXVpcmUoJy4vbm9kZXMvQW5pbWF0ZWRWYWx1ZScpO1xuY29uc3QgQW5pbWF0ZWRWYWx1ZVhZID0gcmVxdWlyZSgnLi9ub2Rlcy9BbmltYXRlZFZhbHVlWFknKTtcbmNvbnN0IE5hdGl2ZUFuaW1hdGVkSGVscGVyID0gcmVxdWlyZSgnLi9OYXRpdmVBbmltYXRlZEhlbHBlcicpO1xuY29uc3QgUmVhY3ROYXRpdmUgPSByZXF1aXJlKCcuLi9SZW5kZXJlci9zaGltcy9SZWFjdE5hdGl2ZScpO1xuXG5jb25zdCBpbnZhcmlhbnQgPSByZXF1aXJlKCdpbnZhcmlhbnQnKTtcblxuY29uc3Qge3Nob3VsZFVzZU5hdGl2ZURyaXZlcn0gPSByZXF1aXJlKCcuL05hdGl2ZUFuaW1hdGVkSGVscGVyJyk7XG5cbmV4cG9ydCB0eXBlIE1hcHBpbmcgPVxuICB8IHtba2V5OiBzdHJpbmddOiBNYXBwaW5nLCAuLi59XG4gIHwgQW5pbWF0ZWRWYWx1ZVxuICB8IEFuaW1hdGVkVmFsdWVYWTtcbmV4cG9ydCB0eXBlIEV2ZW50Q29uZmlnID0ge1xuICBsaXN0ZW5lcj86ID9GdW5jdGlvbixcbiAgdXNlTmF0aXZlRHJpdmVyOiBib29sZWFuLFxufTtcblxuZnVuY3Rpb24gYXR0YWNoTmF0aXZlRXZlbnQoXG4gIHZpZXdSZWY6IGFueSxcbiAgZXZlbnROYW1lOiBzdHJpbmcsXG4gIGFyZ01hcHBpbmc6ICRSZWFkT25seUFycmF5PD9NYXBwaW5nPixcbik6IHtkZXRhY2g6ICgpID0+IHZvaWR9IHtcbiAgLy8gRmluZCBhbmltYXRlZCB2YWx1ZXMgaW4gYGFyZ01hcHBpbmdgIGFuZCBjcmVhdGUgYW4gYXJyYXkgcmVwcmVzZW50aW5nIHRoZWlyXG4gIC8vIGtleSBwYXRoIGluc2lkZSB0aGUgYG5hdGl2ZUV2ZW50YCBvYmplY3QuIEV4LjogWydjb250ZW50T2Zmc2V0JywgJ3gnXS5cbiAgY29uc3QgZXZlbnRNYXBwaW5ncyA9IFtdO1xuXG4gIGNvbnN0IHRyYXZlcnNlID0gKHZhbHVlLCBwYXRoKSA9PiB7XG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQW5pbWF0ZWRWYWx1ZSkge1xuICAgICAgdmFsdWUuX19tYWtlTmF0aXZlKCk7XG5cbiAgICAgIGV2ZW50TWFwcGluZ3MucHVzaCh7XG4gICAgICAgIG5hdGl2ZUV2ZW50UGF0aDogcGF0aCxcbiAgICAgICAgYW5pbWF0ZWRWYWx1ZVRhZzogdmFsdWUuX19nZXROYXRpdmVUYWcoKSxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBBbmltYXRlZFZhbHVlWFkpIHtcbiAgICAgIHRyYXZlcnNlKHZhbHVlLngsIHBhdGguY29uY2F0KCd4JykpO1xuICAgICAgdHJhdmVyc2UodmFsdWUueSwgcGF0aC5jb25jYXQoJ3knKSk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiB2YWx1ZSkge1xuICAgICAgICB0cmF2ZXJzZSh2YWx1ZVtrZXldLCBwYXRoLmNvbmNhdChrZXkpKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgaW52YXJpYW50KFxuICAgIGFyZ01hcHBpbmdbMF0gJiYgYXJnTWFwcGluZ1swXS5uYXRpdmVFdmVudCxcbiAgICAnTmF0aXZlIGRyaXZlbiBldmVudHMgb25seSBzdXBwb3J0IGFuaW1hdGVkIHZhbHVlcyBjb250YWluZWQgaW5zaWRlIGBuYXRpdmVFdmVudGAuJyxcbiAgKTtcblxuICAvLyBBc3N1bWUgdGhhdCB0aGUgZXZlbnQgY29udGFpbmluZyBgbmF0aXZlRXZlbnRgIGlzIGFsd2F5cyB0aGUgZmlyc3QgYXJndW1lbnQuXG4gIHRyYXZlcnNlKGFyZ01hcHBpbmdbMF0ubmF0aXZlRXZlbnQsIFtdKTtcblxuICBjb25zdCB2aWV3VGFnID0gUmVhY3ROYXRpdmUuZmluZE5vZGVIYW5kbGUodmlld1JlZik7XG4gIGlmICh2aWV3VGFnICE9IG51bGwpIHtcbiAgICBldmVudE1hcHBpbmdzLmZvckVhY2gobWFwcGluZyA9PiB7XG4gICAgICBOYXRpdmVBbmltYXRlZEhlbHBlci5BUEkuYWRkQW5pbWF0ZWRFdmVudFRvVmlldyhcbiAgICAgICAgdmlld1RhZyxcbiAgICAgICAgZXZlbnROYW1lLFxuICAgICAgICBtYXBwaW5nLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZGV0YWNoKCkge1xuICAgICAgaWYgKHZpZXdUYWcgIT0gbnVsbCkge1xuICAgICAgICBldmVudE1hcHBpbmdzLmZvckVhY2gobWFwcGluZyA9PiB7XG4gICAgICAgICAgTmF0aXZlQW5pbWF0ZWRIZWxwZXIuQVBJLnJlbW92ZUFuaW1hdGVkRXZlbnRGcm9tVmlldyhcbiAgICAgICAgICAgIHZpZXdUYWcsXG4gICAgICAgICAgICBldmVudE5hbWUsXG4gICAgICAgICAgICAvLyAkRmxvd0ZpeE1lW2luY29tcGF0aWJsZS1jYWxsXVxuICAgICAgICAgICAgbWFwcGluZy5hbmltYXRlZFZhbHVlVGFnLFxuICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0sXG4gIH07XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlTWFwcGluZyhhcmdNYXBwaW5nLCBhcmdzKSB7XG4gIGNvbnN0IHZhbGlkYXRlID0gKHJlY01hcHBpbmcsIHJlY0V2dCwga2V5KSA9PiB7XG4gICAgaWYgKHJlY01hcHBpbmcgaW5zdGFuY2VvZiBBbmltYXRlZFZhbHVlKSB7XG4gICAgICBpbnZhcmlhbnQoXG4gICAgICAgIHR5cGVvZiByZWNFdnQgPT09ICdudW1iZXInLFxuICAgICAgICAnQmFkIG1hcHBpbmcgb2YgZXZlbnQga2V5ICcgK1xuICAgICAgICAgIGtleSArXG4gICAgICAgICAgJywgc2hvdWxkIGJlIG51bWJlciBidXQgZ290ICcgK1xuICAgICAgICAgIHR5cGVvZiByZWNFdnQsXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAocmVjTWFwcGluZyBpbnN0YW5jZW9mIEFuaW1hdGVkVmFsdWVYWSkge1xuICAgICAgaW52YXJpYW50KFxuICAgICAgICB0eXBlb2YgcmVjRXZ0LnggPT09ICdudW1iZXInICYmIHR5cGVvZiByZWNFdnQueSA9PT0gJ251bWJlcicsXG4gICAgICAgICdCYWQgbWFwcGluZyBvZiBldmVudCBrZXkgJyArIGtleSArICcsIHNob3VsZCBiZSBYWSBidXQgZ290ICcgKyByZWNFdnQsXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHJlY0V2dCA9PT0gJ251bWJlcicpIHtcbiAgICAgIGludmFyaWFudChcbiAgICAgICAgcmVjTWFwcGluZyBpbnN0YW5jZW9mIEFuaW1hdGVkVmFsdWUsXG4gICAgICAgICdCYWQgbWFwcGluZyBvZiB0eXBlICcgK1xuICAgICAgICAgIHR5cGVvZiByZWNNYXBwaW5nICtcbiAgICAgICAgICAnIGZvciBrZXkgJyArXG4gICAgICAgICAga2V5ICtcbiAgICAgICAgICAnLCBldmVudCB2YWx1ZSBtdXN0IG1hcCB0byBBbmltYXRlZFZhbHVlJyxcbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGludmFyaWFudChcbiAgICAgIHR5cGVvZiByZWNNYXBwaW5nID09PSAnb2JqZWN0JyxcbiAgICAgICdCYWQgbWFwcGluZyBvZiB0eXBlICcgKyB0eXBlb2YgcmVjTWFwcGluZyArICcgZm9yIGtleSAnICsga2V5LFxuICAgICk7XG4gICAgaW52YXJpYW50KFxuICAgICAgdHlwZW9mIHJlY0V2dCA9PT0gJ29iamVjdCcsXG4gICAgICAnQmFkIGV2ZW50IG9mIHR5cGUgJyArIHR5cGVvZiByZWNFdnQgKyAnIGZvciBrZXkgJyArIGtleSxcbiAgICApO1xuICAgIGZvciAoY29uc3QgbWFwcGluZ0tleSBpbiByZWNNYXBwaW5nKSB7XG4gICAgICB2YWxpZGF0ZShyZWNNYXBwaW5nW21hcHBpbmdLZXldLCByZWNFdnRbbWFwcGluZ0tleV0sIG1hcHBpbmdLZXkpO1xuICAgIH1cbiAgfTtcblxuICBpbnZhcmlhbnQoXG4gICAgYXJncy5sZW5ndGggPj0gYXJnTWFwcGluZy5sZW5ndGgsXG4gICAgJ0V2ZW50IGhhcyBsZXNzIGFyZ3VtZW50cyB0aGFuIG1hcHBpbmcnLFxuICApO1xuICBhcmdNYXBwaW5nLmZvckVhY2goKG1hcHBpbmcsIGlkeCkgPT4ge1xuICAgIHZhbGlkYXRlKG1hcHBpbmcsIGFyZ3NbaWR4XSwgJ2FyZycgKyBpZHgpO1xuICB9KTtcbn1cblxuY2xhc3MgQW5pbWF0ZWRFdmVudCB7XG4gIF9hcmdNYXBwaW5nOiAkUmVhZE9ubHlBcnJheTw/TWFwcGluZz47XG4gIF9saXN0ZW5lcnM6IEFycmF5PEZ1bmN0aW9uPiA9IFtdO1xuICBfY2FsbExpc3RlbmVyczogRnVuY3Rpb247XG4gIF9hdHRhY2hlZEV2ZW50OiA/e2RldGFjaDogKCkgPT4gdm9pZCwgLi4ufTtcbiAgX19pc05hdGl2ZTogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihhcmdNYXBwaW5nOiAkUmVhZE9ubHlBcnJheTw/TWFwcGluZz4sIGNvbmZpZzogRXZlbnRDb25maWcpIHtcbiAgICB0aGlzLl9hcmdNYXBwaW5nID0gYXJnTWFwcGluZztcblxuICAgIGlmIChjb25maWcgPT0gbnVsbCkge1xuICAgICAgY29uc29sZS53YXJuKCdBbmltYXRlZC5ldmVudCBub3cgcmVxdWlyZXMgYSBzZWNvbmQgYXJndW1lbnQgZm9yIG9wdGlvbnMnKTtcbiAgICAgIGNvbmZpZyA9IHt1c2VOYXRpdmVEcml2ZXI6IGZhbHNlfTtcbiAgICB9XG5cbiAgICBpZiAoY29uZmlnLmxpc3RlbmVyKSB7XG4gICAgICB0aGlzLl9fYWRkTGlzdGVuZXIoY29uZmlnLmxpc3RlbmVyKTtcbiAgICB9XG4gICAgdGhpcy5fY2FsbExpc3RlbmVycyA9IHRoaXMuX2NhbGxMaXN0ZW5lcnMuYmluZCh0aGlzKTtcbiAgICB0aGlzLl9hdHRhY2hlZEV2ZW50ID0gbnVsbDtcbiAgICB0aGlzLl9faXNOYXRpdmUgPSBzaG91bGRVc2VOYXRpdmVEcml2ZXIoY29uZmlnKTtcbiAgfVxuXG4gIF9fYWRkTGlzdGVuZXIoY2FsbGJhY2s6IEZ1bmN0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5fbGlzdGVuZXJzLnB1c2goY2FsbGJhY2spO1xuICB9XG5cbiAgX19yZW1vdmVMaXN0ZW5lcihjYWxsYmFjazogRnVuY3Rpb24pOiB2b2lkIHtcbiAgICB0aGlzLl9saXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnMuZmlsdGVyKGxpc3RlbmVyID0+IGxpc3RlbmVyICE9PSBjYWxsYmFjayk7XG4gIH1cblxuICBfX2F0dGFjaCh2aWV3UmVmOiBhbnksIGV2ZW50TmFtZTogc3RyaW5nKSB7XG4gICAgaW52YXJpYW50KFxuICAgICAgdGhpcy5fX2lzTmF0aXZlLFxuICAgICAgJ09ubHkgbmF0aXZlIGRyaXZlbiBldmVudHMgbmVlZCB0byBiZSBhdHRhY2hlZC4nLFxuICAgICk7XG5cbiAgICB0aGlzLl9hdHRhY2hlZEV2ZW50ID0gYXR0YWNoTmF0aXZlRXZlbnQoXG4gICAgICB2aWV3UmVmLFxuICAgICAgZXZlbnROYW1lLFxuICAgICAgdGhpcy5fYXJnTWFwcGluZyxcbiAgICApO1xuICB9XG5cbiAgX19kZXRhY2godmlld1RhZzogYW55LCBldmVudE5hbWU6IHN0cmluZykge1xuICAgIGludmFyaWFudChcbiAgICAgIHRoaXMuX19pc05hdGl2ZSxcbiAgICAgICdPbmx5IG5hdGl2ZSBkcml2ZW4gZXZlbnRzIG5lZWQgdG8gYmUgZGV0YWNoZWQuJyxcbiAgICApO1xuXG4gICAgdGhpcy5fYXR0YWNoZWRFdmVudCAmJiB0aGlzLl9hdHRhY2hlZEV2ZW50LmRldGFjaCgpO1xuICB9XG5cbiAgX19nZXRIYW5kbGVyKCk6IGFueSB8ICgoLi4uYXJnczogYW55KSA9PiB2b2lkKSB7XG4gICAgaWYgKHRoaXMuX19pc05hdGl2ZSkge1xuICAgICAgaWYgKF9fREVWX18pIHtcbiAgICAgICAgbGV0IHZhbGlkYXRlZE1hcHBpbmcgPSBmYWxzZTtcbiAgICAgICAgcmV0dXJuICguLi5hcmdzOiBhbnkpID0+IHtcbiAgICAgICAgICBpZiAoIXZhbGlkYXRlZE1hcHBpbmcpIHtcbiAgICAgICAgICAgIHZhbGlkYXRlTWFwcGluZyh0aGlzLl9hcmdNYXBwaW5nLCBhcmdzKTtcbiAgICAgICAgICAgIHZhbGlkYXRlZE1hcHBpbmcgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLl9jYWxsTGlzdGVuZXJzKC4uLmFyZ3MpO1xuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NhbGxMaXN0ZW5lcnM7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IHZhbGlkYXRlZE1hcHBpbmcgPSBmYWxzZTtcbiAgICByZXR1cm4gKC4uLmFyZ3M6IGFueSkgPT4ge1xuICAgICAgaWYgKF9fREVWX18gJiYgIXZhbGlkYXRlZE1hcHBpbmcpIHtcbiAgICAgICAgdmFsaWRhdGVNYXBwaW5nKHRoaXMuX2FyZ01hcHBpbmcsIGFyZ3MpO1xuICAgICAgICB2YWxpZGF0ZWRNYXBwaW5nID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdHJhdmVyc2UgPSAocmVjTWFwcGluZywgcmVjRXZ0KSA9PiB7XG4gICAgICAgIGlmIChyZWNNYXBwaW5nIGluc3RhbmNlb2YgQW5pbWF0ZWRWYWx1ZSkge1xuICAgICAgICAgIGlmICh0eXBlb2YgcmVjRXZ0ID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgcmVjTWFwcGluZy5zZXRWYWx1ZShyZWNFdnQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChyZWNNYXBwaW5nIGluc3RhbmNlb2YgQW5pbWF0ZWRWYWx1ZVhZKSB7XG4gICAgICAgICAgaWYgKHR5cGVvZiByZWNFdnQgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICB0cmF2ZXJzZShyZWNNYXBwaW5nLngsIHJlY0V2dC54KTtcbiAgICAgICAgICAgIHRyYXZlcnNlKHJlY01hcHBpbmcueSwgcmVjRXZ0LnkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVjTWFwcGluZyA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICBmb3IgKGNvbnN0IG1hcHBpbmdLZXkgaW4gcmVjTWFwcGluZykge1xuICAgICAgICAgICAgLyogJEZsb3dGaXhNZVtwcm9wLW1pc3NpbmddICg+PTAuMTIwLjApIFRoaXMgY29tbWVudCBzdXBwcmVzc2VzIGFuXG4gICAgICAgICAgICAgKiBlcnJvciBmb3VuZCB3aGVuIEZsb3cgdjAuMTIwIHdhcyBkZXBsb3llZC4gVG8gc2VlIHRoZSBlcnJvcixcbiAgICAgICAgICAgICAqIGRlbGV0ZSB0aGlzIGNvbW1lbnQgYW5kIHJ1biBGbG93LiAqL1xuICAgICAgICAgICAgdHJhdmVyc2UocmVjTWFwcGluZ1ttYXBwaW5nS2V5XSwgcmVjRXZ0W21hcHBpbmdLZXldKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB0aGlzLl9hcmdNYXBwaW5nLmZvckVhY2goKG1hcHBpbmcsIGlkeCkgPT4ge1xuICAgICAgICB0cmF2ZXJzZShtYXBwaW5nLCBhcmdzW2lkeF0pO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuX2NhbGxMaXN0ZW5lcnMoLi4uYXJncyk7XG4gICAgfTtcbiAgfVxuXG4gIF9jYWxsTGlzdGVuZXJzKC4uLmFyZ3M6IGFueSkge1xuICAgIHRoaXMuX2xpc3RlbmVycy5mb3JFYWNoKGxpc3RlbmVyID0+IGxpc3RlbmVyKC4uLmFyZ3MpKTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtBbmltYXRlZEV2ZW50LCBhdHRhY2hOYXRpdmVFdmVudH07XG4iXX0=